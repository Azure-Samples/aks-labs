<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-operating-aks-automatic/workshop" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Streamline operations and developer onboarding with AKS Automatic | AKS LABS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://azure-samples.github.io/aks-labs/img/aks-labs-social-card.png"><meta data-rh="true" name="twitter:image" content="https://azure-samples.github.io/aks-labs/img/aks-labs-social-card.png"><meta data-rh="true" property="og:url" content="https://azure-samples.github.io/aks-labs/docs/operating-aks-automatic/workshop"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Streamline operations and developer onboarding with AKS Automatic | AKS LABS"><meta data-rh="true" name="description" content="Are you looking for ways to automate many administrative tasks in Kubernetes and make it easier for development teams to deploy their apps while maintaining security and compliance? Azure Kubernetes Service (AKS) Automatic is a new mode of operation for AKS that simplifies cluster management, reduces manual tasks, and builds in enterprise-grade best practices and policy enforcement. This session is perfect for platform operators and DevOps engineers looking to get started with AKS Automatic."><meta data-rh="true" property="og:description" content="Are you looking for ways to automate many administrative tasks in Kubernetes and make it easier for development teams to deploy their apps while maintaining security and compliance? Azure Kubernetes Service (AKS) Automatic is a new mode of operation for AKS that simplifies cluster management, reduces manual tasks, and builds in enterprise-grade best practices and policy enforcement. This session is perfect for platform operators and DevOps engineers looking to get started with AKS Automatic."><link data-rh="true" rel="icon" href="/aks-labs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://azure-samples.github.io/aks-labs/docs/operating-aks-automatic/workshop"><link data-rh="true" rel="alternate" href="https://azure-samples.github.io/aks-labs/docs/operating-aks-automatic/workshop" hreflang="en"><link data-rh="true" rel="alternate" href="https://azure-samples.github.io/aks-labs/docs/operating-aks-automatic/workshop" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/aks-labs/blog/rss.xml" title="AKS LABS RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/aks-labs/blog/atom.xml" title="AKS LABS Atom Feed"><link rel="stylesheet" href="/aks-labs/assets/css/styles.56ddccda.css">
<script src="/aks-labs/assets/js/runtime~main.f1d0a99d.js" defer="defer"></script>
<script src="/aks-labs/assets/js/main.2f149359.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/aks-labs/img/aks-logo-icon.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/aks-labs/"><div class="navbar__logo"><img src="/aks-labs/img/aks-logo-icon.svg" alt="AKS Labs Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/aks-labs/img/aks-logo-icon.svg" alt="AKS Labs Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">AKS LABS</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/aks-labs/docs/intro">Workshops</a><a class="navbar__item navbar__link" href="/aks-labs/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/russd2357/aks-labs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/aks-labs/docs/intro">Workshop Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/getting-started-with-k8s-on-aks">Getting Started with K8s on AKS</a><button aria-label="Expand sidebar category &#x27;Getting Started with K8s on AKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/aks-automatic">AKS Automatic</a><button aria-label="Expand sidebar category &#x27;AKS Automatic&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/aks-labs/docs/category/operating-aks-automatic">Operating AKS Automatic</a><button aria-label="Collapse sidebar category &#x27;Operating AKS Automatic&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/aks-labs/docs/operating-aks-automatic/workshop">Streamline operations and developer onboarding with AKS Automatic</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/advanced-aks">Advanced AKS</a><button aria-label="Expand sidebar category &#x27;Advanced AKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/ai-on-aks">AI on AKS</a><button aria-label="Expand sidebar category &#x27;AI on AKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/tutorial---basics">Tutorial - Basics</a><button aria-label="Expand sidebar category &#x27;Tutorial - Basics&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/tutorial---extras">Tutorial - Extras</a><button aria-label="Expand sidebar category &#x27;Tutorial - Extras&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/aks-labs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/aks-labs/docs/category/operating-aks-automatic"><span itemprop="name">Operating AKS Automatic</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Streamline operations and developer onboarding with AKS Automatic</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Streamline operations and developer onboarding with AKS Automatic</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>AKS Automatic is a new mode of operation for Azure Kubernetes Service (AKS) that simplifies cluster management, reduces manual tasks, and builds in enterprise-grade best practices and policy enforcement. This lab is meant to be a hands-on experience for Azure administrators and DevOps engineers looking to get started with AKS Automatic. You will learn how to automate many administrative tasks in Kubernetes and make it easier for development teams to deploy their apps while maintaining security and compliance.</p>
<p>Many of the features you will be working with in this workshop are in preview and may not be recommended for production workloads. However, the AKS engineering team is working hard to bring these features to general availability and will be great learning opportunities for you to understand options to support developers and streamline operations. This is not platform engineering, but it is a step in the right direction to automate many of the tasks that platform engineers do today. If you would like to learn more about platform engineering with AKS, please check out this <a href="https://github.com/azure-samples/aks-platform-engineering" target="_blank" rel="noopener noreferrer">repo</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="objectives">Objectives<a href="#objectives" class="hash-link" aria-label="Direct link to Objectives" title="Direct link to Objectives">​</a></h3>
<p>By the end of this lab you will be able to:</p>
<ul>
<li>Manage user access to the AKS cluster</li>
<li>Understand AKS Deployment Safeguards and how to enforce custom policies</li>
<li>Sync configurations to the cluster with Azure App Configuration Provider for Kubernetes</li>
<li>Leverage AKS Service Connector for passwordless integration with Azure services</li>
<li>Scale workloads across nodes with AKS Node Autoprovision</li>
<li>Understand workload scheduling best practices</li>
<li>Troubleshoot workload failures with monitoring tools and Microsoft Copilot for Azure</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h3>
<p>The lab environment has been pre-configured for you with the following Azure resources in the resource group named <strong>myresourcegroup</strong>:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/aks/intro-aks-automatic" target="_blank" rel="noopener noreferrer">AKS Automatic</a> cluster with monitoring enabled</li>
<li><a href="https://learn.microsoft.com/azure/container-registry/container-registry-intro" target="_blank" rel="noopener noreferrer">Azure Container Registry</a></li>
<li><a href="https://learn.microsoft.com/azure/azure-monitor/logs/log-analytics-workspace-overview" target="_blank" rel="noopener noreferrer">Azure Log Analytics Workspace</a></li>
<li><a href="https://learn.microsoft.com/azure/azure-monitor/essentials/prometheus-metrics-overview" target="_blank" rel="noopener noreferrer">Azure Managed Prometheus</a></li>
<li><a href="https://learn.microsoft.com/azure/managed-grafana/overview" target="_blank" rel="noopener noreferrer">Azure Managed Grafana</a></li>
</ul>
<blockquote>
<p>[!NOTE]
The Bicep template used to deploy the lab environment can be found <a href="https://raw.githubusercontent.com/azure-samples/aks-labs/refs/heads/ignite/workshops/operating-aks-automatic/assets/setup/bicep/aks.bicep" target="_blank" rel="noopener noreferrer">here</a>. Just note that if you deploy this template, you will need to assign yourself the &quot;Azure Kubernetes Service RBAC Cluster Admin&quot; role to the AKS cluster and the &quot;Grafana Admin&quot; role to the Azure Managed Grafana resources.</p>
</blockquote>
<p>You will also need the following tools:</p>
<ul>
<li><a href="https://code.visualstudio.com/" target="_blank" rel="noopener noreferrer">Visual Studio Code</a></li>
<li><a href="https://docs.microsoft.com/cli/azure/install-azure-cli" target="_blank" rel="noopener noreferrer">Azure CLI</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_blank" rel="noopener noreferrer">kubectl</a></li>
<li><a href="https://learn.microsoft.com/azure/aks/kubelogin-authentication" target="_blank" rel="noopener noreferrer">kubelogin</a></li>
<li><a href="https://helm.sh/docs/intro/install/" target="_blank" rel="noopener noreferrer">Helm</a></li>
</ul>
<blockquote>
<p>[!ALERT]
All command-line instructions in this lab should be executed in a Bash shell. If you are using Windows, you can use the Windows Subsystem for Linux (WSL) or Azure Cloud Shell.</p>
</blockquote>
<p>Before you get started, open a Bash shell and log in to your Azure subscription with the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az login --use-device-code</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You will be prompted to open a browser and log in with your Azure credentials. Copy the code that is displayed and paste it in the browser to authenticate.</p>
<p>You will also need to install the <strong>aks-preview</strong> and <strong>k8s-extension</strong> extensions to leverage preview features in AKS and install AKS extensions. Run the following commands to install the extensions.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az extension add --name aks-preview</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az extension add --name k8s-extension</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Finally set the default location for resources that you will create in this lab using Azure CLI.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az configure --defaults location=$(az group show -n myresourcegroup --query location -o tsv)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You are now ready to get started with the lab!</p>
<p>===</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="security-and-governance">Security and governance<a href="#security-and-governance" class="hash-link" aria-label="Direct link to Security and governance" title="Direct link to Security and governance">​</a></h2>
<p>Being able to manage user access to the AKS cluster and enforce policies is critical to maintaining a secure and compliant environment. In this section, you will learn how to grant permissions to the AKS cluster, enforce policies with AKS Deployment Safeguards, and enforce custom policies with Azure Policy.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="granting-permissions-to-the-aks-cluster">Granting permissions to the AKS cluster<a href="#granting-permissions-to-the-aks-cluster" class="hash-link" aria-label="Direct link to Granting permissions to the AKS cluster" title="Direct link to Granting permissions to the AKS cluster">​</a></h3>
<p>With <a href="https://learn.microsoft.com/azure/aks/manage-azure-rbac?tabs=azure-cli" target="_blank" rel="noopener noreferrer">Azure RBAC for Kubernetes authorization</a> enabled on the AKS Automatic cluster, granting users access to the cluster is as simple as assigning roles to users, groups, and/or service principals. Users will run the normal <strong>az aks get-credentials</strong> command to download the <a href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/" target="_blank" rel="noopener noreferrer">kubeconfig file</a>, but when users attempt to execute commands against the Kubernetes API Server, they will be instructed to log in with their Microsoft Entra ID credentials and their assigned roles will determine what they can do within the cluster.</p>
<p>To grant permissions to the AKS cluster, you will need to assign an Azure role to a user. The following built-in roles are available for user assignment.</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/role-based-access-control/built-in-roles/containers#azure-kubernetes-service-rbac-admin" target="_blank" rel="noopener noreferrer">Azure Kubernetes Service RBAC Admin</a></li>
<li><a href="https://learn.microsoft.com/azure/role-based-access-control/built-in-roles/containers#azure-kubernetes-service-rbac-cluster-admin" target="_blank" rel="noopener noreferrer">Azure Kubernetes Service RBAC Cluster Admin</a></li>
<li><a href="https://learn.microsoft.com/azure/role-based-access-control/built-in-roles/containers#azure-kubernetes-service-rbac-reader" target="_blank" rel="noopener noreferrer">Azure Kubernetes Service RBAC Reader</a></li>
<li><a href="https://learn.microsoft.com/azure/role-based-access-control/built-in-roles/containers#azure-kubernetes-service-rbac-writer" target="_blank" rel="noopener noreferrer">Azure Kubernetes Service RBAC Writer</a></li>
</ul>
<p>In your shell, run the following command to get the AKS cluster credentials.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks get-credentials \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group myresourcegroup \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name myakscluster</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A Kubernetes <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/" target="_blank" rel="noopener noreferrer">namespace</a> is often used to isolate resources in a cluster and is common practice to create namespaces for different teams or environments. Run the following command to create a namespace for the dev team to use.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create namespace dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Since this is the first time you are running a <a href="https://kubernetes.io/docs/reference/kubectl/" target="_blank" rel="noopener noreferrer">kubectl</a> command, you will be prompted to log in against Microsoft Entra ID.</p>
<p>Follow the same login process you went through to login into your Azure subscription. After you&#x27;ve successfully logged in, the command to create the namespace should be successful.</p>
<blockquote>
<p>[!HELP]
If you run into an error when trying to log in, you may need to install the <a href="https://github.com/Azure/kubelogin" target="_blank" rel="noopener noreferrer">kubelogin</a> plugin which is used to authenticate with Microsoft Entra ID. It can be easily installed with the following command: <strong>az aks install-cli</strong>.</p>
</blockquote>
<p>Run the following command to get the AKS cluster&#x27;s resource ID.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AKS_ID=$(az aks show \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group myresourcegroup \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name myakscluster \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query id \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output tsv)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to get a developer&#x27;s user principal ID.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DEV_USER_PRINCIPAL_ID=$(az ad user show \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--id &lt;dev_user_principal_name&gt; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query id \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output tsv)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>[!NOTE]
Be sure to replace <strong>dev_user_principal_name</strong> with the actual user principal name of the developer.</p>
</blockquote>
<p>Run the following command to assign the <strong>Azure Kubernetes Service RBAC Writer</strong> role to the developer and have the permissions scoped only to the <strong>dev</strong> namespace. This ensures that the developer can only access the resources within the namespace and not the entire cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az role assignment create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--role &quot;Azure Kubernetes Service RBAC Writer&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--assignee $DEV_USER_PRINCIPAL_ID \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--scope $AKS_ID/namespaces/dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When you logged in to access the Kubernetes API via the kubectl command, you were prompted to log in with your Microsoft Entra ID. The kubelogin plugin stores the OIDC token in the <strong>~/.kube/cache/kubelogin</strong> directory. In order to quickly test the permissions of a different user, we can simply move the JSON file to a different directory.</p>
<p>Run the following command to temporarily move the cached credentials to its parent directory.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mv ~/.kube/cache/kubelogin/*.json ~/.kube/cache/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, run the following command to get the dev namespace.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get namespace dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Since there is no cached token in the kubelogin directory, this will trigger a new authentication prompt. Proceed to log in with the developer&#x27;s user account. So when you log in, be sure to click the <strong>Use another account</strong> button and enter a developer&#x27;s user credentials.</p>
<p>After logging in, head back to your terminal. You should see details of the <strong>dev</strong> namespace. This means that the dev user has the necessary permissions to access the <strong>dev</strong> namespace.</p>
<p>Run the following command to check to see if the dev user can create a pod in the <strong>dev</strong> namespace.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl auth can-i create pods --namespace dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see the output <strong>yes</strong>. This means the dev user has the necessary permissions to create pods in the <strong>dev</strong> namespace.</p>
<p>Let&#x27;s put this to the test and deploy a sample application in the assigned namespace using Helm.</p>
<p>Run the following command to add the Helm repository for the AKS Store Demo application.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add aks-store-demo https://azure-samples.github.io/aks-store-demo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to install the <a href="https://github.com/azure-samples/aks-store-demo" target="_blank" rel="noopener noreferrer">AKS Store Demo</a> application in the <strong>dev</strong> namespace.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm install demo aks-store-demo/aks-store-demo-chart \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--namespace dev \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--set aiService.create=true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The helm install command should show a status of &quot;deployed&quot;. This means that the application has successfully deployed in the <strong>dev</strong> namespace. It will take a few minutes to deploy, so let&#x27;s move on.</p>
<p>Finally, check to see if the developer can create a pod outside of the dev namespace. Run the following command to test against the <strong>default</strong> namespace.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl auth can-i create pods --namespace default</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see the output <strong>no - User does not have access to the resource in Azure. Update role assignment to allow access</strong>.</p>
<p>This is exactly what we want to see. If you need to grant the user access to another namespace, you can simply assign the role to the user with the appropriate scope. Or if you need to grand a user access to the entire cluster, you can assign the role to the user with the scope of the AKS cluster and omit the namespace altogether.</p>
<p>Great job! You now know how to manage user access to the AKS cluster and how to scope permissions to specific namespaces.</p>
<blockquote>
<p>[!ALERT]
After testing the permissions, delete the developer user&#x27;s cached credentials, then move the admin user&#x27;s cached credentials back to the <strong>~/.kube/cache/kubelogin</strong> directory by running the following commands.</p>
</blockquote>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rm ~/.kube/cache/kubelogin/*.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv ~/.kube/cache/*.json ~/.kube/cache/kubelogin/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deployment-safeguards">Deployment Safeguards<a href="#deployment-safeguards" class="hash-link" aria-label="Direct link to Deployment Safeguards" title="Direct link to Deployment Safeguards">​</a></h3>
<p>Before you unleash developers to deploy applications in the AKS cluster, you likely want to ensure that they are following best practices. <a href="https://learn.microsoft.com/azure/aks/deployment-safeguards" target="_blank" rel="noopener noreferrer">Deployment Safeguards</a> is a feature that helps enforce best practices and policies for your AKS clusters. It is implemented as an AKS add-on using <a href="https://learn.microsoft.com/azure/governance/policy/overview" target="_blank" rel="noopener noreferrer">Azure Policy</a> and enabled by default on AKS Automatic clusters. Deployment Safeguards is basically a group of policies known as an <a href="https://learn.microsoft.com/azure/governance/policy/concepts/initiative-definition-structure" target="_blank" rel="noopener noreferrer">initiative</a> which is assigned to your cluster to ensure resources running within it are secure, compliant, and follows best practices. The compliance state of the cluster resources are reported back to Azure Policy and can be viewed in the Azure Portal.</p>
<p>The group of policies that are included with Deployment Safeguards are documented <a href="https://learn.microsoft.com/azure/aks/deployment-safeguards#deployment-safeguards-policies" target="_blank" rel="noopener noreferrer">here</a>. Read carefully through each policy description, the targeted resource, and the mutation that can be applied when the assignment is set to <strong>Enforcement</strong> mode. AKS Automatic defaults to <strong>Warning</strong> mode which simply displays warnings in the terminal as a gentle reminder to implement best practices. You may have seen Deployment Safeguards at work when you deployed the demo application using Helm. When Deployment Safeguards is in Enforcement mode, polices will be strongly enforced by either mutating deployments to comply with the policies or denying deployments that violate policy. Therefore, it is important to understand the impact of each policy before enabling Enforcement mode.</p>
<p>Run the following command to deploy a pod without any best practices in place.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl run mynginx --image=nginx:latest</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see the following warning messages in the output.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Warning: [azurepolicy-k8sazurev2containerenforceprob-e00c7e64611b1137ed2b] Container &lt;nginx&gt; in your Pod &lt;nginx&gt; has no &lt;livenessProbe&gt;. Required probes: [&quot;readinessProbe&quot;, &quot;livenessProbe&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: [azurepolicy-k8sazurev2containerenforceprob-e00c7e64611b1137ed2b] Container &lt;nginx&gt; in your Pod &lt;nginx&gt; has no &lt;readinessProbe&gt;. Required probes: [&quot;readinessProbe&quot;, &quot;livenessProbe&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: [azurepolicy-k8sazurev3containerlimits-4e7bbc2617e5447639a7] container &lt;nginx&gt; has no resource limits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: [azurepolicy-k8sazurev1containerrestrictedi-88f886218244b623dd93] nginx in default does not have imagePullSecrets. Unauthenticated image pulls are not recommended.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/nginx created</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>These warnings are here to help remind you of the best practices that should be followed when deploying pods in the AKS cluster. There are warnings about not having a <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-a-liveness-http-request" target="_blank" rel="noopener noreferrer">livenessProbe</a>, <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-readiness-probes" target="_blank" rel="noopener noreferrer">readinessProbe</a>, <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits" target="_blank" rel="noopener noreferrer">resource limits</a>, and <a href="https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/#create-a-pod-that-uses-your-secret" target="_blank" rel="noopener noreferrer">imagePullSecrets</a>.</p>
<p>So let&#x27;s try this again with some best practices in place. Run the following command to delete the pod that was just created.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete pod mynginx --wait=false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to redeploy the pod with some best practices in place.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run: mynginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: mynginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - image: nginx:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: mynginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      limits:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cpu: 5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memory: 4Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cpu: 3m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memory: 2Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    livenessProbe:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tcpSocket:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      initialDelaySeconds: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      periodSeconds: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    readinessProbe:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tcpSocket:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      initialDelaySeconds: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      periodSeconds: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This pod manifest is a bit more complex this time but it includes the following best practices that includes resource limits and requests as well as liveness and readiness probes.</p>
<blockquote>
<p>[!HINT]
You should now see that we&#x27;ve satisfied all but one best practice, which we&#x27;ll address later.</p>
</blockquote>
<p>You can also view the compliance state of the cluster resources in the Azure Portal.</p>
<p>Head over to the Azure portal. In the search bar, type <code>policy</code> and click on <strong>Policy</strong> under <strong>Services</strong>.</p>
<p>In the <strong>Overview</strong> section, you will see the <strong>AKS Deployment Safeguards Policy Assignment</strong> in the middle of the page.</p>
<p>Click on the policy assignment to view the compliance state of the cluster resources. You should see some of the policy warnings that were displayed in the terminal output when you deployed the pod without best practices in place.</p>
<p>Nice! Now you know where to expect to see warnings both in the terminal and in the Azure and how to address some of these warnings by following best practices.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="custom-policy-enforcement">Custom policy enforcement<a href="#custom-policy-enforcement" class="hash-link" aria-label="Direct link to Custom policy enforcement" title="Direct link to Custom policy enforcement">​</a></h3>
<p>As mentioned in the previous section, the <a href="https://learn.microsoft.com/azure/aks/use-azure-policy" target="_blank" rel="noopener noreferrer">Azure Policy add-on for AKS</a> has been enabled when AKS Automatic is provisioned. This means you have everything you need leverage additional Azure Policy definitions (built-in or custom) to enforce organizational standards. When the Azure Policy for AKS feature is enabled, <a href="https://kubernetes.io/blog/2019/08/06/opa-gatekeeper-policy-and-governance-for-kubernetes/" target="_blank" rel="noopener noreferrer">Open Policy Agent (OPA) Gatekeeper</a> is deployed in the AKS cluster. <a href="https://open-policy-agent.github.io/gatekeeper" target="_blank" rel="noopener noreferrer">Gatekeeper</a> is a policy engine for Kubernetes that allows you to enforce policies written using <a href="https://www.openpolicyagent.org/docs/latest/policy-language/" target="_blank" rel="noopener noreferrer">Rego</a>, a high-level declarative language. As Azure policies are assigned to the AKS cluster, they are translated to Gatekeeper <a href="https://open-policy-agent.github.io/gatekeeper/website/docs/constrainttemplates/" target="_blank" rel="noopener noreferrer">ConstraintTemplates</a> and enforced in the cluster.</p>
<p>The Gatekeeper pods are running in the <strong>gatekeeper-system</strong> namespace. Run the following command to view the pods.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -n gatekeeper-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can also view the ConstraintTemplates that are available in the cluster. Run the following command to view the ConstraintTemplates which have been deployed via the Azure Policy add-on for AKS.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get constrainttemplates</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Although Gatekeepr is running in the cluster, it is worth noting that this Gatekeeper cannot be used outside of Azure Policy. That is, if you want to implement a well-known or commonly used ConstraintTemplates, you&#x27;ll need to translate it to an Azure Policy definition and assign it to the AKS cluster. From there <strong>azure-policy-*</strong> pods running in the <strong>kube-system</strong> namespace listens for Azure Policy assignments, translates them to ConstraintTemplates, deploys the custom Constraints (cluster policy), and reports the cluster policy results back up to Azure Policy.</p>
<p>Let&#x27;s illustrate this by attempting to deploy a commonly used ConstraintTemplate that limits container images to only those from approved container registries. Run the following command to attempt to deploy the ConstraintTemplate.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/azure-samples/aks-labs/refs/heads/ignite/workshops/operating-aks-automatic/assets/files/constrainttemplate.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the output you should see <strong>This cluster is governed by Azure Policy. Policies must be created through Azure.</strong></p>
<p>So we need to translate this ConstraintTemplate to an Azure Policy definition and if you are unsure about how to translate ConstraintTemplates to Azure Policy JSON, the <a href="https://marketplace.visualstudio.com/items?itemName=AzurePolicy.azurepolicyextension" target="_blank" rel="noopener noreferrer">Azure Policy extension for Visual Studio Code</a> is available to help.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-custom-policy-definition-from-a-constrainttemplate">Create a custom policy definition from a ConstraintTemplate<a href="#create-a-custom-policy-definition-from-a-constrainttemplate" class="hash-link" aria-label="Direct link to Create a custom policy definition from a ConstraintTemplate" title="Direct link to Create a custom policy definition from a ConstraintTemplate">​</a></h4>
<p>Using the Azure Policy extension for Visual Studio Code, you can easily create a custom policy definition from a ConstraintTemplate.</p>
<ul>
<li>Open VS Code and make sure the Azure Policy extension is installed. If not, you can install it from the <a href="https://marketplace.visualstudio.com/items?itemName=AzurePolicy.azurepolicyextension" target="_blank" rel="noopener noreferrer">VS Code Marketplace</a></li>
<li>To activate the extension, press <strong>Ctrl+Shift+P</strong> on your keyboard to open the command palette and type <strong>Azure: Sign in</strong> then use the web browser to authenticate with your admin user account</li>
</ul>
<blockquote>
<p>[!HINT]
If you see multiple sign-in options, choose the one that has <strong>azure-account.login</strong> next to it.</p>
</blockquote>
<ul>
<li>Press <strong>Ctrl+Shift+P</strong> again and type <strong>Azure: Select Subscriptions</strong> then select the subscription that contains the AKS cluster</li>
</ul>
<blockquote>
<p>[!HINT]
If you see multiple subscriptions, choose the one that has <strong>azure-account.selectSubscriptions</strong> next to it.</p>
</blockquote>
<ul>
<li>In VS Code sidebar, click the <strong>Azure Policy</strong> icon and you should see the subscription resources and policies panes being loaded</li>
<li>Open the VS Code terminal and run the following command download the sample ConstraintTemplate file to your local machine</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -o constrainttemplate.yaml https://raw.githubusercontent.com/azure-samples/aks-labs/refs/heads/ignite/workshops/operating-aks-automatic/assets/files/constrainttemplate.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Open the constrainttemplate.yaml file in VS Code and take a look at the contents</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">code constrainttemplate.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>[!KNOWLEDGE]
The constraint template includes Rego code on line 17 that enforces that all containers in the AKS cluster are sourced from approved container registries. The approved container registries can are defined in the <strong>registry</strong> parameter and this is where you can specify the container registry URL when implementing the ConstraintTemplate.</p>
</blockquote>
<ul>
<li>To convert this template to Azure Policy JSON, press <strong>Ctrl+Shift+P</strong> then type <strong>Azure Policy for Kubernetes: Create Policy Definition from a Constraint Template</strong></li>
<li>Select the <strong>Base64Encoded</strong> option</li>
</ul>
<blockquote>
<p>[!HELP]
The extension activation process can take a few minutes to complete. If you cannot get the extension to generate JSON from the ConstraintTemplate, that&#x27;s okay, skip to the <a href="#deploy-a-custom-policy-definition">Deploy a custom policy definition</a> section below where you will use a sample Azure Policy JSON file.</p>
</blockquote>
<ul>
<li>This will generate a new Azure Policy definition in the JSON format and encode the ConstraintTemplate in Base64 format</li>
</ul>
<blockquote>
<p>[!HINT]
The template info can also refer to a URL where the ConstraintTemplate is hosted. This is useful when you want to reference a ConstraintTemplate that is hosted in a public repository.</p>
</blockquote>
<ul>
<li>Fill in details where you see the text <strong>/_ EDIT HERE _/</strong>
<ul>
<li>For <strong>displayName</strong> field use the value <code>Approved registries only</code></li>
<li>For <strong>description</strong> field use the value <code>This policy requires that all containers in an AKS cluster are sourced from approved container registries.</code></li>
<li>For <strong>apiGroups</strong> field use the value <code>[&quot;&quot;]</code> to target all API groups</li>
<li>For the <strong>kind</strong> field use the value <code>[&quot;Pod&quot;]</code> to target pods</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-a-custom-policy-definition">Deploy a custom policy definition<a href="#deploy-a-custom-policy-definition" class="hash-link" aria-label="Direct link to Deploy a custom policy definition" title="Direct link to Deploy a custom policy definition">​</a></h4>
<p>With the custom policy rule written, you can now deploy it to Azure.</p>
<ul>
<li>Open a terminal and run the following command to download the sample Azure Policy JSON file to your local machine</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -o constrainttemplate-as-policy.json https://raw.githubusercontent.com/Azure-Samples/aks-labs/refs/heads/ignite/workshops/operating-aks-automatic/assets/files/constrainttemplate-as-policy.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Open <strong>constrainttemplate-as-policy.json</strong> file and copy the JSON to the clipboard</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">code constrainttemplate-as-policy.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Navigate back to the <a href="https://portal.azure.com/#view/Microsoft_Azure_Policy/PolicyMenuBlade/~/Overview" target="_blank" rel="noopener noreferrer">Azure Policy blade</a> in the Azure Portal</li>
<li>Click on <strong>Definitions</strong> under the <strong>Authoring</strong> section</li>
<li>Click on <strong>+ Policy definition</strong> then enter the following details:<!-- -->
<ul>
<li><strong>Definition location</strong>: Click the button next to the textbox, then select your subscription in the dropdown and click the <strong>Select</strong> button at the bottom</li>
<li><strong>Name</strong>: <code>[AKS] Approved registries only</code></li>
<li><strong>Description</strong>: <code>This policy requires that all containers in an AKS cluster are sourced from approved container registries.</code></li>
<li><strong>Category</strong>: Click the <strong>Use existing</strong> radio button then select <strong>Kubernetes</strong> from the dropdown</li>
<li><strong>Policy rule</strong>: Clear the existing content and paste the JSON you copied from the <strong>constrainttemplate-as-policy.json</strong> file</li>
</ul>
</li>
<li>Click <strong>Save</strong> at the bottom of the page</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="assign-a-custom-policy-to-the-aks-cluster">Assign a custom policy to the AKS cluster<a href="#assign-a-custom-policy-to-the-aks-cluster" class="hash-link" aria-label="Direct link to Assign a custom policy to the AKS cluster" title="Direct link to Assign a custom policy to the AKS cluster">​</a></h4>
<p>With the custom policy definition created, you can now assign it to the AKS cluster.</p>
<ul>
<li>Click the <strong>Assign policy</strong> button</li>
<li>In the <strong>Basics</strong> tab, enter the following details:<!-- -->
<ul>
<li><strong>Scope</strong>: Click the button next to the textbox, select the <strong>myresourcegroup</strong> which contains the AKS cluster and click <strong>Select</strong> at the bottom</li>
</ul>
</li>
<li>Click <strong>Next</strong></li>
<li>In the <strong>Parameters</strong> tab, enter the following details:<!-- -->
<ul>
<li>Uncheck the <strong>Only show parameters that need input or review</strong> checkbox</li>
<li><strong>Effect</strong>: Select <strong>deny</strong> from the dropdown</li>
<li><strong>Namespace exclusions</strong>: Replace the existing content with <code>[&quot;kube-system&quot;,&quot;gatekeeper-system&quot;,&quot;azure-arc&quot;, &quot;kube-node-lease&quot;,&quot;kube-public&quot;,&quot;app-routing-system&quot;,&quot;azappconfig-system&quot;,&quot;sc-system&quot;,&quot;aks-command&quot;]</code></li>
<li><strong>Image registry</strong>: Enter your container registry URL as <code>&lt;your_acr_name&gt;.azurecr.io/</code></li>
</ul>
</li>
<li>Click <strong>Review + create</strong> to review the policy assignment</li>
<li>Click <strong>Create</strong> to assign the policy definition to the AKS cluster</li>
</ul>
<blockquote>
<p>[!ALERT]
This policy assignment uses <strong>Namespace exclusions</strong> to exclude system namespaces from the policy enforcement. This is important because you may deny the deployment of certain pods if the namespaces are not &quot;whitelisted&quot; in the policy assignment. The alternative here is to only apply the policy to a specific namespace by using the <strong>Namespace inclusions</strong> parameter instead and specifying the namespace you want to enforce the policy on.</p>
</blockquote>
<p>Awesome! You have successfully enforced custom policies in the AKS cluster. Once the policy assignment has taken effect, you can try deploying a pod with an image from an unapproved container registry to see the policy in action. However, this policy assignment can take up to 15 minutes to take effect, so let&#x27;s move on to the next section.</p>
<p>For more information on how to create a policy definition from a ConstraintTemplate or MutationTemplate, refer to the following documentation links:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/governance/policy/how-to/extension-for-vscode#create-policy-definition-from-a-constraint-template-or-mutation-template" target="_blank" rel="noopener noreferrer">Create policy definition from a constraint template or mutation template</a></li>
<li><a href="https://learn.microsoft.com/azure/governance/policy/concepts/policy-for-kubernetes" target="_blank" rel="noopener noreferrer">Understand Azure Policy for Kubernetes clusters</a></li>
<li><a href="https://github.com/open-policy-agent/gatekeeper-library/" target="_blank" rel="noopener noreferrer">OPA Gatekeeper Library</a></li>
</ul>
<p>===</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="secrets-and-config-management">Secrets and config management<a href="#secrets-and-config-management" class="hash-link" aria-label="Direct link to Secrets and config management" title="Direct link to Secrets and config management">​</a></h2>
<p>Azure service integration with developers requires access to configurations for their cluster workloads and leveraging password-less Microsoft Entra ID authentication wherever possible. This section guides you through centralizing configuration storage, syncing configs as Kubernetes ConfigMaps, and setting up connectors for workload integration with Azure services.</p>
<p><a href="https://learn.microsoft.com/azure/key-vault/general/overview" target="_blank" rel="noopener noreferrer">Azure Key Vault</a> is a cloud service for securely storing and accessing secrets. A secret is anything that you want to tightly control access to, such as API keys, passwords, or certificates. <a href="https://learn.microsoft.com/azure/azure-app-configuration/overview" target="_blank" rel="noopener noreferrer">Azure App Configuration</a> is a managed service that helps developers centralize their application configurations. It provides a service to store, manage, and retrieve application settings and feature flags. You can also reference secrets stored in Azure Key Vault from Azure App Configuration.</p>
<p>We can leverage these two services to store our application configurations and secrets and make them available to our workloads running in the AKS cluster using native Kubernetes resources; <a href="https://kubernetes.io/docs/concepts/configuration/configmap/" target="_blank" rel="noopener noreferrer">ConfigMaps</a> and <a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank" rel="noopener noreferrer">Secrets</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="provision-azure-resources">Provision Azure resources<a href="#provision-azure-resources" class="hash-link" aria-label="Direct link to Provision Azure resources" title="Direct link to Provision Azure resources">​</a></h3>
<p>In order to complete this section, you will need a few Azure resources, so use the Azure CLI to create the following resources.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-key-vault-setup">Azure Key Vault setup<a href="#azure-key-vault-setup" class="hash-link" aria-label="Direct link to Azure Key Vault setup" title="Direct link to Azure Key Vault setup">​</a></h4>
<p>Run the following command to create an Azure Key Vault.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">KV_NAME=$(az keyvault create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name mykeyvault$RANDOM \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group myresourcegroup \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query name \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output tsv)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Assign yourself the <strong>Key Vault Secrets Administrator</strong> role to the Azure Key Vault.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az role assignment create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--role &quot;Key Vault Administrator&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--assignee $(az ad signed-in-user show --query id -o tsv) \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--scope $(az keyvault show --name $KV_NAME --query id -o tsv)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to create a secret in the Azure Key Vault.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az keyvault secret set \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--vault-name $KV_NAME \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name MySecret1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--value MySecretValue1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-app-configuration-setup">Azure App Configuration setup<a href="#azure-app-configuration-setup" class="hash-link" aria-label="Direct link to Azure App Configuration setup" title="Direct link to Azure App Configuration setup">​</a></h4>
<p>Run the following command to create an Azure App Configuration store.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AC_NAME=$(az appconfig create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name myappconfig$RANDOM \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group myresourcegroup \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query name \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output tsv)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It&#x27;s best practice to create a User-Assigned Managed Identity to access Azure resources. This identity will be used to access only the data in the Azure App Configuration store and the Azure Key Vault and nothing else.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AC_ID=$(az identity create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name $AC_NAME-id \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group myresourcegroup \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query id \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output tsv)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Create simple key-value pair in the Azure App Configuration store.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az appconfig kv set \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name $AC_NAME \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--key MyKey1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--value MyValue1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--yes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now add a key vault reference to the Azure App Configuration store. This will point to the secret that was created in the Azure Key Vault in the previous step.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az appconfig kv set-keyvault \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name $AC_NAME \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--key MySecret1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--secret-identifier https://$KV_NAME.vault.azure.net/secrets/MySecret1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--yes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The Azure App Configuration store will have a reference to the secret in the Azure Key Vault and the intent is to use the user-assigned managed identity to access the secret in the key vault. However this identity does not have the necessary permissions yet.</p>
<p>Run the following command to allow the configuration store&#x27;s managed identity to read secrets from the key vault.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az role assignment create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--role &quot;Key Vault Secrets User&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--assignee $(az identity show --id $AC_ID --query principalId --output tsv) \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--scope $(az keyvault show --name $KV_NAME --query id --output tsv)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>[!HINT]
You might be wondering &quot;what about the role assignment for the Azure App Configuration store?&quot; We&#x27;ll get to that in the next section.</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="azure-app-configuration-provider-for-kubernetes">Azure App Configuration Provider for Kubernetes<a href="#azure-app-configuration-provider-for-kubernetes" class="hash-link" aria-label="Direct link to Azure App Configuration Provider for Kubernetes" title="Direct link to Azure App Configuration Provider for Kubernetes">​</a></h3>
<p>AKS offers an extension called the <a href="https://learn.microsoft.com/azure/aks/azure-app-configuration?tabs=cli" target="_blank" rel="noopener noreferrer">Azure App Configuration Provider for Kubernetes</a> that allows you to sync configurations from Azure App Configuration to Kubernetes ConfigMaps and/or Kubernetes Secrets. This extension is not installed by default in AKS Automatic clusters, but in this lab environment the extension has been pre-installed in the AKS Automatic cluster for you.</p>
<p>Run the following command to verify that the Azure app config provider pods are running.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -n azappconfig-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="passwordless-authentication-to-azure-services">Passwordless authentication to Azure services<a href="#passwordless-authentication-to-azure-services" class="hash-link" aria-label="Direct link to Passwordless authentication to Azure services" title="Direct link to Passwordless authentication to Azure services">​</a></h3>
<p>The Azure App Config Provider pods will reach out to the Azure App Configuration store to retrieve key value pairs and/or secrets. The best practice is to establish a passwordless connection between the AKS cluster and the Azure App Configuration store and you can achieve this by using <a href="https://learn.microsoft.com/azure/aks/workload-identity-deploy-cluster" target="_blank" rel="noopener noreferrer">AKS Workload Identity</a> and leveraging the <a href="https://learn.microsoft.com/azure/service-connector/how-to-use-service-connector-in-aks" target="_blank" rel="noopener noreferrer">AKS Service Connector</a>. The AKS Service Connector will take care of manual tasks like setting up the necessary Azure RBAC, creating a <a href="https://learn.microsoft.com/graph/api/resources/federatedidentitycredentials-overview?view=graph-rest-1.0" target="_blank" rel="noopener noreferrer">federated credential</a>, creating a Kubernetes <a href="https://kubernetes.io/docs/concepts/security/service-accounts/" target="_blank" rel="noopener noreferrer">ServiceAccount</a>, and creating any firewall rules needed to communicate with the Azure service..</p>
<p>Run the following command to create an AKS Service Connector to connect the AKS cluster to the Azure App Configuration store.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks connection create appconfig \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kube-namespace dev \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name myakscluster \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group myresourcegroup \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--target-resource-group myresourcegroup \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--app-config $AC_NAME \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--workload-identity $AC_ID</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>[!ALERT]
This can take up to 5 minutes to complete.</p>
</blockquote>
<p>This command will create a service connector to allow pods in the <strong>dev</strong> namespace to connect to the Azure App Configuration store using the User-Assigned Managed Identity that was created earlier. The service connector will grant the User-Assigned Managed Identity the necessary permissions to access the Azure App Configuration store and configure a federated credential on the managed identity that will allow the ServiceAccount assigned to the pod to authenticate via workload identity.</p>
<blockquote>
<p>[!HINT]
The AKS Service Connector is a powerful feature that allows you to connect your application pods to Azure services without having to manage any credentials. For more information, refer to the <a href="https://learn.microsoft.com/azure/service-connector/overview#what-services-are-supported-by-service-connector" target="_blank" rel="noopener noreferrer">service connector documentation</a>.</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="config-sync-to-kubernetes">Config sync to Kubernetes<a href="#config-sync-to-kubernetes" class="hash-link" aria-label="Direct link to Config sync to Kubernetes" title="Direct link to Config sync to Kubernetes">​</a></h3>
<p>The Azure App Configuration Provider for Kubernetes extension also installed new Kubernetes <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/" target="_blank" rel="noopener noreferrer">Custom Resource Definitions (CRDs)</a> which is used to sync configurations from the Azure App Configuration store to Kubernetes ConfigMaps and optionally Kubernetes Secrets.</p>
<p>Before you deploy the sync configuration manifest, you will need to collect the Azure App Configuration store&#x27;s endpoint and the Kubernetes ServiceAccount name.</p>
<p>Run the following command to get the Azure App Configuration store&#x27;s endpoint.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AC_ENDPOINT=$(az appconfig show \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name $AC_NAME \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query endpoint \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output tsv)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As mentioned above, we will use Workload Identity to connect to the Azure App Configuration store in a passwordless manner. Workload Identity is enabled by default in AKS Automatic clusters.</p>
<p>Run the following command to get the Kubernetes ServiceAccount name.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SA_NAME=$(kubectl get sa -n dev -o jsonpath=&#x27;{.items[?(@.metadata.name!=&quot;default&quot;)].metadata.name}&#x27;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Using the values you collected, create a sync configuration manifest.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -n dev -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: azconfig.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: AzureAppConfigurationProvider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: devconfigs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  endpoint: $AC_ENDPOINT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  configuration:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    refresh:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      interval: 10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      monitoring:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        keyValues:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - key: MyKey1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  target:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configMapName: myconfigmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  auth:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    workloadIdentity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serviceAccountName: $SA_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secret:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auth:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      workloadIdentity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serviceAccountName: $SA_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    target:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      secretName: mysecret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The sync manifest above will sync the key-value pairs from the Azure App Configuration store to the Kubernetes ConfigMap. Every 10s the configurations will be refreshed and the key MyKey1 will be treated as the sentinel key and monitored for changes. When the value for MyKey1 changes in the Azure App Configuration store, the Kubernetes ConfigMap will be updated. The configuration store also has a secret reference to the Azure Key Vault secret MySecret1. The secret will be synced to the Kubernetes Secret. You could also enable a refresh interval for the secret to be updated just as we did for the key-value pairs, but for this lab, we will leave it as is.</p>
<p>After a minute or so, you can check to see if the key-value pairs in the configuration store have been synced to the Kubernetes ConfigMap.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get cm -n dev myconfigmap -o jsonpath=&#x27;{.data}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Also, check to see if the secret in the configuration store has been synced to the Kubernetes Secret.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get secret -n dev mysecret -o jsonpath=&#x27;{.data.MySecret1}&#x27; | base64 -d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>[!KNOWLEDGE]
While syncing secrets from Azure App Configuration to Kubernetes Secrets is supported, it is not best to keep secrets in Kubernetes Secrets because Kubernetes Secrets are not encrypted but rather base64 encoded. If you need to authenticate with Azure services from your applications, it is best to use AKS Workload Identity and Microsoft Entra ID for passwordless authentication.</p>
</blockquote>
<p>The app config sync is set to refresh every 10 seconds and you can choose which key to listen for changes. In this case, we are only listening for changes to the Key1 configuration. If you update the value for Key1 in the Azure App Configuration store, you should see the value updated in the Kubernetes ConfigMap after the next refresh.</p>
<p>Run the following command to update the value for Key1 in the Azure App Configuration store.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az appconfig kv set \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name $AC_NAME \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--key MyKey1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--value MyNewValue1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--yes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After 10 seconds, you can check to see if the configurations have been updated in the Kubernetes ConfigMap.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get cm -n dev myconfigmap -o jsonpath=&#x27;{.data}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Great job! You have successfully synced configurations from Azure App Configuration to Kubernetes ConfigMaps and Secrets.</p>
<p>===</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="scaling-and-workload-scheduling">Scaling and workload scheduling<a href="#scaling-and-workload-scheduling" class="hash-link" aria-label="Direct link to Scaling and workload scheduling" title="Direct link to Scaling and workload scheduling">​</a></h2>
<p>One key benefit of Kubernetes is its ability to scale workloads across a pool of nodes. One key differentiator of running Kubernetes in the cloud is its power to dynamically scale the entire node pool to accommodate more workloads and meet user demand. This guide aims to get you comfortable with the scaling capabilities of AKS Automatic and understand best practices for workload scheduling.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cluster-autoscaling">Cluster autoscaling<a href="#cluster-autoscaling" class="hash-link" aria-label="Direct link to Cluster autoscaling" title="Direct link to Cluster autoscaling">​</a></h3>
<p>With AKS Automatic, the <a href="https://learn.microsoft.com/azure/aks/node-autoprovision?tabs=azure-cli" target="_blank" rel="noopener noreferrer">Node Autoprovision (NAP)</a> feature is enabled by default and acts as the cluster autoscaler. AKS Node Autoprovision is the Azure implementation of the <a href="https://karpenter.sh" target="_blank" rel="noopener noreferrer">Karpenter project</a> which was developed by friends at AWS and <a href="https://aws.amazon.com/blogs/containers/karpenter-graduates-to-beta/" target="_blank" rel="noopener noreferrer">donated to the Cloud Native Computing Foundation (CNCF)</a>. In short, Karpenter is a Kubernetes controller that automates the provisioning, right-sizing, and termination of nodes in a Kubernetes cluster.</p>
<blockquote>
<p>[!NOTE]
The term <strong>Node Autoprovision (NAP)</strong> may be used interchangeably with <strong>Karpenter</strong> in this lab.</p>
</blockquote>
<p>When using an AKS Automatic cluster, a system node pool is automatically deployed to run essential components managed by AKS Automatic. As workloads are added or removed from the cluster, the Node Autoscaling (NAP) feature dynamically scales up or down the number of nodes to meet demand. Initially, only system nodes run in the cluster, but as workloads are deployed, NAP provisions new nodes to support them. Conversely, when workloads are deleted, NAP reduces the number of nodes to minimize costs. However, this process can leave pods in a pending state until a new node is available or cause disruptions during consolidation events. As a result, it’s essential to consider these factors when planning high availability for your workloads.</p>
<p>There are a few key Karpenter concepts to understand when working with NAP. Let&#x27;s start by understanding the following concepts:</p>
<ul>
<li><a href="https://karpenter.sh/docs/concepts/nodeclasses/" target="_blank" rel="noopener noreferrer">NodeClass</a> - set of constraints that define the type of node that should be provisioned. For example, you can define a NodeClass that specifies the type of VM, the region, the availability zone, and the maximum number of nodes that can be provisioned. In AKS, a default AKSNodeClass is created for you which specifies the OS image (currently <a href="https://github.com/microsoft/azurelinux" target="_blank" rel="noopener noreferrer">AzureLinux</a>), and OS disk size of 128GB.</li>
<li><a href="https://karpenter.sh/docs/concepts/nodepools/" target="_blank" rel="noopener noreferrer">NodePool</a> - set of nodes that are provisioned based on a NodeClass. You can have multiple NodePools in a cluster, each with its own set of constraints. In AKS Automatic, the default NodePool is created for you. You can create additional NodePools with specific constraints if you have workloads that require specific VM attributes. For examples of various NodePool constraints, see the the <a href="https://github.com/Azure/karpenter-provider-azure/tree/main/examples/v1beta1" target="_blank" rel="noopener noreferrer">examples</a> in the Karpenter Azure provider repository.</li>
<li><a href="https://karpenter.sh/docs/concepts/nodeclaims/" target="_blank" rel="noopener noreferrer">NodeClaim</a> - request for a node that matches a set of constraints. When a NodeClaim is created, Karpenter will provision a node that matches the constraints specified in the NodeClaim, and thus, a VM is born!</li>
</ul>
<p>As mentioned above, the default NodeClass and default NodePool are created for you. So you can start deploying workloads right away. The default NodeClass is fairly generic and should be able to handle most workloads.</p>
<p>You can view the default NodePool by running the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get nodepools default -o yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You may want to create additional NodePools with specific constraints if you have teams that need to deploy workloads that require specific compute requirements.</p>
<p>Run the following command to create a new NodePool for the dev team.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: karpenter.sh/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: NodePool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes.io/description: General purpose NodePool for dev workloads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: devpool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  disruption:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    budgets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - nodes: 100%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    consolidationPolicy: WhenUnderutilized</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    expireAfter: Never</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        team: dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      nodeClassRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      taints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - key: team</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value: dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          effect: NoSchedule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      requirements:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - key: kubernetes.io/arch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - arm64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - key: kubernetes.io/os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - key: karpenter.sh/capacity-type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - on-demand</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - key: karpenter.azure.com/sku-family</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This NodePool manifest creates a new NodePool called <strong>devpool</strong> with the following specifications:</p>
<ul>
<li>The NodePool is labeled with <strong>team=dev</strong></li>
<li>The NodePool only supports <strong>arm64</strong> architecture</li>
<li>The NodePool only supports <strong>linux</strong> operating system</li>
<li>The NodePool only supports <strong>on-demand</strong> capacity type</li>
<li>The NodePool only supports <strong>D</strong> Azure VM SKU family</li>
</ul>
<p>It is important to know that the nodes in the dev NodePool will have a taint applied to them with the key <strong>team=dev</strong> and the effect <strong>NoSchedule</strong>. This means that only pods that have a toleration for the <strong>team=dev</strong> taint will be scheduled on the nodes in the dev NodePool.</p>
<p>Now that the dev team has their own NodePool, you can try scheduling a pod that tolerates the taint that will be applied to the dev nodes. Before we do that, let&#x27;s import the product-service container image into the Azure Container Registry.</p>
<blockquote>
<p>[!HINT]
Remember we created a new policy that only allows images from specified container registries and container images that are not from the approved container registries will be denied.</p>
</blockquote>
<p>Run the following command to get the name of the Azure Container Registry.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ACR_NAME=$(az acr list \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group myresourcegroup \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query &quot;[0].name&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output tsv)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to import the product-service container image into the Azure Container Registry.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az acr import \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name $ACR_NAME \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--source ghcr.io/azure-samples/aks-store-demo/product-service:1.5.2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--image product-service:1.5.2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to replace the existing product-service pod.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl replace --force -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: product-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: product-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: product-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: product-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: $ACR_NAME.azurecr.io/product-service:1.5.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      affinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nodeAffinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          requiredDuringSchedulingIgnoredDuringExecution:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nodeSelectorTerms:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - matchExpressions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              - key: team</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                - dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tolerations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - key: &quot;team&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        operator: &quot;Equal&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value: &quot;dev&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        effect: &quot;NoSchedule&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This pod manifests ensures that the workload will be scheduled on a dev team node with the <strong>nodeSelectorTerms</strong> spec and tolerates the <strong>team=dev</strong> taint that was specified in the nodepool manifest.</p>
<p>You can check to see if the pod has been scheduled by running the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get po -n dev -l app=product-service -o wide</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see the pod in <strong>Pending</strong> state. This is because the dev NodePool does not have any nodes provisioned yet. The AKS cluster will automatically provision a node in the dev NodePool to satisfy the pod&#x27;s requirements.</p>
<p>Once the node has been provisioned, you will see the pod in <strong>Running</strong> state.</p>
<p>If you run the following command, you will be able to see a new node being provisioned.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get nodes -l karpenter.sh/registered=true -o custom-columns=NAME:&#x27;{.metadata.name}&#x27;,OS:&#x27;{.status.nodeInfo.osImage}&#x27;,ARCH:&#x27;{.status.nodeInfo.architecture}&#x27;,SKU:&#x27;{.metadata.labels.karpenter\.azure\.com/sku-name}&#x27; -w</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once you see the new node being provisioned, press <strong>Ctrl+C</strong> to exit the watch then run the following command to see the pod in <strong>Running</strong> state.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get po -n dev -l app=product-service -o wide</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With NAP, you can ensure that your dev teams have the right resources to run their workloads without having to worry about the underlying infrastructure. As demonstrated, you can create NodePools with specific constraints to handle different types of workloads. But it is important to remember that the workload manifests include the necessary scheduling attributes such as <strong>nodeAffinity</strong> and <strong>tolerations</strong> to ensure that the workloads are scheduled on the right nodes. Otherwise, they may be scheduled on the default NodePool which is fairly generic and welcomes all workloads.</p>
<p>When deploying workloads to Kubernetes, it is important to follow best practices to ensure that your workloads are scheduled efficiently and effectively. This includes setting resource requests and limits, using PodDisruptionBudgets, and setting pod anti-affinity rules.</p>
<p>Let&#x27;s explore a few best practices for workload scheduling.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="resource-requests-and-vertical-pod-autoscaler">Resource requests and Vertical Pod Autoscaler<a href="#resource-requests-and-vertical-pod-autoscaler" class="hash-link" aria-label="Direct link to Resource requests and Vertical Pod Autoscaler" title="Direct link to Resource requests and Vertical Pod Autoscaler">​</a></h3>
<p>When deploying workloads to Kubernetes, it is important to set resource requests and limits. Resource requests are used by the scheduler to find the best node to place the pod on. Resource limits are used to prevent a pod from consuming more resources than it should. By setting resource requests and limits, you can ensure that your workloads are scheduled efficiently and effectively. We saw an example of this earlier when we deployed a pod with resource requests and limits after seeing warnings about not having them set.</p>
<p>But what if you don&#x27;t know what values to set for the resource requests and limits? This is where the <a href="https://learn.microsoft.com/azure/aks/vertical-pod-autoscaler" target="_blank" rel="noopener noreferrer">Vertical Pod Autoscaler (VPA)</a> comes in. The VPA automatically adjusts the resource requests and limits for your workloads based on their usage.</p>
<p>In the previous section, we deployed the product-service sample app without any resource requests and limits. Run the following command to confirm there are no resource requests and limits set for the product-service.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe po -n dev $(kubectl get pod -n dev -l app=product-service  -o jsonpath=&#x27;{.items[0].metadata.name}&#x27;) | grep -i requests -A2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, deploy a VerticalPodAutoscaler resource to automatically adjust the resource requests for the product-service.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: &quot;autoscaling.k8s.io/v1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: VerticalPodAutoscaler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: product-service-vpa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  targetRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apiVersion: &quot;apps/v1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: product-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Watch the pod for a few minutes and you should see the pod being restarted with the updated resource requests and limits.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod -l app=product-service -n dev -w</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>[!ALERT]
The VPA will evict pods only if the number of replicas is greater than 1. Otherwise, it will not evict the pod.</p>
</blockquote>
<p>Once you see the pods being restarted, press <strong>Ctrl+C</strong> to exit the watch then run the following command to confirm the resource requests and limits have been set.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe po -n dev | grep -i requests -A2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With requests in place, the scheduler can make better decisions about where to place the pod. The VPA will also adjust the resource requests based on the pod&#x27;s usage. This is also especially important when using pod autoscaling features like the Kubernetes <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" target="_blank" rel="noopener noreferrer">HorizontalPodAutoscaler</a> or <a href="https://keda.sh" target="_blank" rel="noopener noreferrer">KEDA</a>.</p>
<blockquote>
<p>[!KNOWLEDGE]
KEDA is the Kubernetes-based Event Driven Autoscaler. With KEDA, you can scale your workloads based on the number of events in a queue, the length of a stream, or any other custom metric. It won&#x27;t be covered in this lab, but the KEDA add-on for AKS is enabled by default in AKS Automatic clusters and you can learn more about it <a href="https://learn.microsoft.com/azure/aks/keda-about" target="_blank" rel="noopener noreferrer">here</a>.</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="dealing-with-disruptions">Dealing with disruptions<a href="#dealing-with-disruptions" class="hash-link" aria-label="Direct link to Dealing with disruptions" title="Direct link to Dealing with disruptions">​</a></h3>
<p>When deploying workloads to Kubernetes, it is important to ensure that your workloads are highly available and resilient to voluntary and involuntary disruptions. This is especially important when running workloads with Karpenter because nodes can be provisioned and deprovisioned automatically. There are a few best practices to follow to ensure that your workloads are highly available and resilient to disruptions.</p>
<p>One thing you can do is to set <a href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/#pod-disruption-budgets" target="_blank" rel="noopener noreferrer">PodDisruptionBudgets</a> for your workloads. PodDisruptionBudgets are used to ensure that a certain number of pods are available during maintenance or disruptions. By setting PodDisruptionBudgets, you can ensure that your workloads are not abruptly terminated during maintenance or node scale down events.</p>
<p>The YAML spec for a PodDisruptionBudget is relatively easy to write and understand. But if you are not sure of how to write one, you can use <a href="https://learn.microsoft.com/azure/copilot/overview" target="_blank" rel="noopener noreferrer">Microsoft Copilot for Azure</a> to generate the YAML for you.</p>
<p>Follow these steps to create a PodDisruptionBudget for the product-service running in the dev namespace.</p>
<ul>
<li>Navigate to your AKS cluster in the Azure Portal</li>
<li>Under the <strong>Kubernetes resources</strong> section, click on <strong>Workloads</strong>, then click on the <strong>+ Create</strong> button to expand the dropdown</li>
<li>Click on the <strong>Apply a YAML</strong> button. Here you will be presented with a blank YAML editor</li>
<li>Put your cursor in the editor and press <strong>Alt+I</strong> to open the prompt dialog</li>
<li>In the textbox type the following text and press the <strong>Enter</strong> key<!-- -->
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">create a pod disruption budget for the product-service running in the dev namespace to run at least 1 replica at all times</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>You will see the YAML generated for you</li>
<li>Click <strong>Accept</strong></li>
<li>Click the <strong>Dry-run</strong> button to ensure the YAML is valid</li>
<li>Click <strong>Add</strong> button</li>
</ul>
<p>Great! So now that you have a PodDisruptionBudget in place, you can be sure that at least one replica of the product-service will be available at all times. This is especially important when running workloads with Karpenter because it will try to consolidate as much as possible.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="more-karpenter-features">More Karpenter features<a href="#more-karpenter-features" class="hash-link" aria-label="Direct link to More Karpenter features" title="Direct link to More Karpenter features">​</a></h3>
<p>There are other ways to deal with Karpenter&#x27;s desire to consolidate nodes and still maintain a healthy app. Karpenter also supports <a href="https://karpenter.sh/docs/concepts/disruption/#consolidation" target="_blank" rel="noopener noreferrer">Consolidation Policies</a> which allows you to customize the consolidation behavior. You can also set <a href="https://karpenter.sh/docs/concepts/disruption/#nodepool-disruption-budgets" target="_blank" rel="noopener noreferrer">node disruption budgets</a> in the NodePool manifest to specify the percentage of nodes that can be consolidated at a time. Lastly, if you want to simply prevent a pod or node from being disrupted, you can use the <strong>karpenter.sh/do-not-disrupt: true</strong> annotation at the <a href="https://karpenter.sh/docs/concepts/disruption/#pod-level-controls" target="_blank" rel="noopener noreferrer">pod level</a> or at the <a href="https://karpenter.sh/docs/concepts/disruption/#node-level-controls" target="_blank" rel="noopener noreferrer">node level</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="more-on-affinity-and-anti-affinity">More on affinity and anti-affinity<a href="#more-on-affinity-and-anti-affinity" class="hash-link" aria-label="Direct link to More on affinity and anti-affinity" title="Direct link to More on affinity and anti-affinity">​</a></h3>
<p><a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity" target="_blank" rel="noopener noreferrer">Affinity and anti-affinity</a> in Kubernetes is a way for you to influence the scheduling of pods in a Kubernetes cluster. We saw an example of this earlier when we deployed a pod with node affinity and tolerations to ensure that the pod was scheduled on a node that matched the criteria. Pod anti-affinity is used to ensure that pods are not scheduled on the same node. If you noticed, the product-service deployment included three replicas but they were all scheduled on the same node.</p>
<p>Go back to your terminal and confirm this by running the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get po -n dev -l app=product-service -o wide</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If a node hardware failure occurs, all three replicas will be disrupted at the same time even with the PodDisruptionBudget in place. To ensure that the replicas are spread across different nodes, you can set pods anti-affinity rules.</p>
<p>Run the following command to replace the product-service deployment with pod anti-affinity rules in place.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl replace --force -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: product-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: product-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: product-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: product-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: $ACR_NAME.azurecr.io/product-service:1.5.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      affinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nodeAffinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          requiredDuringSchedulingIgnoredDuringExecution:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nodeSelectorTerms:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - matchExpressions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              - key: team</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                - dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        podAntiAffinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          requiredDuringSchedulingIgnoredDuringExecution:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - labelSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                matchExpressions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  - key: app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      - product-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              topologyKey: &quot;kubernetes.io/hostname&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tolerations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - key: &quot;team&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        operator: &quot;Equal&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value: &quot;dev&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        effect: &quot;NoSchedule&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this updated deployment manifest, we added a <strong>podAntiAffinity</strong> field to ensure that the replicas are scheduled on different nodes. The <strong>topologyKey</strong> field specifies the key of the node label that the anti-affinity rule should be applied to. In this case, we are using the <strong>kubernetes.io/hostname</strong> key which is the hostname of the node.</p>
<p>Run the following command to watch the pods and confirm that the replicas are scheduled on different nodes.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get po -n dev -l app=product-service -o wide -w</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once you see the pods being scheduled on different nodes, press <strong>Ctrl+C</strong> to exit the watch.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pod-topology-spread-constraints">Pod topology spread constraints<a href="#pod-topology-spread-constraints" class="hash-link" aria-label="Direct link to Pod topology spread constraints" title="Direct link to Pod topology spread constraints">​</a></h3>
<p>To take the concept of spreading pods across nodes even further, you can use <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/" target="_blank" rel="noopener noreferrer">Pod topology spread constraints</a> on top of pod anti-affinity rules. Pod topology spread constraints are used to ensure that pods are spread across different fault domains such as <a href="https://learn.microsoft.com/azure/reliability/availability-zones-overview?tabs=azure-cli" target="_blank" rel="noopener noreferrer">Azure availability zones</a>. With AKS Automatic, one of its requirements is to ensure the region its being deployed to supports availability zones. Therefore, you can be sure that the nodes provisioned by Karpenter can be spread across different availability zones.</p>
<p>Let&#x27;s take a look at the availability zones of the nodes in the dev NodePool. Run the following command to get the nodes in the dev NodePool and their availability zones.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get nodes -l karpenter.sh/nodepool=devpool -o custom-columns=NAME:&#x27;{.metadata.name}&#x27;,OS:&#x27;{.status.nodeInfo.osImage}&#x27;,SKU:&#x27;{.metadata.labels.karpenter\.azure\.com/sku-name}&#x27;,ZONE:&#x27;{.metadata.labels.topology\.kubernetes\.io/zone}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the output, you will see the nodes and their availability zones. The availability zones is denoted by a dash and a number following the region name. For example, <strong>eastus-1</strong>, <strong>eastus-2</strong>, and <strong>eastus-3</strong> are the availability zones in the <strong>eastus</strong> region.</p>
<p>Chances are that the nodes are already spread across different availability zones or you may see that all the nodes are in the same availability zone. You&#x27;re really leaving it up to chance but to ensure that the pods are spread across different availability zones, you can set pod topology spread constraints.</p>
<p>Run the following command to delete the product-service deployment.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete deployment product-service -n dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to watch the nodes in the dev NodePool get deleted.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get nodes -l karpenter.sh/nodepool=devpool -w</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When you see that all the nodes in the dev NodePool are deleted, press <strong>Ctrl+C</strong> to exit the watch.</p>
<p>Run the following command to re-deploy the product-service deployment with pod topology spread constraints.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: product-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: product-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: product-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: product-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: $ACR_NAME.azurecr.io/product-service:1.5.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      affinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nodeAffinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          requiredDuringSchedulingIgnoredDuringExecution:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nodeSelectorTerms:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - matchExpressions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              - key: team</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                - dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        podAntiAffinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          requiredDuringSchedulingIgnoredDuringExecution:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - labelSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                matchExpressions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  - key: app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      - product-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              topologyKey: &quot;kubernetes.io/hostname&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tolerations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - key: &quot;team&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        operator: &quot;Equal&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value: &quot;dev&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        effect: &quot;NoSchedule&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      topologySpreadConstraints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - maxSkew: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        topologyKey: &quot;topology.kubernetes.io/zone&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        whenUnsatisfiable: DoNotSchedule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        labelSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            app: product-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here, the pod topology spread constraints will ensure that the pods are spread across different availability zones as the topology key is set to <strong>topology.kubernetes.io/zone</strong>. The <strong>maxSkew</strong> field specifies the maximum difference between the number of pods in any two zones. The <strong>whenUnsatisfiable</strong> field specifies what action to take if the constraint cannot be satisfied. In this case, we set it to <strong>DoNotSchedule</strong> which means that the pod will not be scheduled if the constraint cannot be satisfied. More information on spreading pods across different zones can be found <a href="https://learn.microsoft.com/azure/aks/aks-zone-resiliency#ensure-pods-are-spread-across-azs" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>Run the following command and you should start to see the nodes coming up in different availability zones.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get nodes -l karpenter.sh/nodepool=devpool -o custom-columns=NAME:&#x27;{.metadata.name}&#x27;,OS:&#x27;{.status.nodeInfo.osImage}&#x27;,SKU:&#x27;{.metadata.labels.karpenter\.azure\.com/sku-name}&#x27;,ZONE:&#x27;{.metadata.labels.topology\.kubernetes\.io/zone}&#x27; -w</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once you see the nodes coming up in different availability zones, press <strong>Ctrl+C</strong> to exit the watch.</p>
<p>Now, run the following command to watch the pods and confirm that the replicas are scheduled across different availability zones.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get po -n dev -l app=product-service -o wide</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Excellent! You have now know about some of the best practices for workload scheduling in Kubernetes to ensure that your workloads are scheduled efficiently and effectively.</p>
<p>===</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting-workloads">Troubleshooting workloads<a href="#troubleshooting-workloads" class="hash-link" aria-label="Direct link to Troubleshooting workloads" title="Direct link to Troubleshooting workloads">​</a></h2>
<p>Let&#x27;s face it. Applications will fail. Being able to quickly identify and mitigate issues is crucial and in this section, you will become familiar with common kubernetes troubleshooting techniques and lean heavily on Microsoft Copilot for Azure to help uncover and solve problems.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting-with-azure-copilot">Troubleshooting with Azure Copilot<a href="#troubleshooting-with-azure-copilot" class="hash-link" aria-label="Direct link to Troubleshooting with Azure Copilot" title="Direct link to Troubleshooting with Azure Copilot">​</a></h3>
<p><a href="https://learn.microsoft.com/azure/copilot/overview" target="_blank" rel="noopener noreferrer">Microsoft Copilot for Azure</a> is a tool built into the Azure portal that enables you to diagnose and troubleshoot issues. It is not only limited to AKS but you can use it to help troubleshoot any issues with your Azure resources. The Azure Copilot provides a guided experience to lead you through the troubleshooting process and helps you understand concepts by offering explanations, suggestions, and resource URLs to learn more.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="find-the-issue">Find the issue<a href="#find-the-issue" class="hash-link" aria-label="Direct link to Find the issue" title="Direct link to Find the issue">​</a></h4>
<p>In the Azure Portal, navigate to your AKS cluster and click on the Copilot button found at the top of the page. A panel will open on the right side of the screen and you will be presented with some suggested prompts.</p>
<p>Ask the Copilot:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">How is the health of my pods?</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should be presented with a kubectl command that you can run to get the status of your pods.</p>
<p>Click the <strong>Yes</strong> button to execute the command from the Run command page.</p>
<p>In the Run command page, the kubectl command will be pre-populated in the textbox at the bottom of the page. Click on <strong>Run</strong> to execute the command. You will see the output of the kubectl command in the main panel.</p>
<p>Scroll through the output and see if you can spot the issue.</p>
<blockquote>
<p>[!HINT]
There is a problem with the ai-service pod.</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="find-the-solution">Find the solution<a href="#find-the-solution" class="hash-link" aria-label="Direct link to Find the solution" title="Direct link to Find the solution">​</a></h4>
<p>Ask the Copilot:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">I see the ai-service pod in the dev namespace with CrashLoopBackOff status. What does that mean?</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The Copilot should provide you with an explanation of what the CrashLoopBackOff status means and how to troubleshoot it.</p>
<p>You were not specific with the pod name so the Copilot gave you a general command to run, so re-prompt the Copilot to restate the commands by giving it the exact pod name <code>The exact pod name is ai-service-xxxxx. What commands should I run again?</code> (replace the xxxxx with the actual pod name).</p>
<blockquote>
<p>[!HINT]
Some of the commands may include a <strong>Run</strong> button that can enable the Azure Cloud Shell, don&#x27;t use this as you&#x27;d need to re-authenticate from within the Cloud Shell. Instead, copy the <strong>kubectl describe</strong> pod command and run it in the Run command window to get more information about the pod.</p>
</blockquote>
<p>The <strong>kubectl describe</strong> command will provide you with more information about the pod including the events that led to the CrashLoopBackOff status. You might get a little more information about the issue if you look through the pod logs.</p>
<p>The Copilot should have also provided you with a <strong>kubectl logs</strong> command to get the logs of the pod.</p>
<p>Run that command to get the logs.</p>
<p>You should see that the ai-service pod is failing because it is missing environment variables that are required to connect to Azure OpenAI. Do you have an Azure OpenAI service running? If you are not sure, you can ask the Copilot <code>Do I have an Azure OpenAI service running?</code></p>
<p>The Copilot will provide you with an <a href="https://learn.microsoft.com/azure/governance/resource-graph/overview" target="_blank" rel="noopener noreferrer">Azure Resource Graph</a> command and run it behind the scenes to determine if you have an Azure OpenAI service running.</p>
<p>It should have determined there is no Azure OpenAI service running.</p>
<p>You go back to your dev team and they tell you that they will need an Azure OpenAI service with the GPT-3.5 Turbo model to run the ai-service pod.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="implement-the-solution">Implement the solution<a href="#implement-the-solution" class="hash-link" aria-label="Direct link to Implement the solution" title="Direct link to Implement the solution">​</a></h4>
<p>Ask the Copilot:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">How do I create an Azure OpenAI service with the GPT-3.5 Turbo model?</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>[!ALERT]
The Azure Copilot may not always provide you with the exact commands to run but it will provide you with the necessary information to get you started.</p>
</blockquote>
<p>The instructions should be very close to what you need. You can either follow the instructions and/or reference the docs it replies with or you can run the following commands to quickly create an Azure OpenAI service account.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AI_NAME=$(az cognitiveservices account create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name myaiservice$RANDOM \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group myresourcegroup \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kind OpenAI \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--sku S0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--custom-domain myaiservice$RANDOM \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query name \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output tsv)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, run the following command to deploy a GPT-3.5 Turbo model.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az cognitiveservices account deployment create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name $AI_NAME \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group myresourcegroup \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--deployment-name gpt-35-turbo \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--model-name gpt-35-turbo \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--model-version &quot;0301&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--model-format OpenAI \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--sku-capacity 1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--sku-name &quot;Standard&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>[!ALERT]
The model version above may not be available in your region. You can the model availability <a href="https://learn.microsoft.com/azure/ai-services/openai/concepts/models?tabs=python-secure#standard-deployment-model-availability" target="_blank" rel="noopener noreferrer">here</a></p>
</blockquote>
<p>The dev team also tells you that the ai-service pod uses a ConfigMap named <strong>ai-service-configs</strong> with the following environment variables to connect to the Azure OpenAI service.</p>
<ul>
<li><strong>AZURE_OPENAI_DEPLOYMENT_NAME</strong> set to &quot;gpt-35-turbo&quot;</li>
<li><strong>AZURE_OPENAI_ENDPOINT</strong> set to the endpoint of the Azure OpenAI service</li>
<li><strong>USE_AZURE_OPENAI</strong> set to &quot;True&quot;</li>
</ul>
<p>Run the following command to delete the existing ConfigMap.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete configmap ai-service-configs -n dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to create a new ConfigMap with the Azure OpenAI service endpoint.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create configmap ai-service-configs -n dev --from-literal=AZURE_OPENAI_DEPLOYMENT_NAME=gpt-35-turbo --from-literal=AZURE_OPENAI_ENDPOINT=$(az cognitiveservices account show --name $AI_NAME --resource-group myresourcegroup --query properties.endpoint -o tsv) --from-literal=USE_AZURE_OPENAI=True</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Additionally the ai-service pod uses a Secret named <strong>ai-service-secrets</strong> with the following variable to authenticate to the Azure OpenAI service.</p>
<ul>
<li><strong>OPENAI_API_KEY</strong> set to the API key of the Azure OpenAI service</li>
</ul>
<p>Run the following command to delete the existing Secret.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete secret ai-service-secrets -n dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to create a new Secret with the Azure OpenAI service API key.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create secret generic ai-service-secrets -n dev --from-literal=OPENAI_API_KEY=$(az cognitiveservices account keys list --name $AI_NAME --resource-group myresourcegroup --query key1 -o tsv)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Finally, run the following command to re-deploy the ai-service pod.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deployment ai-service -n dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see the ai-service pod status change from CrashLoopBackOff status to Running after a few minutes.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="challenges">Challenges<a href="#challenges" class="hash-link" aria-label="Direct link to Challenges" title="Direct link to Challenges">​</a></h4>
<ol>
<li>Based on what you have learned so far in this lab, can you leverage Azure App Configuration to store the environment variables for the ai-service pod and sync them to the Kubernetes ConfigMap and Secret?</li>
<li>How can you go about updating this to use passwordless authentication with AKS Workload Identity instead?</li>
</ol>
<blockquote>
<p>[!HINT]
A complete walkthrough of the solution can be found <a href="https://learn.microsoft.com/azure/aks/open-ai-secure-access-quickstart" target="_blank" rel="noopener noreferrer">here</a></p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting-with-kubectl">Troubleshooting with kubectl<a href="#troubleshooting-with-kubectl" class="hash-link" aria-label="Direct link to Troubleshooting with kubectl" title="Direct link to Troubleshooting with kubectl">​</a></h3>
<p>The Azure Copilot gave you some pretty good suggestions to start troubleshooting with kubectl. The <strong>kubectl describe</strong> command is a great way to get more information about a pod. You can also use the <strong>kubectl logs</strong> command to get the logs of a pod. One thing to note about using the <strong>kubectl logs</strong> command is that it only works for pods that are running. If the pod is in a CrashLoopBackOff status, you may not be able to get the logs of the pod that failed. In this case you can use the <strong>--previous</strong> flag to get the logs of the previous container that failed.</p>
<p>Finally, be sure to checkout the <a href="https://kubernetes.io/docs/tasks/debug/debug-application/" target="_blank" rel="noopener noreferrer">Troubleshooting Applications</a> guide found on the Kubernetes documentation site and the following resources for more information on troubleshooting AKS:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/copilot/work-aks-clusters" target="_blank" rel="noopener noreferrer">Work with AKS clusters efficiently using Microsoft Copilot in Azure</a></li>
<li><a href="https://learn.microsoft.com/troubleshoot/azure/azure-kubernetes/welcome-azure-kubernetes" target="_blank" rel="noopener noreferrer">Azure Kubernetes Service (AKS) troubleshooting documentation</a></li>
<li><a href="https://learn.microsoft.com/azure/aks/advanced-network-observability-cli?tabs=cilium" target="_blank" rel="noopener noreferrer">Set up Advanced Network Observability for Azure Kubernetes Service (AKS)</a></li>
</ul>
<p>===</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>Congratulations! You have completed the workshop on operating AKS Automatic. You have learned how to create an AKS Automatic cluster, enforce custom policies, sync configurations to the cluster, scale workloads, and apply best practices for workload scheduling. You have also learned how to troubleshoot issues in AKS. You are now well-equipped to operate AKS Automatic clusters and ensure that your workloads are running efficiently and effectively.</p>
<p>This lab is also available at <a href="https://aka.ms/aks/labs" target="_blank" rel="noopener noreferrer">https://aka.ms/aks/labs</a> along with others, so be sure to check out the site often for new labs and updates.</p>
<p>If you have any feedback or questions on AKS in general, please reach out to us at <a href="https://aka.ms/aks/feedback" target="_blank" rel="noopener noreferrer">https://aka.ms/aks/feedback</a>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/Azure-Samples/aks-labs/tree/main/docs/operating-aks-automatic/workshop.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/aks-labs/docs/category/operating-aks-automatic"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Operating AKS Automatic</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/aks-labs/docs/category/advanced-aks"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Advanced AKS</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a><ul><li><a href="#objectives" class="table-of-contents__link toc-highlight">Objectives</a></li><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li></ul></li><li><a href="#security-and-governance" class="table-of-contents__link toc-highlight">Security and governance</a><ul><li><a href="#granting-permissions-to-the-aks-cluster" class="table-of-contents__link toc-highlight">Granting permissions to the AKS cluster</a></li><li><a href="#deployment-safeguards" class="table-of-contents__link toc-highlight">Deployment Safeguards</a></li><li><a href="#custom-policy-enforcement" class="table-of-contents__link toc-highlight">Custom policy enforcement</a></li></ul></li><li><a href="#secrets-and-config-management" class="table-of-contents__link toc-highlight">Secrets and config management</a><ul><li><a href="#provision-azure-resources" class="table-of-contents__link toc-highlight">Provision Azure resources</a></li><li><a href="#azure-app-configuration-provider-for-kubernetes" class="table-of-contents__link toc-highlight">Azure App Configuration Provider for Kubernetes</a></li><li><a href="#passwordless-authentication-to-azure-services" class="table-of-contents__link toc-highlight">Passwordless authentication to Azure services</a></li><li><a href="#config-sync-to-kubernetes" class="table-of-contents__link toc-highlight">Config sync to Kubernetes</a></li></ul></li><li><a href="#scaling-and-workload-scheduling" class="table-of-contents__link toc-highlight">Scaling and workload scheduling</a><ul><li><a href="#cluster-autoscaling" class="table-of-contents__link toc-highlight">Cluster autoscaling</a></li><li><a href="#resource-requests-and-vertical-pod-autoscaler" class="table-of-contents__link toc-highlight">Resource requests and Vertical Pod Autoscaler</a></li><li><a href="#dealing-with-disruptions" class="table-of-contents__link toc-highlight">Dealing with disruptions</a></li><li><a href="#more-karpenter-features" class="table-of-contents__link toc-highlight">More Karpenter features</a></li><li><a href="#more-on-affinity-and-anti-affinity" class="table-of-contents__link toc-highlight">More on affinity and anti-affinity</a></li><li><a href="#pod-topology-spread-constraints" class="table-of-contents__link toc-highlight">Pod topology spread constraints</a></li></ul></li><li><a href="#troubleshooting-workloads" class="table-of-contents__link toc-highlight">Troubleshooting workloads</a><ul><li><a href="#troubleshooting-with-azure-copilot" class="table-of-contents__link toc-highlight">Troubleshooting with Azure Copilot</a></li><li><a href="#troubleshooting-with-kubectl" class="table-of-contents__link toc-highlight">Troubleshooting with kubectl</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Microsoft. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>