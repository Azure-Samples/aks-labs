<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-advanced-aks/advanced-aks-scenarios" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Advanced AKS Scenarios | AKS LABS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://azure-samples.github.io/aks-labs/img/aks-labs-social-card.png"><meta data-rh="true" name="twitter:image" content="https://azure-samples.github.io/aks-labs/img/aks-labs-social-card.png"><meta data-rh="true" property="og:url" content="https://azure-samples.github.io/aks-labs/docs/advanced-aks/advanced-aks-scenarios"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Advanced AKS Scenarios | AKS LABS"><meta data-rh="true" name="description" content="Overview"><meta data-rh="true" property="og:description" content="Overview"><link data-rh="true" rel="icon" href="/aks-labs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://azure-samples.github.io/aks-labs/docs/advanced-aks/advanced-aks-scenarios"><link data-rh="true" rel="alternate" href="https://azure-samples.github.io/aks-labs/docs/advanced-aks/advanced-aks-scenarios" hreflang="en"><link data-rh="true" rel="alternate" href="https://azure-samples.github.io/aks-labs/docs/advanced-aks/advanced-aks-scenarios" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/aks-labs/blog/rss.xml" title="AKS LABS RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/aks-labs/blog/atom.xml" title="AKS LABS Atom Feed"><link rel="stylesheet" href="/aks-labs/assets/css/styles.56ddccda.css">
<script src="/aks-labs/assets/js/runtime~main.f1d0a99d.js" defer="defer"></script>
<script src="/aks-labs/assets/js/main.2f149359.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/aks-labs/img/aks-logo-icon.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/aks-labs/"><div class="navbar__logo"><img src="/aks-labs/img/aks-logo-icon.svg" alt="AKS Labs Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/aks-labs/img/aks-logo-icon.svg" alt="AKS Labs Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">AKS LABS</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/aks-labs/docs/intro">Workshops</a><a class="navbar__item navbar__link" href="/aks-labs/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/russd2357/aks-labs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/aks-labs/docs/intro">Workshop Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/getting-started-with-k8s-on-aks">Getting Started with K8s on AKS</a><button aria-label="Expand sidebar category &#x27;Getting Started with K8s on AKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/aks-automatic">AKS Automatic</a><button aria-label="Expand sidebar category &#x27;AKS Automatic&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/operating-aks-automatic">Operating AKS Automatic</a><button aria-label="Expand sidebar category &#x27;Operating AKS Automatic&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/aks-labs/docs/category/advanced-aks">Advanced AKS</a><button aria-label="Collapse sidebar category &#x27;Advanced AKS&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/aks-labs/docs/advanced-aks/advanced-aks-scenarios">Advanced AKS Scenarios</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/ai-on-aks">AI on AKS</a><button aria-label="Expand sidebar category &#x27;AI on AKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/tutorial---basics">Tutorial - Basics</a><button aria-label="Expand sidebar category &#x27;Tutorial - Basics&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/tutorial---extras">Tutorial - Extras</a><button aria-label="Expand sidebar category &#x27;Tutorial - Extras&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/aks-labs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/aks-labs/docs/category/advanced-aks"><span itemprop="name">Advanced AKS</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Advanced AKS Scenarios</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Advanced AKS Scenarios and Day 2 Operations</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>This workshop is designed to help you understand advanced Azure Kubernetes Service (AKS) concepts and day 2 operations. The workshop will cover topics such as cluster sizing and topology, advanced networking concepts, advanced storage concepts, advanced security concepts, and advanced monitoring concepts.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="objectives">Objectives<a href="#objectives" class="hash-link" aria-label="Direct link to Objectives" title="Direct link to Objectives">​</a></h3>
<p>After completing this workshop, you will be able to:</p>
<ul>
<li>Deploy and manage multiple AKS clusters</li>
<li>Develop secure applications using Workload Identity on AKS</li>
<li>Monitor AKS clusters using Azure Managed Prometheus and Grafana</li>
<li>Manage cluster updates and maintenance</li>
<li>Manage costs with AKS Cost Analysis</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h2>
<p>Before you begin, you will need an <a href="https://azure.microsoft.com/" target="_blank" rel="noopener noreferrer">Azure subscription</a> with permissions to create resources and a <a href="https://github.com/signup" target="_blank" rel="noopener noreferrer">GitHub account</a>. Using a code editor like <a href="https://code.visualstudio.com/" target="_blank" rel="noopener noreferrer">Visual Studio Code</a> will also be helpful for editing files and running commands.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="command-line-tools">Command Line Tools<a href="#command-line-tools" class="hash-link" aria-label="Direct link to Command Line Tools" title="Direct link to Command Line Tools">​</a></h3>
<p>Most of the workshop will be done using command line tools, so you will need to have the following tools installed:</p>
<ul>
<li><a href="https://learn.microsoft.com/cli/azure/what-is-azure-cli" target="_blank" rel="noopener noreferrer">Azure CLI</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_blank" rel="noopener noreferrer">kubectl</a></li>
<li><a href="https://docs.cilium.io/en/stable/observability/hubble/setup/" target="_blank" rel="noopener noreferrer">Hubble CLI</a></li>
<li><a href="https://notaryproject.dev/docs/user-guides/installation/cli/" target="_blank" rel="noopener noreferrer">Notation CLI</a></li>
<li><a href="https://github.com/Azure/notation-azure-kv?tab=readme-ov-file#installation-the-akv-plugin" target="_blank" rel="noopener noreferrer">Notation AKV plugin</a></li>
<li><a href="https://git-scm.com/" target="_blank" rel="noopener noreferrer">Git</a></li>
<li>Bash shell (e.g. <a href="https://www.microsoft.com/p/windows-terminal/9n0dx20hk701" target="_blank" rel="noopener noreferrer">Windows Terminal</a> with <a href="https://docs.microsoft.com/windows/wsl/install-win10" target="_blank" rel="noopener noreferrer">WSL</a> or <a href="https://shell.azure.com" target="_blank" rel="noopener noreferrer">Azure Cloud Shell</a>)</li>
</ul>
<p>If you are unable to install these tools on your local machine, you can use the Azure Cloud Shell, which has most of the tools pre-installed.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lab-environment-setup">Lab Environment Setup<a href="#lab-environment-setup" class="hash-link" aria-label="Direct link to Lab Environment Setup" title="Direct link to Lab Environment Setup">​</a></h2>
<p>This workshop will require the use of multiple Azure resources such as <a href="https://learn.microsoft.com/azure/azure-monitor/logs/log-analytics-overview" target="_blank" rel="noopener noreferrer">Azure Log Analytics</a>, <a href="https://learn.microsoft.com/azure/azure-monitor/essentials/prometheus-metrics-overview" target="_blank" rel="noopener noreferrer">Azure Managed Prometheus</a>, <a href="https://learn.microsoft.com/azure/managed-grafana/overview" target="_blank" rel="noopener noreferrer">Azure Managed Grafana</a>, <a href="https://learn.microsoft.com/azure/key-vault/general/overview" target="_blank" rel="noopener noreferrer">Azure Key Vault</a>, and <a href="https://learn.microsoft.com/azure/container-registry/container-registry-intro" target="_blank" rel="noopener noreferrer">Azure Container Registry</a>. The resource deployment can take some time, so to expedite the process, we will use a <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep" target="_blank" rel="noopener noreferrer">Bicep template</a> to deploy the resources.</p>
<p>Using the terminal of your choice, run the following commands to set up the workshop <strong>.env</strong> file which will be used to store the environment variables throughout the workshop. If you are using the Azure Cloud Shell, you may encounter shell a time out loose environment variables. Therefore, writing your variables to an <strong>.env</strong> file will make it easier to reload them.</p>
<p>Set the environment variables for the resource group name and location.</p>
<div class="important" data-title="Important"><blockquote>
<p>You must ensure the region you choose to deploy to supports <a href="https://learn.microsoft.com/azure/aks/availability-zones-overview" target="_blank" rel="noopener noreferrer">availability zones</a> to demonstrate some of the concepts in this workshop.</p>
</blockquote></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt; .env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RG_NAME=&quot;myResourceGroup&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOCATION=&quot;eastus&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to load the local variables into the shell.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source .env</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command and follow the prompts to log in to your Azure account using the Azure CLI.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az login --use-device-code</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="tip" data-title="Tip"><blockquote>
<p>If you are logging into a different tenant, you can use the <strong>--tenant</strong> flag to specify the tenant domain or tenant ID.</p>
</blockquote></div>
<p>Run the following command to create a resource group.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az group create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--location ${LOCATION}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-azure-resources-using-bicep">Deploy Azure resources using Bicep<a href="#deploy-azure-resources-using-bicep" class="hash-link" aria-label="Direct link to Deploy Azure resources using Bicep" title="Direct link to Deploy Azure resources using Bicep">​</a></h3>
<p>Run the following command to download the Bicep template file to deploy the lab resources.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl  -o main.bicep https://gist.githubusercontent.com/pauldotyu/2051a64e4709d5248902b7f8e26ff41b/raw/c2f6266927149d18cd7bda78ab832beb0cb70b95/main.bicep</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Verify the contents of the <strong>main.bicep</strong> file by running the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat main.bicep</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to save your user object ID to a variable, save it to the <strong>.env</strong> file, and reload the environment variables.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt;&gt; .env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">USER_ID=&quot;$(az ad signed-in-user show --query id -o tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source .env</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to deploy Bicep template into the resource group.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az deployment group create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group $RG_NAME \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--template-file main.bicep \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--parameters userObjectId=${USER_ID} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--no-wait</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This deployment will take a few minutes to complete. Move on to the next section while the resources are being deployed.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="aks-deployment-strategies">AKS Deployment Strategies<a href="#aks-deployment-strategies" class="hash-link" aria-label="Direct link to AKS Deployment Strategies" title="Direct link to AKS Deployment Strategies">​</a></h3>
<p>In this section, you will explore cluster setup considerations such as cluster sizing and topology, system and user node pools, and availability zones. You will create an AKS cluster implementing some of the best practices for production clusters. Not all best practices will be covered in this workshop, but you will have a good foundation to build upon.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="size-considerations">Size Considerations<a href="#size-considerations" class="hash-link" aria-label="Direct link to Size Considerations" title="Direct link to Size Considerations">​</a></h4>
<p>Before you deploy an AKS cluster, it&#x27;s essential to consider its size based on your workload requirements. The number of nodes needed depends on the number of pods you plan to run, while node configuration is determined by the amount of CPU and memory required for each pod. As you know more about your workload requirements, you can adjust the number of nodes and the size of the nodes.</p>
<p>When it comes to considering the size of the node, it is important to understand the types of Virtual Machines (VMs) available in Azure; their characteristics, such as CPU, memory, and disk, and ultimate the SKU that best fits your workload requirements. See the <a href="https://learn.microsoft.com/azure/virtual-machines/sizes/overview" target="_blank" rel="noopener noreferrer">Azure VM sizes</a> documentation for more information.</p>
<div class="info" data-title="Note"><blockquote>
<p>In your Azure subscription, you will need to make sure to have at least 32 vCPU of Standard D series quota available to create multiple AKS clusters and accommodate node surges on cluster upgrades. If you don&#x27;t have enough quota, you can request an increase. Check <a href="https://docs.microsoft.com/azure/azure-portal/supportability/per-vm-quota-requests" target="_blank" rel="noopener noreferrer">here</a> for more information.</p>
</blockquote></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="system-and-user-node-pools">System and User Node Pools<a href="#system-and-user-node-pools" class="hash-link" aria-label="Direct link to System and User Node Pools" title="Direct link to System and User Node Pools">​</a></h4>
<p>When an AKS cluster is created, a single node pool is created. The single node pool will run Kubernetes system components required to run the Kubernetes control plane. It is recommended to create a separate node pool for user workloads. This separation allows you to manage system and user workloads independently.</p>
<p>System node pools serve the primary purpose of hosting pods implementing the Kubernetes control plane, such as <strong>kube-apiserver</strong>, <strong>coredns</strong>, and <strong>metrics-server</strong> just to name a few. User node pools are additional pools of compute that can be created to host user workloads. User node pools can be created with different configurations than the system node pool, such as different VM sizes, node counts, and availability zones and are added after the cluster is created.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="resilience-with-availability-zones">Resilience with Availability Zones<a href="#resilience-with-availability-zones" class="hash-link" aria-label="Direct link to Resilience with Availability Zones" title="Direct link to Resilience with Availability Zones">​</a></h4>
<p>When creating an AKS cluster, you can specify the use of <a href="https://learn.microsoft.com/azure/aks/availability-zones" target="_blank" rel="noopener noreferrer">availability zones</a> which will distribute control plane zones within a region. You can think of availability zones as separate data centers within a large geographic region. By distributing the control plane across availability zones, you can ensure high availability for the control plane. In an Azure region, there are typically three availability zones, each with its own power source, network, and cooling.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="creating-an-aks-cluster">Creating an AKS Cluster<a href="#creating-an-aks-cluster" class="hash-link" aria-label="Direct link to Creating an AKS Cluster" title="Direct link to Creating an AKS Cluster">​</a></h3>
<p>Now that we have covered the basics of cluster sizing and topology, let&#x27;s create an AKS cluster with multiple node pools and availability zones.</p>
<p>Before you create the AKS cluster, run the following command to install the aks-preview extension. This extension will allow you to work with the latest features in AKS some of which will be in preview.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az extension add --name aks-preview</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to set a name for the AKS cluster, save it to the <strong>.env</strong> file, and reload the environment variables.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt;&gt; .env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AKS_NAME=&quot;myAKSCluster&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source .env</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to create an AKS cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--location ${LOCATION} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--tier standard \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubernetes-version 1.29 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--os-sku AzureLinux \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--nodepool-name systempool \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--node-count 3 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--zones 1 2 3 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--load-balancer-sku standard \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--network-plugin azure \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--network-plugin-mode overlay \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--network-dataplane cilium \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--network-policy cilium \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ssh-access disabled \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--enable-managed-identity \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--enable-acns \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--generate-ssh-keys</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The command above will deploy an AKS cluster with the following configurations:</p>
<ul>
<li>Deploy Kubernetes version 1.29. This is not the latest version of Kubernetes, and is intentionally set to an older version to demonstrate cluster upgrades later in the workshop.</li>
<li>Create a system node pool with 3 nodes spread across availability zones 1, 2, and 3. This node pool will be used to host Kubernetes control plane and AKS-specific components.</li>
<li>Use standard load balancer to support traffic across availability zones.</li>
<li>Use Azure CNI Overlay Powered By Cilium networking. This will give you the most advanced networking features available in AKS and gives great flexibility in how IP addresses are assigned to pods. Note the Advanced Container Networking Services (ACNS) feature is enabled and will be covered later in the workshop.</li>
<li>Some best practice for production clusters:<!-- -->
<ul>
<li>Disable SSH access to the nodes to prevent unauthorized access</li>
<li>Enable a managed identity for passwordless authentication to Azure services</li>
</ul>
</li>
</ul>
<div class="important" data-title="Important"><blockquote>
<p>Not all best practices are implemented in this workshop. For example, you will be creating an AKS cluster that can be accessible from the public internet. For production use, it is recommended to create a private cluster. You can find more information on creating a private cluster <a href="https://docs.microsoft.com/azure/aks/private-clusters" target="_blank" rel="noopener noreferrer">here</a>. Don&#x27;t worry though, more best practices will be implemented as we progress through the workshop 😎</p>
</blockquote></div>
<p>Once the AKS cluster has been created, run the following command to connect to the cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks get-credentials \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--overwrite-existing</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="adding-a-user-node-pool">Adding a User Node Pool<a href="#adding-a-user-node-pool" class="hash-link" aria-label="Direct link to Adding a User Node Pool" title="Direct link to Adding a User Node Pool">​</a></h3>
<p>As mentioned above, the AKS cluster has been created with a system node pool that is used to host system workloads. You will need to manually create a user node pool to host user workloads. This user node pool will be created with a single node but can be scaled up as needed. Also note that the VM SKU is specified here which can be changed to suit your workload requirements.</p>
<p>Run the following command to add a user node pool to the AKS cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks nodepool add \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster-name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--mode User \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name userpool \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--node-count 1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--node-vm-size Standard_DS2_v2 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--zones 1 2 3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tainting-the-system-node-pool">Tainting the System Node Pool<a href="#tainting-the-system-node-pool" class="hash-link" aria-label="Direct link to Tainting the System Node Pool" title="Direct link to Tainting the System Node Pool">​</a></h3>
<p>Now that we have created a user node pool, we need to add a taint to the system node pool to ensure that the user workloads are not scheduled on it. A taint is a key-value pair that prevents pods from being scheduled on a node unless the pod has the corresponding toleration. You could taint nodes using the <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#taint" target="_blank" rel="noopener noreferrer">kubectl taint</a> command, but since AKS can scale node pools up and down, it is recommended to use the <a href="https://learn.microsoft.com/azure/aks/use-node-taints" target="_blank" rel="noopener noreferrer">--node-taints</a> option from the Azure CLI to ensure the taint is applied to all nodes in the pool.</p>
<p>Run the following command to add a taint to the system node pool.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks nodepool update \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster-name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name systempool \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--node-taints CriticalAddonsOnly=true:NoSchedule</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This taint will prevent pods from being scheduled on the node pool unless they have a toleration for the taint. More on taints and tolerations can be found <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="enabling-aks-monitoring-and-logging">Enabling AKS Monitoring and Logging<a href="#enabling-aks-monitoring-and-logging" class="hash-link" aria-label="Direct link to Enabling AKS Monitoring and Logging" title="Direct link to Enabling AKS Monitoring and Logging">​</a></h3>
<p>Monitoring and logging are essential for maintaining the health and performance of your AKS cluster. AKS provides integrations with Azure Monitor for metrics and logs. Logging is provided by <a href="https://learn.microsoft.com/azure/azure-monitor/containers/kubernetes-monitoring-enable?tabs=cli#enable-container-insights" target="_blank" rel="noopener noreferrer">container insights</a> which can send container logs to <a href="https://learn.microsoft.com/azure/azure-monitor/logs/log-analytics-overview" target="_blank" rel="noopener noreferrer">Azure Log Analytics Workspaces</a> for analysis. Metrics are provided by <a href="https://learn.microsoft.com/azure/azure-monitor/essentials/prometheus-metrics-overview" target="_blank" rel="noopener noreferrer">Azure Monitor managed service for Prometheus</a> which collects performance metrics from nodes and pods and allows you to query using <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/" target="_blank" rel="noopener noreferrer">PromQL</a> and visualize using <a href="https://learn.microsoft.com/azure/managed-grafana/overview" target="_blank" rel="noopener noreferrer">Azure Managed Grafana</a>.</p>
<p>The Bicep template that was deployed earlier should be completed by now. All you need to do next is enable <a href="https://learn.microsoft.com/azure/azure-monitor/containers/kubernetes-monitoring-enable?tabs=cli" target="_blank" rel="noopener noreferrer">metrics monitoring</a> and on the cluster by linking the monitoring resources to the AKS cluster.</p>
<p>Run the following commands to get the resource IDs for the resources that were created, save them to the <strong>.env</strong> file, and reload the environment variables.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt;&gt; .env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MONITOR_ID=&quot;$(az monitor account list -g ${RG_NAME} --query &quot;[0].id&quot; -o tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GRAFANA_NAME=&quot;$(az grafana list -g ${RG_NAME} --query &quot;[0].name&quot; -o tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GRAFANA_ID=&quot;$(az grafana list -g ${RG_NAME} --query &quot;[0].id&quot; -o tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOGS_ID=&quot;$(az monitor log-analytics workspace list -g ${RG_NAME} --query &quot;[0].id&quot; -o tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AKV_NAME=&quot;$(az keyvault list --resource-group ${RG_NAME} --query &quot;[0].name&quot; -o tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AKV_ID=&quot;$(az keyvault list --resource-group ${RG_NAME} --query &quot;[0].id&quot; -o tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AKV_URL=&quot;$(az keyvault list --resource-group ${RG_NAME} --query &quot;[0].properties.vaultUri&quot; -o tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ACR_NAME=&quot;$(az acr list --resource-group ${RG_NAME} --query &quot;[0].name&quot; -o tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ACR_ID=&quot;$(az acr list --resource-group ${RG_NAME} --query &quot;[0].id&quot; -o tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ACR_SERVER=&quot;$(az acr list --resource-group ${RG_NAME} --query &quot;[0].loginServer&quot; -o tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source .env</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="tip" data-title="Tip"><blockquote>
<p>Whenever you want to see the contents of the <strong>.env</strong> file, run the <strong>cat .env</strong> command.</p>
</blockquote></div>
<p>Run the following command to enable metrics monitoring on the AKS cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks update \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--enable-azure-monitor-metrics \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--azure-monitor-workspace-resource-id ${MONITOR_ID} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--grafana-resource-id ${GRAFANA_ID} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--no-wait</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to enable the monitoring addon which will enable logging to the Azure Log Analytics workspace from the AKS cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks enable-addons \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--addon monitoring \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--workspace-resource-id ${LOGS_ID} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--no-wait</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="info" data-title="Note"><blockquote>
<p>More on full stack monitoring on AKS can be found <a href="https://learn.microsoft.com/azure/azure-monitor/containers/monitor-kubernetes" target="_blank" rel="noopener noreferrer">here</a></p>
</blockquote></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-the-aks-store-demo-application">Deploying the AKS Store Demo Application<a href="#deploying-the-aks-store-demo-application" class="hash-link" aria-label="Direct link to Deploying the AKS Store Demo Application" title="Direct link to Deploying the AKS Store Demo Application">​</a></h3>
<p>This workshop will have you implement features and test scenarios on the AKS cluster. To do this, you will need an application to work with. The <a href="https://github.com/Azure-Samples/aks-store-demo" target="_blank" rel="noopener noreferrer">AKS Store Demo application</a> is a simple e-commerce application that will be used to demonstrate the advanced features of AKS.</p>
<p>The application has the following services:</p>
<table><thead><tr><th>Service</th><th>Description</th></tr></thead><tbody><tr><td>store-front</td><td>Web app for customers to place orders (Vue.js)</td></tr><tr><td>order-service</td><td>This service is used for placing orders (Javascript)</td></tr><tr><td>product-service</td><td>This service is used to perform CRUD operations on products (Rust)</td></tr><tr><td>rabbitmq</td><td>RabbitMQ for an order queue</td></tr></tbody></table>
<p>Here is a high-level architecture of the application:</p>
<p><img decoding="async" loading="lazy" alt="AKS store demo architecture" src="/aks-labs/assets/images/aks-store-architecture-778ef23874e9ffd101bb1ff5429a3c4e.png" width="1424" height="525" class="img_ev3q"></p>
<p>Run the following command to create a namespace for the application.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create namespace pets</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to install the application in the <strong>pets</strong> namespace.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/Azure-Samples/aks-store-demo/refs/heads/main/aks-store-quickstart.yaml -n pets</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Verify the application was installed with the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get all -n pets</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The application uses a LoadBalancer service to allow access to the application UI. Once you have confirmed all the pods are deployed, run the following command to get the storefront service IP address.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get svc store-front -n pets</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Copy the <strong>EXTERNAL-IP</strong> of the <strong>store-front</strong> service to your browser to access the application.</p>
<p><img decoding="async" loading="lazy" alt="AKS Store Demo sample app" src="/aks-labs/assets/images/acns-pets-app-637000317205e6726da11d85b4664781.png" width="1675" height="1302" class="img_ev3q"></p>
<div class="tip" data-title="Congratulations!"><blockquote>
<p>You have now created an AKS cluster with some best practices in place such as multiple node pools, availability zones, and monitoring. You have also deployed an application to work with in the upcoming sections.</p>
<p>At this point, you can jump any section within this workshop and focus on the topics that interest you the most.</p>
<p>Feel free to click <strong>Next</strong> at the bottom of the page to continue with the workshop or jump to any of the sections in the left-hand navigation.</p>
</blockquote></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="advanced-networking-concepts">Advanced Networking Concepts<a href="#advanced-networking-concepts" class="hash-link" aria-label="Direct link to Advanced Networking Concepts" title="Direct link to Advanced Networking Concepts">​</a></h2>
<p>When you created the AKS cluster you might have noticed that we used the Azure CNI network plugin in overlay mode with <a href="https://cilium.io/" target="_blank" rel="noopener noreferrer">Cilium</a> for the network dataplane and security. This mode is the most advanced networking mode available in AKS and provides the most flexibility in how IP addresses are assigned to pods and how network policies are enforced.</p>
<p>In this section, you will explore advanced networking concepts such as network policies, FQDN filtering, and advanced container networking services.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="advanced-container-networking-services">Advanced Container Networking Services<a href="#advanced-container-networking-services" class="hash-link" aria-label="Direct link to Advanced Container Networking Services" title="Direct link to Advanced Container Networking Services">​</a></h3>
<p>Advanced Container Networking Services (ACNS) is a suite of services built to significantly enhance the operational capabilities of your Azure Kubernetes Service (AKS) clusters.
Advanced Container Networking Services contains features split into two pillars:</p>
<ul>
<li><strong>Security</strong>: For clusters using Azure CNI Powered by Cilium, network policies include fully qualified domain name (FQDN) filtering for tackling the complexities of maintaining configuration.</li>
<li><strong>Observability</strong>: The inaugural feature of the Advanced Container Networking Services suite bringing the power of Hubble’s control plane to both Cilium and non-Cilium Linux data planes. These features aim to provide visibility into networking and performance.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="enforcing-network-policy">Enforcing Network Policy<a href="#enforcing-network-policy" class="hash-link" aria-label="Direct link to Enforcing Network Policy" title="Direct link to Enforcing Network Policy">​</a></h3>
<p>In this section, we’ll apply network policies to control traffic flow to and from the Pet Shop application. We will start with standard network policy that doesn&#x27;t require ACNS, then we enforce more advanced FQDN policies.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="test-connectivity">Test Connectivity<a href="#test-connectivity" class="hash-link" aria-label="Direct link to Test Connectivity" title="Direct link to Test Connectivity">​</a></h4>
<p>Do the following test to make sure that all traffic is allowed by default</p>
<p>Run the following command to test a connection to an external website from the order-service pod.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec -n pets -it $(kubectl get po -n pets -l app=order-service -ojsonpath=&#x27;{.items[0].metadata.name}&#x27;) -c order-service -- sh -c &#x27;wget --spider www.bing.com&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see output similar to the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Connecting to www.bing.com (13.107.21.237:80)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remote file exists</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now test the connection between the order-service and product-service pods which is allowed but not required by the architecture.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec -n pets -it $(kubectl get po -n pets -l app=order-service -ojsonpath=&#x27;{.items[0].metadata.name}&#x27;) -c order-service  -- sh -c &#x27;nc -zv -w2 product-service 3002&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see output similar to the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">product-service (10.0.96.101:3002) open</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In both tests, the connection was successful. This is because all traffic is allowed by default in Kubernetes.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-network-policy">Deploy Network Policy<a href="#deploy-network-policy" class="hash-link" aria-label="Direct link to Deploy Network Policy" title="Direct link to Deploy Network Policy">​</a></h4>
<p>Now, let&#x27;s deploy some network policy to allow only the required ports in the pets namespace.</p>
<p>Run the following command to download the network policy manifest file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -o acns-network-policy.yaml https://gist.githubusercontent.com/pauldotyu/64bdb2fdf99b24fc7922ff0101a6af5d/raw/141b085f1f4e57c214281400f576274676103801/acns-network-policy.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Take a look at the network policy manifest file by running the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat acns-network-policy.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Apply the network policy to the pets namespace.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -n pets -f acns-network-policy.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="verify-policies">Verify Policies<a href="#verify-policies" class="hash-link" aria-label="Direct link to Verify Policies" title="Direct link to Verify Policies">​</a></h4>
<p>Review the created policies using the following command</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get cnp -n pets</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Ensure that only allowed connections succeed and others are blocked. For example, order-service should not be able to access <a href="http://www.bing.com" target="_blank" rel="noopener noreferrer">www.bing.com</a> or the product-service.</p>
<p>Run the following command to test the connection to <a href="http://www.bing.com" target="_blank" rel="noopener noreferrer">www.bing.com</a> from the order-service pod.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec -n pets -it $(kubectl get po -n pets -l app=order-service -ojsonpath=&#x27;{.items[0].metadata.name}&#x27;) -c order-service -- sh -c &#x27;wget --spider --timeout=1 --tries=1 www.bing.com&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see output similar to the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wget: bad address &#x27;www.bing.com&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command terminated with exit code 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to test the connection between the order-service and product-service pods.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec -n pets -it $(kubectl get po -n pets -l app=order-service -ojsonpath=&#x27;{.items[0].metadata.name}&#x27;) -c order-service  -- sh -c &#x27;nc -zv -w2 product-service 3002&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see output similar to the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nc: bad address &#x27;product-service&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command terminated with exit code 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We&#x27;ve just enforced network policies to control traffic flow to and from pods within the demo application. At the same time, we should be able to access the pet shop app UI and order product normally.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuring-fqdn-filtering">Configuring FQDN Filtering<a href="#configuring-fqdn-filtering" class="hash-link" aria-label="Direct link to Configuring FQDN Filtering" title="Direct link to Configuring FQDN Filtering">​</a></h3>
<p>Using network policies, you can control traffic flow to and from your AKS cluster. This is traditionally been enforced based on IP addresses and ports. But what if you want to control traffic based on fully qualified domain names (FQDNs)? What if an application owner asks you to allow traffic to a specific domain like Microsoft Graph API?</p>
<p>This is where FQDN filtering comes in.</p>
<div class="info" data-title="Note"><blockquote>
<p>FQDN filtering is only available for clusters using Azure CNI Powered by Cilium.</p>
</blockquote></div>
<p>Let&#x27;s explore how we can apply FQDN-based network policies to control outbound access to specific domains.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="test-connectivity-1">Test Connectivity<a href="#test-connectivity-1" class="hash-link" aria-label="Direct link to Test Connectivity" title="Direct link to Test Connectivity">​</a></h4>
<p>Let&#x27;s start with testing the connection from the order-service to see if it can contact the Microsoft Graph API endpoint.</p>
<p>Run the following command to test the connection to the Microsoft Graph API from the order-service pod.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec -n pets -it $(kubectl get po -n pets -l app=order-service -ojsonpath=&#x27;{.items[0].metadata.name}&#x27;) -c order-service  -- sh -c &#x27;wget --spider --timeout=1 --tries=1 https://graph.microsoft.com&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As you can see the traffic is denied. This is an expected behavior because we have implemented zero trust security policy and denying any unwanted traffic.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-an-fqdn-policy">Create an FQDN Policy<a href="#create-an-fqdn-policy" class="hash-link" aria-label="Direct link to Create an FQDN Policy" title="Direct link to Create an FQDN Policy">​</a></h4>
<p>To limit egress to certain domains, apply an FQDN policy. This policy permits access only to specified URLs, ensuring controlled outbound traffic.</p>
<div class="info" data-title="Note"><blockquote>
<p>FQDN filtering requires ACNS to be enabled</p>
</blockquote></div>
<p>Run the following command to download the FQDN policy manifest file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -o acns-network-policy-fqdn.yaml https://gist.githubusercontent.com/pauldotyu/fd4cc689d9dcf8b0fd508620f3e6880d/raw/3e60c7e9bfb9ce5e7887ec7d81a6ca423002b14d/acns-network-policy-fqdn.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Take a look at the FQDN policy manifest file by running the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat acns-network-policy-fqdn.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -n pets -f acns-network-policy-fqdn.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="verify-fqdn-policy-enforcement">Verify FQDN Policy Enforcement<a href="#verify-fqdn-policy-enforcement" class="hash-link" aria-label="Direct link to Verify FQDN Policy Enforcement" title="Direct link to Verify FQDN Policy Enforcement">​</a></h4>
<p>Now if we try to access Microsoft Graph API from order-service app, that should be allowed.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec -n pets -it $(kubectl get po -n pets -l app=order-service -ojsonpath=&#x27;{.items[0].metadata.name}&#x27;) -c order-service  -- sh -c &#x27;wget --spider --timeout=1 --tries=1 https://graph.microsoft.com&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see output similar to the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Connecting to graph.microsoft.com (20.190.152.88:443)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connecting to developer.microsoft.com (23.45.149.11:443)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connecting to developer.microsoft.com (23.45.149.11:443)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remote file exists</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="monitoring-advanced-network-metrics-and-flows">Monitoring Advanced Network Metrics and Flows<a href="#monitoring-advanced-network-metrics-and-flows" class="hash-link" aria-label="Direct link to Monitoring Advanced Network Metrics and Flows" title="Direct link to Monitoring Advanced Network Metrics and Flows">​</a></h3>
<p>Advanced Container Networking Services (ACNS) provides deep visibility into your cluster&#x27;s network activity. This includes flow logs and deep visibility into your cluster&#x27;s network activity. All communications to and from pods are logged, allowing you to investigate connectivity issues over time</p>
<p>Using Azure Managed Grafana, you can visualize real-time data and gain insights into network traffic patterns, performance, and policy effectiveness.</p>
<p>What if a customer reports a problem in accessing the pets shop? How can you troubleshoot the issue?</p>
<p>We&#x27;ll work to simulate a problem and then use ACNS to troubleshoot the issue.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="introducing-chaos-to-test-container-networking">Introducing Chaos to Test container networking<a href="#introducing-chaos-to-test-container-networking" class="hash-link" aria-label="Direct link to Introducing Chaos to Test container networking" title="Direct link to Introducing Chaos to Test container networking">​</a></h4>
<p>Let&#x27;s start by applying a new network policy to cause some chaos in the network. This policy will drop incoming traffic to the store-front service.</p>
<p>Run the following command to download the chaos policy manifest file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -o acns-network-policy-chaos.yaml https://gist.githubusercontent.com/pauldotyu/9963e1301b8f3a460398b78a1e31ca84/raw/68f98f9a18dca5747248b434968e0074564a9c66/acns-network-policy-chaos.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to examine the chaos policy manifest file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat acns-network-policy-chaos.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to apply the chaos policy to the pets namespace.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -n pets -f acns-network-policy-chaos.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="access-grafana-dashboard">Access Grafana Dashboard<a href="#access-grafana-dashboard" class="hash-link" aria-label="Direct link to Access Grafana Dashboard" title="Direct link to Access Grafana Dashboard">​</a></h4>
<p>When you enabled Advanced Container Networking Services (ACNS) on your AKS cluster, you also enabled metrics collection. These metrics provide insights into traffic volume, dropped packets, number of connections, etc. The metrics are stored in Prometheus format and, as such, you can view them in Grafana.</p>
<p>Using your browser, navigate to <a href="https://aka.ms/publicportal" target="_blank" rel="noopener noreferrer">Azure Portal</a>, search for <strong>grafana</strong> resource, then click on the <strong>Azure Managed Grafana</strong> link under the <strong>Services</strong> section. Locate the Azure Managed Grafana resource that was created earlier in the workshop and click on it, then click on the URL next to <strong>Endpoint</strong> to open the Grafana dashboard.</p>
<p><img decoding="async" loading="lazy" alt="Azure Managed Grafana overview" src="/aks-labs/assets/images/acns-grafana-overview-65d74679f65da2710845a86d84664c61.png" width="2128" height="1101" class="img_ev3q"></p>
<p>Part of ACNS we provide pre-defined networking dashboards. Review the available dashboards</p>
<p><img decoding="async" loading="lazy" alt="ACNS dashboards in Grafana" src="/aks-labs/assets/images/acns-grafana-dashboards-b00da7b5e88c17761fea9752e15f4281.png" width="2223" height="1249" class="img_ev3q"></p>
<p>You can start with the <strong>Kubernetes / Networking / Clusters</strong> dashboard to get an over view of whats is happening in the cluster.</p>
<p><img decoding="async" loading="lazy" alt="ACNS networking clusters dashboard" src="/aks-labs/assets/images/acns-network-clusters-dashboard-f85f962653948ae0537bebc7906eabd7.png" width="2218" height="1261" class="img_ev3q"></p>
<p>Lets&#x27; change the view to the <strong>Kubernetes / Networking / Drops</strong>, select the <strong>pets</strong> namespace, and <strong>store-front</strong> workload</p>
<p><img decoding="async" loading="lazy" alt="ACNS networking drops dashboard" src="/aks-labs/assets/images/acns-drops-incoming-traffic-7b84e65fdba4de6a25585c1f7b5b9ebe.png" width="2224" height="1104" class="img_ev3q"></p>
<p>Now you can see increase in the dropped incoming traffic and the reason is &quot;policy_denied&quot; so now we now the reason that something was wrong with the network policy. let&#x27;s dive dipper and understand why this is happening</p>
<p>[Optional] Familiarize yourself with the other dashboards for DNS, and pod flows</p>
<table><thead><tr><th><img decoding="async" loading="lazy" alt="DNS Dashboard" src="/aks-labs/assets/images/acns-dns-dashboard-bae9485fa47e21803ac695e6a74680eb.png" width="2227" height="1006" class="img_ev3q"></th><th><img decoding="async" loading="lazy" alt="Pod Flows Dashboard" src="/aks-labs/assets/images/acns-pod-flows-dashboard-cbbeaa951fb897e0fdad4afb5f09160e.png" width="2225" height="1255" class="img_ev3q"></th></tr></thead></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="observe-network-flows-with-hubble">Observe network flows with hubble<a href="#observe-network-flows-with-hubble" class="hash-link" aria-label="Direct link to Observe network flows with hubble" title="Direct link to Observe network flows with hubble">​</a></h4>
<p>ACNS integrates with Hubble to provide flow logs and deep visibility into your cluster&#x27;s network activity. All communications to and from pods are logged allowing you to investigate connectivity issues over time.</p>
<p>But first we need to install Hubble CLI</p>
<p>Install Hubble CLI</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Set environment variables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export HUBBLE_VERSION=&quot;v0.11.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export HUBBLE_OS=&quot;$(uname | tr &#x27;[:upper:]&#x27; &#x27;[:lower:]&#x27;)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export HUBBLE_ARCH=&quot;$(uname -m)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#Install Hubble CLI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [ &quot;$(uname -m)&quot; = &quot;aarch64&quot; ]; then HUBBLE_ARCH=&quot;arm64&quot;; fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -L --fail --remote-name-all https://github.com/cilium/hubble/releases/download/${HUBBLE_VERSION}/hubble-${HUBBLE_OS}-${HUBBLE_ARCH}.tar.gz{,.sha256sum}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sha256sum --check hubble-${HUBBLE_OS}-${HUBBLE_ARCH}.tar.gz.sha256sum</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo tar xzvfC hubble-${HUBBLE_OS}-${HUBBLE_ARCH}.tar.gz /usr/local/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm hubble-${HUBBLE_OS}-${HUBBLE_ARCH}.tar.gz{,.sha256sum}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Port forward Hubble Relay using the kubectl port-forward command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl port-forward -n kube-system svc/hubble-relay --address 127.0.0.1 4245:443</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Move the port forward to the background by pressing <strong>Ctrl + z</strong> and then type <strong>bg</strong>.</p>
<p>Configure the client with hubble certificate</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/usr/bin/env bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -euo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Directory where certificates will be stored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CERT_DIR=&quot;$(pwd)/.certs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p &quot;$CERT_DIR&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">declare -A CERT_FILES=(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [&quot;tls.crt&quot;]=&quot;tls-client-cert-file&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [&quot;tls.key&quot;]=&quot;tls-client-key-file&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [&quot;ca.crt&quot;]=&quot;tls-ca-cert-files&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for FILE in &quot;${!CERT_FILES[@]}&quot;; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KEY=&quot;${CERT_FILES[$FILE]}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  JSONPATH=&quot;{.data[&#x27;${FILE//./\\.}&#x27;]}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Retrieve the secret and decode it</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubectl get secret hubble-relay-client-certs -n kube-system -o jsonpath=&quot;${JSONPATH}&quot; | base64 -d &gt; &quot;$CERT_DIR/$FILE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Set the appropriate hubble CLI config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hubble config set &quot;$KEY&quot; &quot;$CERT_DIR/$FILE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hubble config set tls true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hubble config set tls-server-name instance.hubble-relay.cilium.io</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Check Hubble pods are running using the <code>kubectl get pods</code> command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -o wide -n kube-system -l k8s-app=hubble-relay</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Your output should look similar to the following example output:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NAME                            READY   STATUS    RESTARTS   AGE    IP            NODE                                 NOMINATED NODE   READINESS GATES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hubble-relay-7ff97868ff-tvwcf   1/1     Running   0          101m   10.244.2.57   aks-systempool-10200747-vmss000000   &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Using hubble we will look for what is dropped.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hubble observe --verdict DROPPED</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here we can see traffic coming from world dropped in store-front</p>
<p><img decoding="async" loading="lazy" alt="Hubble CLI" src="/aks-labs/assets/images/acns-hubble-cli-0bac337d018b8e38a9d9838e62088fe6.png" width="2223" height="339" class="img_ev3q"></p>
<p>So now we can tell that there is a problem with the frontend ingress traffic configuration, let&#x27;s review the <strong>allow-store-front-traffic</strong> policy</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe -n pets cnp allow-store-front-traffic</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here we go, we see that the Ingress traffic is not allowed</p>
<p><img decoding="async" loading="lazy" alt="Ingress traffic not allowed" src="/aks-labs/assets/images/acns-policy-output-b481816dc18cfe42abe4ed26a3a54fa5.png" width="815" height="606" class="img_ev3q"></p>
<p>Now to solve the problem we will apply the original policy.</p>
<p>Run the following command to apply the original network policy to the pets namespace.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -o acns-network-policy-allow-store-front-traffic.yaml https://gist.githubusercontent.com/pauldotyu/013c496a3b26805ca213b5858d69e07c/raw/e7c7eb7d9bd2799a59eb66db9191c248435f2db4/acns-network-policy-allow-store-front-traffic.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>View the contents of the network policy manifest file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat acns-network-policy-allow-store-front-traffic.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Apply the network policy to the pets namespace.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -n pets -f acns-network-policy-allow-store-front-traffic.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should now see the traffic flowing again and you are able to access the pets shop app UI.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="visualize-traffic-with-hubble-ui">Visualize traffic with Hubble UI<a href="#visualize-traffic-with-hubble-ui" class="hash-link" aria-label="Direct link to Visualize traffic with Hubble UI" title="Direct link to Visualize traffic with Hubble UI">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="install-hubble-ui">Install Hubble UI<a href="#install-hubble-ui" class="hash-link" aria-label="Direct link to Install Hubble UI" title="Direct link to Install Hubble UI">​</a></h4>
<p>Run the following command to download the Hubble UI manifest file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -o acns-hubble-ui.yaml https://gist.githubusercontent.com/pauldotyu/0daaba9833a714dc28ed0032158fb6fe/raw/801f9981a65009ed53e6596d06a9a8e73286ed21/acns-hubble-ui.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Optionally, run the following command to take a look at the Hubble UI manifest file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat acns-hubble-ui.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Apply the hubble-ui.yaml manifest to your cluster, using the following command</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f acns-hubble-ui.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="forward-hubble-relay-traffic">Forward Hubble Relay Traffic<a href="#forward-hubble-relay-traffic" class="hash-link" aria-label="Direct link to Forward Hubble Relay Traffic" title="Direct link to Forward Hubble Relay Traffic">​</a></h4>
<p>Set up port forwarding for Hubble UI using the kubectl port-forward command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n kube-system port-forward svc/hubble-ui 12000:80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="access-hubble-ui">Access Hubble UI<a href="#access-hubble-ui" class="hash-link" aria-label="Direct link to Access Hubble UI" title="Direct link to Access Hubble UI">​</a></h4>
<p>Access Hubble UI by entering <a href="http://localhost:12000/" target="_blank" rel="noopener noreferrer">http://localhost:12000/</a> into your web browser.</p>
<p><img decoding="async" loading="lazy" alt="Accessing the Hubble UI" src="/aks-labs/assets/images/acns-hubble-ui-4c81ec1966dbbf29ad05ce55c60609cd.png" width="1696" height="1341" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="istio-service-mesh">Istio Service Mesh<a href="#istio-service-mesh" class="hash-link" aria-label="Direct link to Istio Service Mesh" title="Direct link to Istio Service Mesh">​</a></h3>
<div class="important" data-title="Important"><blockquote>
<p>If you have implemented the CiliumNetworkPolicy manifests from the previous sections, you will need to remove them with the following command before proceeding with the Istio service mesh.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete ciliumnetworkpolicy -n pets --all</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</blockquote></div>
<p>Istio is an open-source service mesh that layers transparently onto existing distributed applications. Istio’s powerful features provide a uniform and more efficient way to secure, connect, and monitor services. Istio enables load balancing, service-to-service authentication, and monitoring – with few or no service code changes. Its powerful control plane brings vital features, including:</p>
<ul>
<li>Secure service-to-service communication in a cluster with TLS (Transport Layer Security) encryption, strong identity-based authentication, and authorization.</li>
<li>Automatic load balancing for HTTP, gRPC, WebSocket, and TCP traffic.</li>
<li>Fine-grained control of traffic behavior with rich routing rules, retries, failovers, and fault injection.</li>
<li>A pluggable policy layer and configuration API supporting access controls, rate limits, and quotas.</li>
<li>Automatic metrics, logs, and traces for all traffic within a cluster, including cluster ingress and egress.</li>
</ul>
<p>Istio is integrated with AKS as an addon and is supported alongside AKS.</p>
<div class="info" data-title="Note"><blockquote>
<p>Please be aware that the Istio addon for AKS does not provide the full functionality of the Istio upstream project. You can view the current limitations for this AKS Istio addon <a href="https://learn.microsoft.com/azure/aks/istio-about#limitations" target="_blank" rel="noopener noreferrer">here</a> and what is currently <a href="https://learn.microsoft.com/azure/aks/istio-meshconfig#allowed-supported-and-blocked-meshconfig-values" target="_blank" rel="noopener noreferrer">Allowed, supported, and blocked MeshConfig values</a></p>
</blockquote></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="configure-ca-certificates">Configure CA certificates<a href="#configure-ca-certificates" class="hash-link" aria-label="Direct link to Configure CA certificates" title="Direct link to Configure CA certificates">​</a></h4>
<p>In the Istio-based service mesh addon for Azure Kubernetes Service, by default the Istio certificate authority (CA) generates a self-signed root certificate and key and uses them to sign the workload certificates. To protect the root CA key, you should use a root CA which runs on a secure machine offline.</p>
<p>In this lab, we will create our own root CA, along with an intermediate CA, and configure the Istio addon to issue intermediate certificates to the Istio CAs that run in each cluster. An Istio CA can sign workload certificates using the administrator-specified certificate and key, and distribute an administrator-specified root certificate to the workloads as the root of trust.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="clone-the-istio-repo">Clone the Istio Repo<a href="#clone-the-istio-repo" class="hash-link" aria-label="Direct link to Clone the Istio Repo" title="Direct link to Clone the Istio Repo">​</a></h5>
<p>To expedite the process of creating the necessary certificates needed, we will leverage the certificate tooling provided by the Istio open-source project.</p>
<p>In your terminal, run the following command to clone the Istio repository.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/istio/istio.git</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="generate-the-root-and-intermediate-ca-certificates">Generate the Root and Intermediate CA certificates<a href="#generate-the-root-and-intermediate-ca-certificates" class="hash-link" aria-label="Direct link to Generate the Root and Intermediate CA certificates" title="Direct link to Generate the Root and Intermediate CA certificates">​</a></h5>
<p>Navigate into the recently cloned Istio directory.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd istio</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once in the <strong>istio</strong> directory, create the <strong>akslab-certs</strong> directory and navigate into it.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p akslab-certs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pushd akslab-certs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Generate the root certificate and key.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make -f ../tools/certs/Makefile.selfsigned.mk root-ca</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Generate the intermediate certificate and key</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make -f ../tools/certs/Makefile.selfsigned.mk intermediate-cacerts</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will create a directory called <strong>intermediate</strong> which will contain the intermediate CA certificate information.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="add-the-ca-certificates-to-azure-key-vault">Add the CA Certificates to Azure Key Vault<a href="#add-the-ca-certificates-to-azure-key-vault" class="hash-link" aria-label="Direct link to Add the CA Certificates to Azure Key Vault" title="Direct link to Add the CA Certificates to Azure Key Vault">​</a></h4>
<p>We will utilize Azure KeyVault to store the root and intermediate CA certificate information.</p>
<p>In the <strong>akslab-certs</strong> directory, run the following commands.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az keyvault secret set --vault-name ${AKV_NAME} --name istio-root-cert --file root-cert.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az keyvault secret set --vault-name ${AKV_NAME} --name istio-intermediate-cert --file ./intermediate/ca-cert.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az keyvault secret set --vault-name ${AKV_NAME} --name istio-intermediate-key --file ./intermediate/ca-key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az keyvault secret set --vault-name ${AKV_NAME} --name istio-cert-chain --file ./intermediate/cert-chain.pem</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="enable-azure-key-vault-provider-for-secret-store-csi-driver-for-your-cluster">Enable Azure Key Vault provider for Secret Store CSI Driver for your cluster<a href="#enable-azure-key-vault-provider-for-secret-store-csi-driver-for-your-cluster" class="hash-link" aria-label="Direct link to Enable Azure Key Vault provider for Secret Store CSI Driver for your cluster" title="Direct link to Enable Azure Key Vault provider for Secret Store CSI Driver for your cluster">​</a></h4>
<p>The Azure Key Vault provider for Secrets Store CSI Driver allows for the integration of an Azure Key Vault as a secret store with an Azure Kubernetes Service (AKS) cluster via a <a href="https://kubernetes-csi.github.io/docs/" target="_blank" rel="noopener noreferrer">CSI volume</a>.</p>
<p>This integration will allow AKS to create, store, and retrieve Kubernetes secrets from Azure Key Vault.</p>
<p>Run the following command to enable the AKS Azure Key Vault secrets provider.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks enable-addons \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--addons azure-keyvault-secrets-provider \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorize-the-user-assigned-managed-identity-of-the-aks-azure-key-vault-provider-add-on-to-have-access-to-azure-key-vault">Authorize the user-assigned managed identity of the AKS Azure Key Vault provider add-on to have access to Azure Key Vault<a href="#authorize-the-user-assigned-managed-identity-of-the-aks-azure-key-vault-provider-add-on-to-have-access-to-azure-key-vault" class="hash-link" aria-label="Direct link to Authorize the user-assigned managed identity of the AKS Azure Key Vault provider add-on to have access to Azure Key Vault" title="Direct link to Authorize the user-assigned managed identity of the AKS Azure Key Vault provider add-on to have access to Azure Key Vault">​</a></h4>
<div class="info" data-title="Note"><blockquote>
<p>For the purposes of this lab, we are using the <strong>Key Vault Administrator</strong> role. Please consider a role with lesser privileges for accessing Azure Key Vault in a production environment.</p>
</blockquote></div>
<p>When you enable the Azure Key Vault provider for the AKS cluster, a user-assigned managed identity is created for the cluster. We will provide the managed identity with access to Azure Key Vault to retrieve the CA certificate information needed when we deploy the AKS Istio addon.</p>
<p>Run the following commands to add an Azure role assignment for Key Vault administrator for the add-on&#x27;s user-assigned managed identity.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">OBJECT_ID=$(az aks show \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query &#x27;addonProfiles.azureKeyvaultSecretsProvider.identity.objectId&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-o tsv)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az role assignment create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--role &quot;Key Vault Administrator&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--assignee-object-id ${OBJECT_ID} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--assignee-principal-type ServicePrincipal \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--scope ${AKV_ID}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-istio-service-mesh-add-on-with-plug-in-ca-certificates">Deploy Istio service mesh add-on with plug-in CA certificates<a href="#deploy-istio-service-mesh-add-on-with-plug-in-ca-certificates" class="hash-link" aria-label="Direct link to Deploy Istio service mesh add-on with plug-in CA certificates" title="Direct link to Deploy Istio service mesh add-on with plug-in CA certificates">​</a></h4>
<p>Before deploying the AKS Istio add-on, check the revision of Istio to ensure it is compatible with the version of Kubernetes on the cluster. To check the available revisions in the region that the AKS cluster is deployed in, run the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks mesh get-revisions \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--location ${LOCATION} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output table</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see the available revisions for the AKS Istio add-on and the compatible versions of Kubernetes they support.</p>
<p>Run the following command to enable the default supported revision of the AKS Istio add-on for the AKS cluster, using the CA certificate information created earlier.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks mesh enable \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--key-vault-id ${AKV_ID} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--root-cert-object-name istio-root-cert \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ca-cert-object-name istio-intermediate-cert \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ca-key-object-name istio-intermediate-key \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cert-chain-object-name istio-cert-chain</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="info" data-title="Note"><blockquote>
<p>This may take several minutes to complete.</p>
</blockquote></div>
<p>Once the service mesh has been enabled, run the following command to view the Istio pods on the cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -n aks-istio-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="enable-sidecar-injection">Enable Sidecar Injection<a href="#enable-sidecar-injection" class="hash-link" aria-label="Direct link to Enable Sidecar Injection" title="Direct link to Enable Sidecar Injection">​</a></h4>
<p>Service meshes traditionally work by deploying an additional container within the same pod as your application container. These additional containers are referred to as a sidecar or a sidecar proxy. These sidecar proxies receive policy and configuration from the service mesh control plane, and insert themselves in the communication path of your application to control the traffic to and from your application container.</p>
<p>The first step to onboarding your application into a service mesh, is to enable sidecar injection for your application pods. To control which applications are onboarded to the service mesh, we can target specific Kubernetes namespaces where applications are deployed.</p>
<div class="info" data-title="Note"><blockquote>
<p>For upgrade scenarios, it is possible to run multiple Istio add-on control planes with different versions. The following command enables sidecar injection for the Istio revision <strong>asm-1-22</strong>. If you are not sure which revision is installed on the cluster, you can run the following command <code>az aks show --resource-group ${RG_NAME} --name ${AKS_NAME}  --query &quot;serviceMeshProfile.istio.revisions&quot;</code></p>
</blockquote></div>
<p>The following command will enable the AKS Istio add-on sidecar injection for the <strong>pets</strong> namespace for the Istio revision <strong>1.22</strong>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl label namespace pets istio.io/rev=asm-1-22</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>At this point, we have simply just labeled the namespace, instructing the Istio control plane to enable sidecar injection on new deployments into the namespace. Since we have existing deployments in the namespace already, we will need to restart the deployments to trigger the sidecar injection.</p>
<p>Get a list of all the current pods running in the <strong>pets</strong> namespace.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -n pets</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You&#x27;ll notice that each pod listed has a <strong>READY</strong> state of <strong>1/1</strong>. This means there is one container (the application container) per pod. We will restart the deployments to have the Istio sidecar proxies injected into each pod.</p>
<p>Restart the deployments for the <strong>order-service</strong>, <strong>product-service</strong>, and <strong>store-front</strong>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deployment order-service -n pets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deployment product-service -n pets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deployment store-front -n pets</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If we re-run the get pods command for the <strong>pets</strong> namespace, you will notice all of the pods now have a <strong>READY</strong> state of <strong>2/2</strong>, meaning the pods now include the sidecar proxy for Istio. The RabbitMQ for the AKS Store application is not a Kubernetes deployment, but is a stateful set. We will need to redeploy the RabbitMQ stateful set to get the sidecar proxy injection.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart statefulset rabbitmq -n pets</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you again re-run the get pods command for the <strong>pets</strong> namespace, we&#x27;ll see all the pods with a <strong>READY</strong> state of <strong>2/2</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -n pets</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="verify-the-istio-mesh-is-controlling-mesh-communications">Verify the Istio Mesh is Controlling Mesh Communications<a href="#verify-the-istio-mesh-is-controlling-mesh-communications" class="hash-link" aria-label="Direct link to Verify the Istio Mesh is Controlling Mesh Communications" title="Direct link to Verify the Istio Mesh is Controlling Mesh Communications">​</a></h4>
<p>We will walk through some common configurations to ensure the communications for the AKS Store application are secured. To begin we will deploy a Curl utility container to the cluster, so we can execute traffic commands from it to test out the Istio mesh policy.</p>
<p>Use the following command to deploy a test pod that will run the <strong>curl</strong> image to the <strong>default</strong> namespace of the cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: curl-deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: curlimages/curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        command: [&quot;sleep&quot;, &quot;3600&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can verify the deployment of the test pod in the <strong>default</strong> namespace using following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -n default</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Wait for the test pod to be in a <strong>Running</strong> state.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="configure-mtls-strict-mode-for-the-pets-namespace">Configure mTLS Strict Mode for the pets namespace<a href="#configure-mtls-strict-mode-for-the-pets-namespace" class="hash-link" aria-label="Direct link to Configure mTLS Strict Mode for the pets namespace" title="Direct link to Configure mTLS Strict Mode for the pets namespace">​</a></h5>
<p>Currently Istio configures managed workloads to use mTLS when calling other workloads, but the default permissive mode allows a service to accept traffic in both plaintext or mTLS traffic. To ensure that the workloads we manage with the Istio add-on only accept mTLS communication, we will deploy a Peer Authentication policy to enforce only mTLS traffic for the workloads in the <strong>pets</strong> namespace.</p>
<p>Prior to deploying the mTLS strict mode, let&#x27;s verify that the <strong>store-front</strong> service will respond to a client not using mTLS. We will invoke a call from the test pod to the <strong>store-front</strong> service and see if we get a response.</p>
<p>Run the following command to get the name of the test pod.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CURL_POD_NAME=&quot;$(kubectl get pod -l app=curl -o jsonpath=&quot;{.items[0].metadata.name}&quot;)&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to run a curl command from the test pod to the <strong>store-front</strong> service.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec -it ${CURL_POD_NAME} -- curl -IL store-front.pets.svc.cluster.local:80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see a response with a status of <strong>HTTP/1.1 200 OK</strong> indicating that the <strong>store-front</strong> service successfully responded to the client Let&#x27;s now apply the Peer Authentication policy that will enforce all services in the <strong>pets</strong> namespace to only use mTLS communication.</p>
<p>Run the following command to configure the mTLS Peer Authentication policy.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -n pets -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: security.istio.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: PeerAuthentication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: pets-default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: pets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mtls:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode: STRICT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once the mTLS strict mode peer authentication policy has been applied, we will now see if we can again get a response back from the <strong>store-front</strong> service from a client not using mTLS. Run the following command to curl to the <strong>store-front</strong> service again.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec -it ${CURL_POD_NAME} -- curl -IL store-front.pets.svc.cluster.local:80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Notice that the curl client failed to get a response from the <strong>store-front</strong> service. The error returned is the indication that the mTLS policy has been enforced, and that the <strong>store-front</strong> service has rejected the non mTLS communication from the test pod.</p>
<p>To verify that the <strong>store-front</strong> service is still accessible for pods in the <strong>pets</strong> namespace where the mTLS Peer Authentication policy is deployed, we will again deploy the <strong>curl</strong> image utility pod in the <strong>pets</strong> namespace. That pod will automatically get the sidecar injection of the Istio proxy, along with the policy that will enable it to securely communicate to the <strong>store-front</strong> service.</p>
<p>Use the following command to deploy the test pod that will run the <strong>curl</strong> image to the <strong>pets</strong> namespace of the cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: curl-pets-deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: pets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: curlimages/curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        command: [&quot;sleep&quot;, &quot;3600&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can again verify the deployment of the test pod in the <strong>pets</strong> namespace using following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -n pets | grep curl</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Wait for the test pod to be in a <strong>Running</strong> state, and notice the <strong>READY</strong> state, which should have a status of <strong>2/2</strong>.</p>
<p>Run the following command to get the name of the test pod in the <strong>pets</strong> namespace.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CURL_PETS_POD_NAME=&quot;$(kubectl get pod -n pets -l app=curl -o jsonpath=&quot;{.items[0].metadata.name}&quot;)&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to run a curl command from the test pod in the <strong>pets</strong> namespace to the <strong>store-front</strong> service.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec -it ${CURL_PETS_POD_NAME} -n pets -- curl -IL store-front.pets.svc.cluster.local:80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see a response with a status of <strong>HTTP/1.1 200 OK</strong> indicating that the <strong>store-front</strong> service successfully responded to the client in the <strong>pets</strong> namespace using only mTLS communication.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="advanced-storage-concepts">Advanced Storage Concepts<a href="#advanced-storage-concepts" class="hash-link" aria-label="Direct link to Advanced Storage Concepts" title="Direct link to Advanced Storage Concepts">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="storage-options">Storage Options<a href="#storage-options" class="hash-link" aria-label="Direct link to Storage Options" title="Direct link to Storage Options">​</a></h3>
<p>Azure offers rich set of storage options that can be categorized into two buckets: Block Storage and Shared File Storage. You can choose the best match option based on the workload requirements. The following guidance can facilitate your evaluation:</p>
<ul>
<li>
<p>Select storage category based on the attach mode.
Block Storage can be attached to a single node one time (RWO: Read Write Once), while Shared File Storage can be attached to different nodes one time (RWX: Read Write Many). If you need to access the same file from different nodes, you would need Shared File Storage.</p>
</li>
<li>
<p>Select a storage option in each category based on characteristics and user cases.</p>
<p><strong>Block storage category:</strong></p>
<table><thead><tr><th style="text-align:center">Storage option</th><th style="text-align:center">Characteristics</th><th style="text-align:center">User Cases</th></tr></thead><tbody><tr><td style="text-align:center"><a href="https://learn.microsoft.com/azure/virtual-machines/managed-disks-overview" target="_blank" rel="noopener noreferrer">Azure Disks</a></td><td style="text-align:center">Rich SKUs from low-cost HDD disks to high performance Ultra Disks.</td><td style="text-align:center">Generic option for all user cases from Backup to database to SAP Hana.</td></tr><tr><td style="text-align:center"><a href="https://learn.microsoft.com/azure/storage/elastic-san/elastic-san-introduction" target="_blank" rel="noopener noreferrer">Elastic SAN</a></td><td style="text-align:center">Scalability up to millions of IOPS, Cost efficiency at scale</td><td style="text-align:center">Tier 1 &amp; 2 workloads, Databases, VDI hosted on any Compute options (VM, Containers, AVS)</td></tr><tr><td style="text-align:center"><a href="https://learn.microsoft.com/azure/virtual-machines/nvme-overview" target="_blank" rel="noopener noreferrer">Local Disks</a></td><td style="text-align:center">Priced in VM, High IOPS/Throughput and extremely low latency.</td><td style="text-align:center">Applications with no data durability requirement or with built-in data replication support (e.g., Cassandra), AI training</td></tr></tbody></table>
<p><strong>Shared File Storage category:</strong></p>
<table><thead><tr><th style="text-align:center">Storage option</th><th style="text-align:center">Characteristics</th><th style="text-align:center">User Cases</th></tr></thead><tbody><tr><td style="text-align:center"><a href="https://learn.microsoft.com/azure/storage/files/storage-files-introduction" target="_blank" rel="noopener noreferrer">Azure Files</a></td><td style="text-align:center">Fully managed, multiple redundancy options.</td><td style="text-align:center">General purpose file shares, LOB apps, shared app or config data for CI/CD, AI/ML.</td></tr><tr><td style="text-align:center"><a href="https://learn.microsoft.com/azure/azure-netapp-files/azure-netapp-files-introduction" target="_blank" rel="noopener noreferrer">Azure NetApp Files</a></td><td style="text-align:center">Fully managed ONTAP with high performance and low latency.</td><td style="text-align:center">Analytics, HPC, CMS, CI/CD, custom apps currently using NetApp.</td></tr><tr><td style="text-align:center"><a href="https://learn.microsoft.com/azure/storage/blobs/storage-blobs-introduction" target="_blank" rel="noopener noreferrer">Azure Blobs</a></td><td style="text-align:center">Unlimited amounts of unstructured data, data lifecycle management, rich redundancy options.</td><td style="text-align:center">Large scale of object data handling, backup</td></tr></tbody></table>
</li>
<li>
<p>Select performance tier, redundancy type on the storage option.
See the product page from above table for further evaluation of performance tier, redundancy type or other requirements.</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="orchestration-options">Orchestration Options<a href="#orchestration-options" class="hash-link" aria-label="Direct link to Orchestration Options" title="Direct link to Orchestration Options">​</a></h3>
<p>Besides invoking service REST API to ingest remote storage resources, there are two major ways to use storage options in AKS workloads: CSI (Container Storage Interface) drivers and Azure Container Storage.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="csi-drivers">CSI Drivers<a href="#csi-drivers" class="hash-link" aria-label="Direct link to CSI Drivers" title="Direct link to CSI Drivers">​</a></h4>
<p>Container Storage Interface is industry standard that enables storage vendors (SP) to develop a plugin once and have it work across a number of container orchestration systems. It’s widely adopted by both OSS community and major cloud storage vendors. If you already build storage management and operation with CSI drivers, or you plan to build cloud independent k8s cluster setup, it’s the preferred option.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="azure-container-storage">Azure Container Storage<a href="#azure-container-storage" class="hash-link" aria-label="Direct link to Azure Container Storage" title="Direct link to Azure Container Storage">​</a></h4>
<p>Azure Container Storage is built on top of CSI drivers to support greater scaling capability with storage pool and unified management experience across local &amp; remote storage. If you want to simplify the use of local NVMe disks, or achieve higher pod scaling target,​ it’s the preferred option.</p>
<p>Storage option support on CSI drivers and Azure Container Storage:</p>
<table><thead><tr><th style="text-align:center">Storage option</th><th style="text-align:center">CSI drivers</th><th style="text-align:center">Azure Container Storage</th></tr></thead><tbody><tr><td style="text-align:center"><a href="https://learn.microsoft.com/azure/virtual-machines/managed-disks-overview" target="_blank" rel="noopener noreferrer">Azure Disks</a></td><td style="text-align:center">Support(<a href="https://learn.microsoft.com/azure/aks/azure-disk-csi" target="_blank" rel="noopener noreferrer">CSI disks driver</a>)</td><td style="text-align:center">Support</td></tr><tr><td style="text-align:center"><a href="https://learn.microsoft.com/azure/storage/elastic-san/elastic-san-introduction" target="_blank" rel="noopener noreferrer">Elastic SAN</a></td><td style="text-align:center">N/A</td><td style="text-align:center">Support</td></tr><tr><td style="text-align:center"><a href="https://learn.microsoft.com/azure/virtual-machines/nvme-overview" target="_blank" rel="noopener noreferrer">Local Disks</a></td><td style="text-align:center">N/A (Host Path + Static Provisioner)</td><td style="text-align:center">Support</td></tr><tr><td style="text-align:center"><a href="https://learn.microsoft.com/azure/storage/files/storage-files-introduction" target="_blank" rel="noopener noreferrer">Azure Files</a></td><td style="text-align:center">Support(<a href="https://learn.microsoft.com/azure/aks/azure-files-csi" target="_blank" rel="noopener noreferrer">CSI files driver</a>)</td><td style="text-align:center">N/A</td></tr><tr><td style="text-align:center"><a href="https://learn.microsoft.com/azure/azure-netapp-files/azure-netapp-files-introduction" target="_blank" rel="noopener noreferrer">Azure NetApp Files</a></td><td style="text-align:center">Support(<a href="https://learn.microsoft.com/azure/aks/azure-netapp-files-nfs" target="_blank" rel="noopener noreferrer">CSI NetApp driver</a>)</td><td style="text-align:center">N/A</td></tr><tr><td style="text-align:center"><a href="https://learn.microsoft.com/azure/storage/blobs/storage-blobs-introduction" target="_blank" rel="noopener noreferrer">Azure Blobs</a></td><td style="text-align:center">Support(<a href="https://learn.microsoft.com/azure/aks/azure-blob-csi?tabs=NFS" target="_blank" rel="noopener noreferrer">CSI Blobs driver</a>)</td><td style="text-align:center">N/A</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="use-azure-container-storage-for-replicated-ephemeral-nvme-disk">Use Azure Container Storage for Replicated Ephemeral NVMe Disk<a href="#use-azure-container-storage-for-replicated-ephemeral-nvme-disk" class="hash-link" aria-label="Direct link to Use Azure Container Storage for Replicated Ephemeral NVMe Disk" title="Direct link to Use Azure Container Storage for Replicated Ephemeral NVMe Disk">​</a></h3>
<p>Deploy a MySQL Server to mount volumes using local NVMe storage via Azure Container Storage and demonstrate replication and failover of replicated local NVMe storage in Azure Container Storage.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="setup-azure-container-storage">Setup Azure Container Storage<a href="#setup-azure-container-storage" class="hash-link" aria-label="Direct link to Setup Azure Container Storage" title="Direct link to Setup Azure Container Storage">​</a></h4>
<p>Follow the below steps to enable Azure Container Storage in an existing AKS cluster</p>
<p>Run the following command to set the new node pool name.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt;&gt; .env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ACSTOR_NODEPOOL_NAME=&quot;acstorpool&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source .env</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to create a new node pool with <strong>Standard_L8s_v3</strong> VMs.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks nodepool add \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster-name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${ACSTOR_NODEPOOL_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--node-vm-size Standard_L8s_v3 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--node-count 3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="warning" data-title="Warning"><blockquote>
<p>You may or may not have enough quota to deploy Standard_L8s_v3 VMs. If you encounter an error, please try with a different VM size within the <a href="https://learn.microsoft.com/azure/virtual-machines/sizes/storage-optimized/lsv2-series?tabs=sizebasic" target="_blank" rel="noopener noreferrer">L-family</a> or request additional quota by following the instructions <a href="https://docs.microsoft.com/azure/azure-portal/supportability/resource-manager-core-quotas-request" target="_blank" rel="noopener noreferrer">here</a>.</p>
</blockquote></div>
<p>Update the cluster to enable Azure Container Storage.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks update \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--enable-azure-container-storage ephemeralDisk \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--azure-container-storage-nodepools ${ACSTOR_NODEPOOL_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--storage-pool-option NVMe \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ephemeral-disk-volume-type PersistentVolumeWithAnnotation</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="info" data-title="Note"><blockquote>
<p>This command can take up to 20 minutes to complete.</p>
</blockquote></div>
<p>Run the following command and wait until all the pods reaches <strong>Running</strong> state.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -n acstor --watch</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="info" data-title="Note"><blockquote>
<p>You will see a lot of activity with pods being created, completed, and terminated. This is expected as the Azure Container Storage is being enabled.</p>
</blockquote></div>
<p>Delete the default storage pool created.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete sp -n acstor ephemeraldisk-nvme</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-replicated-ephemeral-storage-pool">Create a replicated ephemeral storage pool<a href="#create-a-replicated-ephemeral-storage-pool" class="hash-link" aria-label="Direct link to Create a replicated ephemeral storage pool" title="Direct link to Create a replicated ephemeral storage pool">​</a></h4>
<p>With Azure Container Storage enabled, storage pools can also be created using Kubernetes CRDs. Run the following command to deploy a new StoragePool custom resource. This will create a new storage class using the storage pool name prefixed with <strong>acstor-</strong>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: containerstorage.azure.com/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: StoragePool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: ephemeraldisk-nvme</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: acstor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  poolType:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ephemeralDisk:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      diskType: nvme</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      replicas: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now you should see the new storage class called <strong>acstor-ephemeraldisk-nvme</strong> has been created.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get sc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-a-mysql-server-using-new-storage-class">Deploy a MySQL server using new storage class<a href="#deploy-a-mysql-server-using-new-storage-class" class="hash-link" aria-label="Direct link to Deploy a MySQL server using new storage class" title="Direct link to Deploy a MySQL server using new storage class">​</a></h4>
<p>This setup is a modified version of <a href="https://kubernetes.io/docs/tasks/run-application/run-replicated-stateful-application/" target="_blank" rel="noopener noreferrer">this guide</a>.</p>
<p>Run the following command to download the MySQL manifest file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -o acstor-mysql-config-services.yaml https://gist.githubusercontent.com/pauldotyu/f459c834558fd83a6254fae0eb23b1e6/raw/ad1b5db804060b18b3ea123db9189f1a2d56414b/acstor-mysql-config-services.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Optionally, run the following command to take a look at the MySQL manifest file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat acstor-mysql-config-services.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to deploy the config map and services for the MySQL server.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f acstor-mysql-config-services.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, we&#x27;ll deploy the MySQL server using the new storage class.</p>
<p>Run the following command to download the MySQL statefulset manifest file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -o acstor-mysql-statefulset.yaml https://gist.githubusercontent.com/pauldotyu/f7539f4fc991cf5fc3ecb22383cb227c/raw/274b0747f1094db53869bcb0eb25faccf0f37a6a/acstor-mysql-statefulset.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Optionally, run the following command to take a look at the MySQL statefulset manifest file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat acstor-mysql-statefulset.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to deploy the statefulset for MySQL server.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f acstor-mysql-statefulset.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="verify-that-all-the-mysql-servers-components-are-available">Verify that all the MySQL server&#x27;s components are available<a href="#verify-that-all-the-mysql-servers-components-are-available" class="hash-link" aria-label="Direct link to Verify that all the MySQL server&#x27;s components are available" title="Direct link to Verify that all the MySQL server&#x27;s components are available">​</a></h4>
<p>Run the following command to verify that both mysql services were created (headless one for the statefulset and mysql-read for the reads).</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get svc -l app=mysql</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see output similar to the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql        ClusterIP   None           &lt;none&gt;        3306/TCP   5h43m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql-read   ClusterIP   10.0.205.191   &lt;none&gt;        3306/TCP   5h43m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to verify that MySql server pod is running. Add the <strong>--watch</strong> to wait and watch until the pod goes from Init to <strong>Running</strong> state.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -l app=mysql -o wide --watch</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see output similar to the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NAME      READY   STATUS    RESTARTS   AGE   IP             NODE                                NOMINATED NODE   READINESS GATES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql-0   2/2     Running   0          1m34s  10.244.3.16   aks-nodepool1-28567125-vmss000003   &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="info" data-title="Note"><blockquote>
<p>Keep a note of the node on which the <strong>mysql-0</strong> pod is running.</p>
</blockquote></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="inject-data-to-the-mysql-database">Inject data to the MySql database<a href="#inject-data-to-the-mysql-database" class="hash-link" aria-label="Direct link to Inject data to the MySql database" title="Direct link to Inject data to the MySql database">​</a></h4>
<p>Run the following command to run and exec into a mysql client pod to the create a database named <strong>school</strong> and a table <strong>students</strong>. Also, make a few entries in the table to verify persistence.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl run mysql-client --image=mysql:5.7 -i --rm --restart=Never -- \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql -h mysql-0.mysql &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE DATABASE school;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE school.students (RollNumber INT, Name VARCHAR(250));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO school.students VALUES (1, &#x27;Student1&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO school.students VALUES (2, &#x27;Student2&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="verify-the-entries-in-the-mysql-server">Verify the entries in the MySQL server<a href="#verify-the-entries-in-the-mysql-server" class="hash-link" aria-label="Direct link to Verify the entries in the MySQL server" title="Direct link to Verify the entries in the MySQL server">​</a></h4>
<p>Run the following command to verify the creation of database, table, and entries.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl run mysql-client --image=mysql:5.7 -i -t --rm --restart=Never -- \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql -h mysql-read -e &quot;SELECT * FROM school.students&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see output similar to the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RollNumber | Name     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|          1 | Student1 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|          2 | Student2 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------+----------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="initiate-the-node-failover">Initiate the node failover<a href="#initiate-the-node-failover" class="hash-link" aria-label="Direct link to Initiate the node failover" title="Direct link to Initiate the node failover">​</a></h4>
<p>Now we will simulate a failover scenario by deleting the node on which the <code>mysql-0</code> pod is running.</p>
<p>Run the following command to get the current node count in the Azure Container Storage node pool.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NODE_COUNT=$(az aks nodepool show \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster-name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${ACSTOR_NODEPOOL_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query count \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output tsv)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to scale up the Azure Container Storage node pool by 1 node.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks nodepool scale \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster-name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${ACSTOR_NODEPOOL_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--node-count $((NODE_COUNT+1)) \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--no-wait</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now we want to force the failover by deleting the node on which the <strong>mysql-0</strong> pod is running.</p>
<p>Run the following commands to get the name of the node on which the <strong>mysql-0</strong> pod is running.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POD_NAME=$(kubectl get pods -l app=mysql -o custom-columns=&quot;:metadata.name&quot; --no-headers)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NODE_NAME=$(kubectl get pods $POD_NAME -o jsonpath=&#x27;{.spec.nodeName}&#x27;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to delete the node on which the <strong>mysql-0</strong> pod is running.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete node $NODE_NAME</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="observe-that-the-mysql-pods-are-running">Observe that the mysql pods are running<a href="#observe-that-the-mysql-pods-are-running" class="hash-link" aria-label="Direct link to Observe that the mysql pods are running" title="Direct link to Observe that the mysql pods are running">​</a></h4>
<p>Run the following command to get the pods and observe that the <strong>mysql-0</strong> pod is running on a different node.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -l app=mysql -o wide --watch</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Eventually you should see output similar to the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NAME      READY   STATUS    RESTARTS   AGE   IP             NODE                                NOMINATED NODE   READINESS GATES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql-0   2/2     Running   0          3m25s  10.244.3.16   aks-nodepool1-28567125-vmss000002   &lt;none&gt;           &lt;none&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="info" data-title="Note"><blockquote>
<p>You should see that the <strong>mysql-0</strong> pod is now running on a different node than you noted before the failover.</p>
</blockquote></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="verify-successful-data-replication-and-persistence-for-mysql-server">Verify successful data replication and persistence for MySQL Server<a href="#verify-successful-data-replication-and-persistence-for-mysql-server" class="hash-link" aria-label="Direct link to Verify successful data replication and persistence for MySQL Server" title="Direct link to Verify successful data replication and persistence for MySQL Server">​</a></h4>
<p>Run the following command to verify the mount volume by injecting new data by running the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl run mysql-client --image=mysql:5.7 -i --rm --restart=Never -- \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql -h mysql-0.mysql &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO school.students VALUES (3, &#x27;Student3&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO school.students VALUES (4, &#x27;Student4&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the command to fetch the entries previously inserted into the database.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl run mysql-client --image=mysql:5.7 -i -t --rm --restart=Never -- \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql -h mysql-read -e &quot;SELECT * FROM school.students&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see output similar to the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| RollNumber | Name     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|          1 | Student1 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|          2 | Student2 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|          3 | Student3 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|          4 | Student4 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------+----------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The output obtained contains the values entered before the failover. This shows that the database and table entries in the MySQL Server were replicated and persisted across the failover of <strong>mysql-0</strong> pod. The output also demonstrates that, newer entries were successfully appended on the newly spawned mysql server application.</p>
<p>Congratulations! You successfully created a replicated local NVMe storage pool using Azure Container Storage. You deployed a MySQL server with the storage pool&#x27;s storage class and added entries to the database. You then triggered a failover by deleting the node hosting the workload pod and scaled up the cluster by one node to maintain three active nodes. Finally, you verified that the pre-failover data were successfully replicated and persisted, with new data added on top of the replicated data.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="advanced-security-concepts">Advanced Security Concepts<a href="#advanced-security-concepts" class="hash-link" aria-label="Direct link to Advanced Security Concepts" title="Direct link to Advanced Security Concepts">​</a></h2>
<p>Security is a critical aspect of any application deployment and it can cover a wide range of areas. In this lab, we will focus on how to securely access resources in Azure from an AKS cluster using Workload Identity and the Secure Software Supply Chain. Workload Identity allows you to securely access Azure resources from your applications running on AKS without needing to manage credentials. When it comes to secure software supply chain, we will focus on using Notation to sign and verify container images. This will help ensure that the images you deploy are the ones you expect.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="workload-identity">Workload Identity<a href="#workload-identity" class="hash-link" aria-label="Direct link to Workload Identity" title="Direct link to Workload Identity">​</a></h3>
<p>Workloads deployed on an Azure Kubernetes Services (AKS) cluster require Microsoft Entra application credentials or managed identities to access Microsoft Entra protected resources, such as Azure Key Vault and Microsoft Graph. Microsoft Entra Workload ID integrates with the capabilities native to Kubernetes to federate with external identity providers.</p>
<p>This Workload Identity section of the lab will deploy an application workload onto AKS and use Workload Identity to allow the application to access a secret in Azure KeyVault.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="limitations">Limitations<a href="#limitations" class="hash-link" aria-label="Direct link to Limitations" title="Direct link to Limitations">​</a></h4>
<p>Please be aware of the following limitations for Workload Identity</p>
<ul>
<li>You can have a maximum of <a href="https://learn.microsoft.com/entra/workload-id/workload-identity-federation-considerations#general-federated-identity-credential-considerations" target="_blank" rel="noopener noreferrer">20 federated identity credentials</a> per managed identity.</li>
<li>It takes a few seconds for the federated identity credential to be propagated after being initially added.</li>
<li>The <a href="https://learn.microsoft.com/azure/aks/virtual-nodes" target="_blank" rel="noopener noreferrer">virtual nodes</a> add on, based on the open source project <a href="https://virtual-kubelet.io/docs/" target="_blank" rel="noopener noreferrer">Virtual Kubelet</a>, isn&#x27;t supported.</li>
<li>Creation of federated identity credentials is not supported on user-assigned managed identities in these <a href="https://learn.microsoft.com/entra/workload-id/workload-identity-federation-considerations#unsupported-regions-user-assigned-managed-identities" target="_blank" rel="noopener noreferrer">regions.</a></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="enable-workload-identity-on-an-aks-cluster">Enable Workload Identity on an AKS cluster<a href="#enable-workload-identity-on-an-aks-cluster" class="hash-link" aria-label="Direct link to Enable Workload Identity on an AKS cluster" title="Direct link to Enable Workload Identity on an AKS cluster">​</a></h4>
<p>To enable Workload Identity on the AKS cluster, run the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks update \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--enable-oidc-issuer \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--enable-workload-identity</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="info" data-title="Note"><blockquote>
<p>This will can take several moments to complete.</p>
</blockquote></div>
<p>After the cluster has been updated, run the following command to get the OIDC Issuer URL, save it to the .env file, and reload the environment variables.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt;&gt; .env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AKS_OIDC_ISSUER=&quot;$(az aks show \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query &quot;oidcIssuerProfile.issuerUrl&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source .env</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-managed-identity">Create a Managed Identity<a href="#create-a-managed-identity" class="hash-link" aria-label="Direct link to Create a Managed Identity" title="Direct link to Create a Managed Identity">​</a></h4>
<p>A Managed Identity is a account (identity) created in Microsoft Entra ID. These identities allows your application to leverage them to use when connecting to resources that support Microsoft Entra authentication. Applications can use managed identities to obtain Microsoft Entra tokens without having to manage any credentials.</p>
<p>Run the following command to set the name of the user-assigned managed identity, save it to the .env file, and reload the environment variables.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt;&gt; .env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">USER_ASSIGNED_IDENTITY_NAME=&quot;myIdentity&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source .env</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to create a Managed Identity.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az identity create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${USER_ASSIGNED_IDENTITY_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--location ${LOCATION} \</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You will need several properties of the managed identity for the next steps. Run the following command to capture the details of the managed identity, service account, save it to the .env file, and reload the environment variables.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt;&gt; .env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">USER_ASSIGNED_CLIENT_ID=&quot;$(az identity show \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${USER_ASSIGNED_IDENTITY_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query &quot;clientId&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">USER_ASSIGNED_PRINCIPAL_ID=&quot;$(az identity show \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name &quot;${USER_ASSIGNED_IDENTITY_NAME}&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query &quot;principalId&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVICE_ACCOUNT_NAMESPACE=&quot;default&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVICE_ACCOUNT_NAME=&quot;workload-identity-sa&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FEDERATED_IDENTITY_CREDENTIAL_NAME=&quot;myFedIdentity&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source .env</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-kubernetes-service-account">Create a Kubernetes Service Account<a href="#create-a-kubernetes-service-account" class="hash-link" aria-label="Direct link to Create a Kubernetes Service Account" title="Direct link to Create a Kubernetes Service Account">​</a></h4>
<p>Create a Kubernetes service account and annotate it with the client ID of the managed identity created in the previous step. This annotation is used to associate the managed identity with the service account.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    azure.workload.identity/client-id: ${USER_ASSIGNED_CLIENT_ID}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: ${SERVICE_ACCOUNT_NAME}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: ${SERVICE_ACCOUNT_NAMESPACE}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-federated-identity-credential">Create the Federated Identity Credential<a href="#create-the-federated-identity-credential" class="hash-link" aria-label="Direct link to Create the Federated Identity Credential" title="Direct link to Create the Federated Identity Credential">​</a></h4>
<p>Run the following command to create the federated identity credential which creates a link between the managed identity, the service account issuer, and the subject. For more information about federated identity credentials in Microsoft Entra, see <a href="https://learn.microsoft.com/graph/api/resources/federatedidentitycredentials-overview?view=graph-rest-1.0" target="_blank" rel="noopener noreferrer">Overview of federated identity credentials in Microsoft Entra ID</a>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az identity federated-credential create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${FEDERATED_IDENTITY_CREDENTIAL_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--identity-name ${USER_ASSIGNED_IDENTITY_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--issuer ${AKS_OIDC_ISSUER} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--subject &quot;system:serviceaccount:${SERVICE_ACCOUNT_NAMESPACE}:${SERVICE_ACCOUNT_NAME}&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--audience api://AzureADTokenExchange</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="info" data-title="Note"><blockquote>
<p>It takes a few seconds for the federated identity credential to propagate after it is added. If a token request is made immediately after adding the federated identity credential, the request might fail until the cache is refreshed. To avoid this issue, you can add a slight delay after adding the federated identity credential.</p>
</blockquote></div>
<p>Assign the Key Vault Secrets User role to the user-assigned managed identity that you created previously. This step gives the managed identity permission to read secrets from the key vault.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az role assignment create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--assignee-object-id &quot;${USER_ASSIGNED_PRINCIPAL_ID}&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--role &quot;Key Vault Secrets User&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--scope &quot;${AKV_ID}&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--assignee-principal-type ServicePrincipal</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-a-sample-application-utilizing-workload-identity">Deploy a Sample Application Utilizing Workload Identity<a href="#deploy-a-sample-application-utilizing-workload-identity" class="hash-link" aria-label="Direct link to Deploy a Sample Application Utilizing Workload Identity" title="Direct link to Deploy a Sample Application Utilizing Workload Identity">​</a></h4>
<p>When you deploy your application pods, the manifest should reference the service account created in the Create Kubernetes service account step. The following manifest deploys the <strong>busybox</strong> image and shows how to reference the account, specifically the metadata\namespace and spec\serviceAccountName properties.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: sample-workload-identity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: ${SERVICE_ACCOUNT_NAMESPACE}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    azure.workload.identity/use: &quot;true&quot;  # Required. Only pods with this label can use workload identity.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceAccountName: ${SERVICE_ACCOUNT_NAME}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - image: busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      command: [&quot;sh&quot;, &quot;-c&quot;, &quot;sleep 3600&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="important" data-title="Important"><blockquote>
<p>Ensure that the application pods using workload identity include the label <strong>azure.workload.identity/use: &quot;true&quot;</strong> in the pod spec. Otherwise the pods will fail after they are restarted.</p>
</blockquote></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="access-secrets-in-azure-key-vault-with-workload-identity">Access Secrets in Azure Key Vault with Workload Identity<a href="#access-secrets-in-azure-key-vault-with-workload-identity" class="hash-link" aria-label="Direct link to Access Secrets in Azure Key Vault with Workload Identity" title="Direct link to Access Secrets in Azure Key Vault with Workload Identity">​</a></h4>
<p>The instructions in this step show how to access secrets, keys, or certificates in an Azure key vault from the pod. The examples in this section configure access to secrets in the key vault for the workload identity, but you can perform similar steps to configure access to keys or certificates.</p>
<p>The following example shows how to use the Azure role-based access control (Azure RBAC) permission model to grant the pod access to the key vault. For more information about the Azure RBAC permission model for Azure Key Vault, see <a href="https://learn.microsoft.com/azure/key-vault/general/rbac-guide" target="_blank" rel="noopener noreferrer">Grant permission to applications to access an Azure key vault using Azure RBAC</a>.</p>
<div class="warning" data-title="Warning"><blockquote>
<p>At the beginning of this lab, you created an Azure Key Vault and you should have properties of the key vault in the .env file. If you don&#x27;t have the properties set, go back to the top of the workshop and set the properties.</p>
</blockquote></div>
<p>Run the following command to create a secret in the key vault.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az keyvault secret set \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--vault-name &quot;${AKV_NAME}&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name &quot;my-secret&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--value &quot;Hello\!&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to deploy a pod that references the service account and key vault URL.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: sample-workload-identity-key-vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: ${SERVICE_ACCOUNT_NAMESPACE}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    azure.workload.identity/use: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceAccountName: ${SERVICE_ACCOUNT_NAME}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - image: ghcr.io/azure/azure-workload-identity/msal-go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: oidc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: KEYVAULT_URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value: ${AKV_URL}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: SECRET_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value: my-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodeSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes.io/os: linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To check whether all properties are injected properly by the webhook, use the kubectl describe command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe pod sample-workload-identity-key-vault | grep &quot;SECRET_NAME:&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To verify that pod is able to get a token and access the resource, use the kubectl logs command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl logs sample-workload-identity-key-vault</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Nice work! You have successfully deployed a sample application that utilizes Workload Identity to access a secret in Azure Key Vault. If you thought the process was too complex, you&#x27;ll be happy to know that the AKS Service Connector is a relatively new feature that simplifies the process of accessing Azure services from your AKS cluster. Using the AKS Service Connector, many of the steps you performed in this exercise are automated. Be sure to check out the <a href="https://learn.microsoft.com/azure/service-connector/how-to-use-service-connector-in-aks" target="_blank" rel="noopener noreferrer">AKS Service Connector documentation</a> to learn more.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="secure-supply-chain">Secure Supply Chain<a href="#secure-supply-chain" class="hash-link" aria-label="Direct link to Secure Supply Chain" title="Direct link to Secure Supply Chain">​</a></h3>
<p>Containers Secure Supply Chain (CSSC) framework is a seamless, agile ecosystem of tools and processes built to integrate and execute security controls throughout the lifecycle of containers. The container secure supply chain strategy is built considering all the security needs of the container applications. To find out more about the CSSC framework, visit the <a href="https://learn.microsoft.com/azure/security/container-secure-supply-chain/articles/container-secure-supply-chain-implementation/containers-secure-supply-chain-overview" target="_blank" rel="noopener noreferrer">Azure Container Secure Supply Chain</a> page.</p>
<p>As a quick overview, a container supply chain is built in stages to ensure that the container is secure at every stage of the lifecycle. Microsoft identifies these stages in the container supply chain:</p>
<p><img decoding="async" loading="lazy" alt="secure supply chain" src="/aks-labs/assets/images/secure-supply-chain-3e9ce9c83f0c3d120cb236fb429545c5.png" width="986" height="389" class="img_ev3q"></p>
<p>Container images are signed as part of the Acquire stage of the platform. Once a container image acquired from an external source or third-party vendor is verified for functionality and security, it is signed before being added to a catalog of approved container images. In this exercise, we will sign a container image using <a href="https://github.com/notaryproject/notation" target="_blank" rel="noopener noreferrer">Notation</a>, an open source supply chain security tool developed by the <a href="https://notaryproject.dev/" target="_blank" rel="noopener noreferrer">Notary Project community</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="install-notation">Install Notation<a href="#install-notation" class="hash-link" aria-label="Direct link to Install Notation" title="Direct link to Install Notation">​</a></h4>
<p>First, set a local variable for the version of Notation you want to install (in this lab we will use version 1.2.0). Also set environment variables for the operating system and architecture you are using.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export NOTATION_VERSION=1.2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export OS=$(uname | tr &#x27;[:upper:]&#x27; &#x27;[:lower:]&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ARCH=$(uname -m)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Use the following commands to download and install Notation.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -LO https://github.com/notaryproject/notation/releases/download/v$NOTATION_VERSION/notation_$NOTATION_VERSION\_${OS}_${ARCH}.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -LO https://github.com/notaryproject/notation/releases/download/v$NOTATION_VERSION/notation_$NOTATION_VERSION\_checksums.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shasum --check notation_$NOTATION_VERSION\_checksums.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If the checksum verification is successful, you should see something like this (the result shown here is for Linux AMD64):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">shasum: notation_1.2.0_darwin_amd64.tar.gz: No such file or directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notation_1.2.0_darwin_amd64.tar.gz: FAILED open or read</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shasum: notation_1.2.0_darwin_arm64.tar.gz: No such file or directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notation_1.2.0_darwin_arm64.tar.gz: FAILED open or read</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notation_1.2.0_linux_amd64.tar.gz: OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shasum: notation_1.2.0_linux_arm64.tar.gz: No such file or directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notation_1.2.0_linux_arm64.tar.gz: FAILED open or read</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shasum: notation_1.2.0_linux_armv7.tar.gz: No such file or directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notation_1.2.0_linux_armv7.tar.gz: FAILED open or read</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shasum: notation_1.2.0_windows_amd64.zip: No such file or directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notation_1.2.0_windows_amd64.zip: FAILED open or read</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shasum: WARNING: 5 listed files could not be read</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If the checksum verification is successful, extract the binary and move it to the desired bin directory in your <strong>$PATH</strong>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tar xvf notation_$NOTATION_VERSION\_${OS}_${ARCH}.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mv ./notation /usr/local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ln -s /usr/local/notation /usr/local/bin/notation</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Verify the installation by running the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">notation version</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see the version of Notation installed.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Notation - a tool to sign and verify artifacts.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Version:     1.2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Go version:  go1.23.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Git commit:  4700ad6f1bef13e411772d7ae4399f891fc3a6ae</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="install-the-notation-azure-key-vault-plugin">Install the Notation Azure Key Vault Plugin<a href="#install-the-notation-azure-key-vault-plugin" class="hash-link" aria-label="Direct link to Install the Notation Azure Key Vault Plugin" title="Direct link to Install the Notation Azure Key Vault Plugin">​</a></h4>
<p>After installing Notation, install the Notation Azure Key Vault plugin. You can find the URL and the SHA256 checksum for the Notation Azure Key Vault plugin on the <a href="https://github.com/Azure/notation-azure-kv/releases" target="_blank" rel="noopener noreferrer">release page</a>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">notation plugin install --url https://github.com/Azure/notation-azure-kv/releases/download/v${NOTATION_VERSION}/notation-azure-kv_${NOTATION_VERSION}_${OS}_${ARCH}.tar.gz --sha256sum &lt;checksum_from_the_release_page&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once the plugin is installed, confirm the <strong>azure-kv</strong> plugin is installed by running the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">notation plugin ls</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-azure-container-registry-and-azure-key-vault">Create Azure Container Registry and Azure Key Vault<a href="#create-azure-container-registry-and-azure-key-vault" class="hash-link" aria-label="Direct link to Create Azure Container Registry and Azure Key Vault" title="Direct link to Create Azure Container Registry and Azure Key Vault">​</a></h4>
<div class="info" data-title="Note"><blockquote>
<p>If you have already created an Azure Container Registry and Azure Key Vault, you can skip this section. Make sure the environment variables <strong>AKV_NAME</strong> and <strong>ACR_NAME</strong> are set correctly.</p>
</blockquote></div>
<p>Before beginning this exercise, let&#x27;s set the environment variables for the Azure Container Registry and Azure Key Vault which was created at the beginning of the lab with the Bicep template.</p>
<p>Set the local variables containing information about the certificate to be used for signing the container image.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CERT_NAME=&quot;wabbit-networks-io&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CERT_SUBJECT=&quot;CN=wabbit-networks.io,O=Notation,L=Seattle,ST=WA,C=US&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CERT_PATH=&quot;./${CERT_NAME}.pem&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now set the local variables containing information about the container registry and the image source code directory containing the Dockerfile to build.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">REPO=&quot;net-monitor&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TAG=&quot;v1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IMAGE=&quot;${ACR_SERVER}/${REPO}:${TAG}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IMAGE_SOURCE=&quot;https://github.com/wabbit-networks/net-monitor.git#main&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-self-signed-certificate-in-azure-key-vault">Create a self-signed certificate in Azure Key Vault<a href="#create-a-self-signed-certificate-in-azure-key-vault" class="hash-link" aria-label="Direct link to Create a self-signed certificate in Azure Key Vault" title="Direct link to Create a self-signed certificate in Azure Key Vault">​</a></h4>
<p>Use the following command to create a certificate policy file named <strong>my_policy.json</strong> which will be used the create the self-signed certificate in Azure Key Vault. The subject value will be used as the trust identity during verification.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt; ./my_policy.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;issuerParameters&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;certificateTransparency&quot;: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;name&quot;: &quot;Self&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;keyProperties&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;exportable&quot;: false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;keySize&quot;: 2048,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;keyType&quot;: &quot;RSA&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;reuseKey&quot;: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;secretProperties&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;contentType&quot;: &quot;application/x-pem-file&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;x509CertificateProperties&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ekus&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;1.3.6.1.5.5.7.3.3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;keyUsage&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;digitalSignature&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;subject&quot;: &quot;${CERT_SUBJECT}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;validityInMonths&quot;: 12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Use the following command to create a certificate compatible with <a href="https://github.com/notaryproject/specifications/blob/v1.0.0/specs/signature-specification.md#certificate-requirements" target="_blank" rel="noopener noreferrer">Notary Project certificate requirement</a> in the Azure Key Vault instance.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az keyvault certificate create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--vault-name ${AKV_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${CERT_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--policy @my_policy.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="signing-a-container-image-using-notation-and-azure-key-vault-plugin">Signing a Container Image using Notation and Azure Key Vault Plugin<a href="#signing-a-container-image-using-notation-and-azure-key-vault-plugin" class="hash-link" aria-label="Direct link to Signing a Container Image using Notation and Azure Key Vault Plugin" title="Direct link to Signing a Container Image using Notation and Azure Key Vault Plugin">​</a></h4>
<p>To sign a container image using Notation and Azure Key Vault, you first need to authenticate to your Azure Container Registry using the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az acr login --name ${ACR_NAME}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Build and push a new image with ACR Tasks. Use the digest value to identify the image to sign.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DIGEST=&quot;$(az acr build -r ${ACR_NAME} -t ${ACR_SERVER}/${REPO}:${TAG} ${IMAGE_SOURCE} --no-logs --query &quot;outputImages[0].digest&quot; -o tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IMAGE=&quot;${ACR_SERVER}/${REPO}@${DIGEST}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Get the ID of the signing key. The following command will get the Key ID of the latest version of the certificate.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">KEY_ID=&quot;$(az keyvault certificate show -n $CERT_NAME --vault-name $AKV_NAME --query &#x27;kid&#x27; -o tsv)&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Sign the image with the <a href="https://datatracker.ietf.org/doc/html/rfc9052" target="_blank" rel="noopener noreferrer">CBOR Object Signing and Encryption (COSE): Structures and Process</a> format using the Notation Azure Key Vault plugin and the key retrieved in the previous step with the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">notation sign \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--signature-format cose \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--id ${KEY_ID} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--plugin azure-kv \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--plugin-config self_signed=true ${IMAGE}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="verify-the-image-using-notation">Verify the image using Notation<a href="#verify-the-image-using-notation" class="hash-link" aria-label="Direct link to Verify the image using Notation" title="Direct link to Verify the image using Notation">​</a></h4>
<p>To verify the signed container image, add the root certificate that signs the leaf certificate to the trust store. The following command will download the root certificate and add it to the trust store. In the case of a self-signed certificate, the root certificate <em>is</em> the self-signed certificate</p>
<p>Run the following command to download the root certificate.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az keyvault certificate download \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${CERT_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--vault-name ${AKV_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--file ${CERT_PATH}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Add the root certificate to the trust store using the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">STORE_TYPE=&quot;ca&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STORE_NAME=&quot;wabbit-networks.io&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notation cert add --type ${STORE_TYPE} --store ${STORE_NAME} ${CERT_PATH}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Verify the image using the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">notation cert ls</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Configure the trust policy before verification. The trust policy is a JSON file that specifies the trust policy for the image. The trust policy is used to verify the signature of the image. For more information on trust policies and trust stores, see <a href="https://github.com/notaryproject/notaryproject/blob/v1.0.0/specs/trust-store-trust-policy.md" target="_blank" rel="noopener noreferrer">Trust store and trust policy specification</a></p>
<p>Run the following command to create a trust policy file named <strong>trust_policy.json</strong>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt; ./trust_policy.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;version&quot;: &quot;1.0&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;trustPolicies&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;name&quot;: &quot;wabbit-networks-images&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;registryScopes&quot;: [ &quot;${ACR_SERVER}/${REPO}&quot; ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;signatureVerification&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;level&quot; : &quot;strict&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;trustStores&quot;: [ &quot;${STORE_TYPE}:${STORE_NAME}&quot; ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;trustedIdentities&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;x509.subject: ${CERT_SUBJECT}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Import and verify the trust policy from the <strong>trust_policy.json</strong> file using the following Notation CLI commands.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">notation policy import ./trust_policy.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notation policy show</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Verify the image using the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">notation verify $IMAGE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Upon successful verification of the image using the trust policy, the sha256 digest of the verified image is returned in a successful output message.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="advanced-observability-concepts">Advanced Observability Concepts<a href="#advanced-observability-concepts" class="hash-link" aria-label="Direct link to Advanced Observability Concepts" title="Direct link to Advanced Observability Concepts">​</a></h2>
<p>Monitoring your AKS cluster has never been easier. Services like Azure Managed Prometheus and Azure Managed Grafana provide a fully managed monitoring solution for your AKS cluster all while using industry standard cloud-native tools. You can always deploy the open-source Prometheus and Grafana to your AKS cluster, but with Azure Managed Prometheus and Azure Managed Grafana, you can save time and resources by letting Azure manage the infrastructure for you.</p>
<p>The cluster should already be onboarded for monitoring; however, if you want to review the monitoring configuration, you can head over to the <strong>Insights</strong> under the <strong>Monitoring</strong> section in the Azure portal. From there, you can click on the <strong>Monitor Settings</strong> button and review/select the appropriate options. More information can be found <a href="https://learn.microsoft.com/azure/azure-monitor/containers/kubernetes-monitoring-enable?tabs=cli#enable-full-monitoring-with-azure-portal" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="aks-control-plane-metrics">AKS control plane metrics<a href="#aks-control-plane-metrics" class="hash-link" aria-label="Direct link to AKS control plane metrics" title="Direct link to AKS control plane metrics">​</a></h3>
<p>As you may know, Kubernetes control plane components are managed by Azure and there are metrics that Kubernetes administrators would like to monitor such as kube-apiserver, kube-scheduler, kube-controller-manager, and etcd. These are metrics that typically were not exposed to AKS users... until now. AKS now offers a preview feature that allows you to access these metrics and visualize them in Azure Managed Grafana. More on this preview feature can be found <a href="https://learn.microsoft.com/azure/aks/monitor-aks#monitor-aks-control-plane-metrics-preview" target="_blank" rel="noopener noreferrer">here</a>. Before you set off to enable this, it is important to consider the <a href="https://learn.microsoft.com/azure/aks/monitor-aks#prerequisites-and-limitations" target="_blank" rel="noopener noreferrer">pre-requisites and limitations</a> of this feature while it is in preview.</p>
<p>To enable the feature simply run the following command to register the preview feature.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az feature register \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--namespace &quot;Microsoft.ContainerService&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name &quot;AzureMonitorMetricsControlPlanePreview&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once the feature is registered, refresh resource provider.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az provider register --namespace Microsoft.ContainerService</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After the feature is registered, you can enable the feature on your existing AKS cluster by running the following command. New clusters will have this feature enabled by default from this point forward.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks update \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME} \</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="info" data-title="Note"><blockquote>
<p>The AKS cluster must also have been onboarded to Azure Managed Prometheus in order for the data to be collected.</p>
</blockquote></div>
<p>With Azure Managed Grafana integrated with Azure Managed Prometheus, you can import <a href="https://grafana.com/grafana/dashboards/20331-kubernetes-api-server/" target="_blank" rel="noopener noreferrer">kube-apiserver</a> and <a href="https://grafana.com/grafana/dashboards/20330-kubernetes-etcd/" target="_blank" rel="noopener noreferrer">etcd</a> metrics dashboards.</p>
<p>Before you attempt to import dashboards into the Azure Managed Grafana instance, you will need to make sure the Azure CLI extension for Azure Managed Grafana is installed. Run the following command to install the extension.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az extension add --name amg</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to import the kube-apiserver and etcd metrics dashboards.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># import kube-apiserver dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az grafana dashboard import \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${GRAFANA_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--folder &#x27;Azure Managed Prometheus&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--definition 20331</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># import etcd dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az grafana dashboard import \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${GRAFANA_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--folder &#x27;Azure Managed Prometheus&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--definition 20330</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now you, should be able to browse to your Azure Managed Grafana instance and see the kube-apiserver and etcd metrics dashboards in the Azure Managed Prometheus folder.</p>
<p>Out of the box, only the etcd and kube-apiserver metrics data is being collected as part of the <a href="https://learn.microsoft.com/azure/aks/monitor-aks-reference#minimal-ingestion-profile-for-control-plane-metrics-in-managed-prometheus" target="_blank" rel="noopener noreferrer">minimal ingestion profile</a> for control plane metrics. This profile is designed to provide a balance between the cost of monitoring and the value of the data collected. The others mentioned above will need to be manually enabled and this can be done by deploying a ConfigMap named <a href="https://github.com/Azure/prometheus-collector/blob/89e865a73601c0798410016e9beb323f1ecba335/otelcollector/configmaps/ama-metrics-settings-configmap.yaml" target="_blank" rel="noopener noreferrer">ama-metrics-settings-configmap</a> in the kube-system namespace.</p>
<div class="info" data-title="Note"><blockquote>
<p>More on the minimal ingestion profile can be found <a href="https://learn.microsoft.com/azure/azure-monitor/containers/prometheus-metrics-scrape-configuration-minimal" target="_blank" rel="noopener noreferrer">here</a>.</p>
</blockquote></div>
<p>Run the following command to deploy the <strong>ama-metrics-settings-configmap</strong> in the <strong>kube-system</strong> namespace.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/Azure/prometheus-collector/89e865a73601c0798410016e9beb323f1ecba335/otelcollector/configmaps/ama-metrics-settings-configmap.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, you can edit the <strong>ama-metrics-settings-configmap</strong> to enable the metrics you want to collect. Run the following command to edit the <strong>ama-metrics-settings-configmap</strong>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl edit cm ama-metrics-settings-configmap -n kube-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Toggle any of the metrics you wish to collect to <strong>true</strong>, but keep in mind that the more metrics you collect, the more resources you will consume.</p>
<div class="info" data-title="Note"><blockquote>
<p>The Azure team does not offer a <a href="https://grafana.com/orgs/azure/dashboards" target="_blank" rel="noopener noreferrer">pre-built dashboard</a> for some of these metrics, but you can reference the doc on <a href="https://learn.microsoft.com/azure/aks/monitor-aks-reference#supported-metrics-for-microsoftcontainerservicemanagedclusters" target="_blank" rel="noopener noreferrer">supported metrics for Azure Managed Prometheus</a> and create your own dashboards in Azure Managed Grafana or search for community dashboards on <a href="https://grafana.com/grafana/dashboards" target="_blank" rel="noopener noreferrer">Grafana.com</a> and import them into Azure Managed Grafana. Just be sure to use the Azure Managed Prometheus data source.</p>
</blockquote></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="custom-scrape-jobs-for-azure-managed-prometheus">Custom scrape jobs for Azure Managed Prometheus<a href="#custom-scrape-jobs-for-azure-managed-prometheus" class="hash-link" aria-label="Direct link to Custom scrape jobs for Azure Managed Prometheus" title="Direct link to Custom scrape jobs for Azure Managed Prometheus">​</a></h3>
<p>Typically when you want to scrape metrics from a target, you would create a scrape job in Prometheus. With Azure Managed Prometheus, you can create custom scrape jobs for your AKS cluster using the PodMonitor and ServiceMonitor custom resource definitions (CRDs) that is automatically created when you onboard your AKS cluster to Azure Managed Prometheus. These CRDs are nearly identical to the open-source Prometheus CRDs, with the only difference being the apiVersion. When you deploy a PodMonitor or ServiceMonitor for Azure Managed Prometheus, you will need to specify the apiVersion as <strong>azmonitoring.coreos.com/v1</strong> instead of <strong>monitoring.coreos.com/v1</strong>.</p>
<p>We&#x27;ll go through a quick example of how to deploy a PodMonitor for a reference app that is deployed to your AKS cluster.</p>
<p>Run the following command to deploy a reference app to the cluster to generate some metrics.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/Azure/prometheus-collector/refs/heads/main/internal/referenceapp/prometheus-reference-app.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to deploy a PodMonitor for the reference app</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/Azure/prometheus-collector/refs/heads/main/otelcollector/deploy/example-custom-resources/pod-monitor/pod-monitor-reference-app.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Custom resource targets are scraped by pods that start with the name <strong>ama-metrics-*</strong> and the Prometheus Agent web user interface is available on port 9090. So we can port-forward the Prometheus pod to our local machine to access the Prometheus UI and explore all that is configured.</p>
<p>Run the following command to get the name of the Azure Monitor Agent pod.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AMA_METRICS_POD_NAME=&quot;$(kubectl get po -n kube-system -lrsName=ama-metrics -o jsonpath=&#x27;{.items[0].metadata.name}&#x27;)&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to port-forward the Prometheus pod to your local machine.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl port-forward ${AMA_METRICS_POD_NAME} -n kube-system 9090</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Open a browser and navigate to <a href="http://localhost:9090" target="_blank" rel="noopener noreferrer">http://localhost:9090</a> to access the Prometheus UI.</p>
<p>If you click on the <strong>Status</strong> dropdown and select <strong>Targets</strong>, you will see the target for <strong>podMonitor/default/prometheus-reference-app-job/0</strong> and the endpoint that is being scraped.</p>
<p>If you click on the <strong>Status</strong> dropdown and select <strong>Service Discovery</strong>, you will see the scrape jobs with active targets and discovered labels for <strong>podMonitor/default/prometheus-reference-app-job/0</strong>.</p>
<p>When you are done, you can stop the port-forwarding by pressing <strong>Ctrl+c</strong>.</p>
<p>Give the scrape job a few moments to collect metrics from the reference app. Once you have given it enough time, you can head over to Azure Managed Grafana and click on the <strong>Explore</strong> tab to query the metrics that are being collected.</p>
<p>More on custom scrape jobs can be found <a href="https://learn.microsoft.com/azure/azure-monitor/containers/prometheus-metrics-scrape-crd" target="_blank" rel="noopener noreferrer">here</a> and <a href="https://learn.microsoft.com/azure/azure-monitor/containers/prometheus-metrics-troubleshoot#prometheus-interface" target="_blank" rel="noopener noreferrer">here</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="aks-cost-analysis">AKS Cost Analysis<a href="#aks-cost-analysis" class="hash-link" aria-label="Direct link to AKS Cost Analysis" title="Direct link to AKS Cost Analysis">​</a></h3>
<p>Cost for AKS clusters can be managed like any other resource in Azure, via the <a href="https://portal.azure.com/#view/Microsoft_Azure_CostManagement/Menu/~/overview/openedBy/AzurePortal" target="_blank" rel="noopener noreferrer">Azure Cost Analysis</a> blade.</p>
<p>Using the Cost Analysis blade, you can view the cost of your Azure resources overtime and can be scoped by management group, subscription, and resource group with further filters and views for more granular analysis. To learn more about Azure Cost Analysis, see <a href="https://learn.microsoft.com/azure/cost-management-billing/costs/quick-acm-cost-analysis" target="_blank" rel="noopener noreferrer">the quickstart guide</a>.</p>
<p>When it comes to Kubernetes, you would want to see a more granular view of the compute, networking, and storage costs associated with Kubernetes namespaces. This is where the AKS Cost Analysis add-on comes in. The AKS Cost Analysis add-on is built on the <a href="https://www.opencost.io/" target="_blank" rel="noopener noreferrer">OpenCost</a> project, with is a CNCF incubating project that provides a Kubernetes-native cost analysis solution.</p>
<p>You can always install the open-source project into your AKS cluster by following these <a href="https://www.opencost.io/docs/configuration/azure" target="_blank" rel="noopener noreferrer">instructions</a> but it might be easiest to enable the AKS Cost Analysis add-on to your AKS cluster.</p>
<p>There are a few pre-requisites to enable the AKS Cost Analysis add-on to your AKS cluster and they are documented <a href="https://learn.microsoft.com/azure/aks/cost-analysis#prerequisites-and-limitations" target="_blank" rel="noopener noreferrer">here</a>. Once you have met the pre-requisites, you can enable the AKS Cost Analysis add-on to your AKS cluster.</p>
<p>Run the following command to enable the AKS Cost Analysis add-on to your AKS cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks update \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--enable-cost-analysis</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It can take a few minutes to enable the AKS Cost Analysis add-on to your AKS cluster and up to 24 hours for cost data to be populated up to the Cost Analysis blade. But when it is ready, you can view the cost of your AKS cluster and its namespaces by navigating to the <a href="https://portal.azure.com/#view/Microsoft_Azure_CostManagement/Menu/~/overview/openedBy/AzurePortal" target="_blank" rel="noopener noreferrer">Azure Cost Analysis</a> blade. Once you scope to a management group, subscription, or resource group that contains your AKS cluster, you should see a button labeled &quot;Kubernetes clusters&quot;. Clicking on this button will take you to the AKS Cost Analysis blade where you can view the cost of your AKS cluster and its namespaces.</p>
<p><img decoding="async" loading="lazy" alt="AKS Cost Analysis" src="/aks-labs/assets/images/aks-cost-analysis-6564ee02d4799ca881e3f887c1047ff4.png" width="2500" height="1353" class="img_ev3q"></p>
<p>If you expand the AKS cluster, you will see a list of all the Azure resources that are associated with it.</p>
<p><img decoding="async" loading="lazy" alt="AKS Cost Analysis Cluster" src="/aks-labs/assets/images/aks-cost-analysis-cluster-583460a9512e80dec572b8879b3319d0.png" width="2499" height="1357" class="img_ev3q"></p>
<p>If you click on the AKS cluster, you will see a list of all compute, networking, and storage costs associated with namespaces in the AKS cluster.</p>
<p><img decoding="async" loading="lazy" alt="AKS Cost Analysis Namespace" src="/aks-labs/assets/images/aks-cost-analysis-namespace-70804e37cfa799c9ad2227e089752986.png" width="2498" height="1348" class="img_ev3q"></p>
<p>It also shows you the &quot;idle charges&quot; which is a great way to see if you are over-provisioning your AKS cluster or if you any opportunities to optimize your AKS cluster.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="update-and-multi-cluster-management">Update and Multi-Cluster Management<a href="#update-and-multi-cluster-management" class="hash-link" aria-label="Direct link to Update and Multi-Cluster Management" title="Direct link to Update and Multi-Cluster Management">​</a></h2>
<p>Maintaining your AKS cluster&#x27;s updates is crucial for operational hygiene. Neglecting this can lead to severe issues, including losing support and becoming vulnerable to known CVEs (Common Vulnerabilities and Exposures) attacks. In this section, we will look and examine all tiers of your AKS infrastructure, and discuss and show the procedures and best practices to keep your AKS cluster up-to-date.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="api-server-upgrades">API Server upgrades<a href="#api-server-upgrades" class="hash-link" aria-label="Direct link to API Server upgrades" title="Direct link to API Server upgrades">​</a></h3>
<p>AKS is a managed Kubernetes service provided by Azure. Even though AKS is managed, flexibility has been given to customer on controlling the version of the API server they use in their environment. As newer versions of Kubernetes become available, those versions are tested and made available as part of the service. As newer versions are provided, older versions of Kubernetes are phased out of the service and are no longer available to deploy. Staying within the spectrum of supported versions, will ensure you don&#x27;t compromise support for your AKS cluster.</p>
<p>You have two options for upgrading your AKS API server, you can do manual upgrades at your own designated schedule, or you can configure cluster to subscribe to an auto-upgrade channel. These two options provides you with the flexibility to adopt the most appropriate choice depending on your organizations policies and procedures.</p>
<div class="info" data-title="Note"><blockquote>
<p>When you upgrade a supported AKS cluster, you can&#x27;t skip Kubernetes minor versions. For more information please see <a href="https://learn.microsoft.com/azure/aks/upgrade-aks-cluster?tabs=azure-cli#kubernetes-version-upgrades" target="_blank" rel="noopener noreferrer">Kubernetes version upgrades</a></p>
</blockquote></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="manually-upgrading-the-api-server-and-nodes">Manually Upgrading the API Server and Nodes<a href="#manually-upgrading-the-api-server-and-nodes" class="hash-link" aria-label="Direct link to Manually Upgrading the API Server and Nodes" title="Direct link to Manually Upgrading the API Server and Nodes">​</a></h4>
<p>The first step in manually upgrading your AKS API server is to view the current version, and the available upgrade versions.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks get-upgrades \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output table</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can also, quickly look at the current version of Kubernetes running on the nodes in the nodepools by running the following:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get nodes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can see all of the nodes in both the system and user node pools are at version <strong>1.29.9</strong> as well.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                 STATUS   ROLES    AGE    VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aks-systempool-14753261-vmss000000   Ready    &lt;none&gt;   123m   v1.29.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aks-systempool-14753261-vmss000001   Ready    &lt;none&gt;   123m   v1.29.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aks-systempool-14753261-vmss000002   Ready    &lt;none&gt;   123m   v1.29.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aks-userpool-27827974-vmss000000     Ready    &lt;none&gt;   95m    v1.29.9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to upgrade the current cluster API server, and the Kubernetes version running on the nodes, from version <strong>1.29.9</strong> to version <strong>1.30.5</strong>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks upgrade \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--kubernetes-version &quot;1.30.5&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="info" data-title="Note"><blockquote>
<p>The az aks upgrade command has the ability to separate the upgrade operation to specify just the control plane and/or the node version. In this lab we will run the command that will upgrade both the control plan and nodes at the same time.</p>
</blockquote></div>
<p>Follow the prompts to confirm the upgrade operation. Once the AKS API version has been completed on both the control plane and nodes, you will see a completion message with the updated Kubernetes version shown.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up-the-auto-upgrade-channel-for-the-api-server-and-nodes">Setting up the auto-upgrade channel for the API Server and Nodes<a href="#setting-up-the-auto-upgrade-channel-for-the-api-server-and-nodes" class="hash-link" aria-label="Direct link to Setting up the auto-upgrade channel for the API Server and Nodes" title="Direct link to Setting up the auto-upgrade channel for the API Server and Nodes">​</a></h4>
<p>A more preferred method for upgrading your AKS API server and nodes is to configure the cluster auto-upgrade channel for your AKS cluster. This feature allow you a &quot;set it and forget it&quot; mechanism that yields tangible time and operational cost benefits. By enabling auto-upgrade, you can ensure your clusters are up to date and don&#x27;t miss the latest features or patches from AKS and upstream Kubernetes.</p>
<p>There are several auto-upgrade channels you can subscribe your AKS cluster to. Those channels include <strong>none</strong>, <strong>patch</strong>, <strong>stable</strong>, and <strong>rapid</strong>. Each channel provides a different upgrade experience depending on how you would like to keep your AKS clusters upgraded. For a more detailed explanation of each channel, please view the <a href="https://learn.microsoft.com/azure/aks/auto-upgrade-cluster?tabs=azure-cli#cluster-auto-upgrade-channels" target="_blank" rel="noopener noreferrer">cluster auto-upgrade channels</a> table.</p>
<p>For this lab demonstration, we will configure the AKS cluster to subscribe to the <strong>patch</strong> channel. The patch channel will automatically upgrades the cluster to the latest supported patch version when it becomes available while keeping the minor version the same.</p>
<p>Run the following command to set the auto-upgrade channel.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks update \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--auto-upgrade-channel patch</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once the auto-upgrade channel subscription has been enabled for your cluster, you will see the <strong>upgradeChannel</strong> property updated to the chosen channel in the output.</p>
<div class="important" data-title="Important"><blockquote>
<p>Configuring your AKS cluster to an auto-upgrade channel can have impact on the availability of workloads running on your cluster. Please review the additional options available to <a href="https://learn.microsoft.com/azure/aks/upgrade-aks-cluster?tabs=azure-cli#customize-node-surge-upgrade" target="_blank" rel="noopener noreferrer">Customize node surge upgrade</a>.</p>
</blockquote></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="node-image-updates">Node image updates<a href="#node-image-updates" class="hash-link" aria-label="Direct link to Node image updates" title="Direct link to Node image updates">​</a></h3>
<p>In addition to you being able to upgrade the Kubernetes API versions of both your control plan and nodepool nodes, you can also upgrade the operating system (OS) image of the VMs for your AKS cluster. AKSregularly provides new node images, so it&#x27;s beneficial to upgrade your node images frequently to use the latest AKS features. Linux node images are updated weekly, and Windows node images are updated monthly.</p>
<p>Upgrading node images is critical to not only ensuring the latest Kubernetes API functionality will be available from the OS, but also to ensure that the nodes in your AKS cluster have the latest security and CVE patches to prevent any vulnerabilities in your environment.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="manually-upgrading-aks-node-image">Manually Upgrading AKS Node Image<a href="#manually-upgrading-aks-node-image" class="hash-link" aria-label="Direct link to Manually Upgrading AKS Node Image" title="Direct link to Manually Upgrading AKS Node Image">​</a></h4>
<p>When planning to manually upgrade your AKS cluster, it&#x27;s good practice to view the available images.</p>
<p>Run the following command to view the available images for your the system node pool.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks nodepool get-upgrades \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster-name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--nodepool-name systempool</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The command output shows the <strong>latestNodeImageVersion</strong> available for the nodepool.</p>
<p>Check the current node image version for the system node pool by running the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks nodepool show \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster-name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name systempool \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query &quot;nodeImageVersion&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this particular case, the system node pool image is the most recent image available as it matches the latest image version available, so there is no need to do an upgrade operation for the node image. If you needed to upgrade your node image, you can run the following command which will update all the node images for all node pools connected to your cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks upgrade \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster-name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--node-image-only</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="maintenance-windows">Maintenance windows<a href="#maintenance-windows" class="hash-link" aria-label="Direct link to Maintenance windows" title="Direct link to Maintenance windows">​</a></h3>
<p>Maintenance windows provides you with the predictability to know when maintenance from Kubernetes API updates and/or node OS image updates will occur. The use of maintenance windows can help align to your current organizational operational policies concerning when services are expected to not be available.</p>
<p>There are currently three configuration schedules for maintenance windows, <strong>default</strong>, <strong>aksManagedAutoUpgradeSchedule</strong>, and <strong>aksManagedNodeOSUpgradeSchedule</strong>. For more specific information on these configurations, please see <a href="https://learn.microsoft.com/azure/aks/planned-maintenance?tabs=azure-cli#schedule-configuration-types-for-planned-maintenance" target="_blank" rel="noopener noreferrer">Schedule configuration types for planned maintenance</a>.</p>
<p>It is recommended to use <strong>aksManagedAutoUpgradeSchedule</strong> for all cluster upgrade scenarios and aksManagedNodeOSUpgradeSchedule for all node OS security patching scenarios.</p>
<div class="info" data-title="Note"><blockquote>
<p>The default option is meant exclusively for AKS weekly releases. You can switch the default configuration to the <strong>aksManagedAutoUpgradeSchedule</strong> or <strong>aksManagedNodeOSUpgradeSchedule</strong> configuration by using the <code>az aks maintenanceconfiguration update</code> command.</p>
</blockquote></div>
<p>When creating a maintenance window, it is good practice to see if any existing maintenance windows have already been configured. Checking to see if existing maintenance windows exists will avoid any conflicts when applying the setting. To check for the maintenance windows on an existing AKS cluster, run the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks maintenanceconfiguration list \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster-name ${AKS_NAME}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you receive <strong>[]</strong> as output, this means no maintenance windows exists for the AKS cluster specified.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="adding-an-aks-cluster-maintenance-windows">Adding an AKS Cluster Maintenance Windows<a href="#adding-an-aks-cluster-maintenance-windows" class="hash-link" aria-label="Direct link to Adding an AKS Cluster Maintenance Windows" title="Direct link to Adding an AKS Cluster Maintenance Windows">​</a></h4>
<p>Maintenance window configuration is highly configurable to meet the scheduling needs of your organization. For an in-depth understanding of all the properties available for configuration, please see the <a href="https://learn.microsoft.com/azure/aks/planned-maintenance?tabs=azure-cli#create-a-maintenance-window" target="_blank" rel="noopener noreferrer">Create a maintenance window</a> guide.</p>
<p>The following command will create a <strong>default</strong> configuration that schedules maintenance to run from 1:00 AM to 2:00 AM every Sunday.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks maintenanceconfiguration add \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster-name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name default \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--weekday Sunday \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--start-hour 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="managing-multiple-aks-clusters-with-azure-fleet">Managing Multiple AKS Clusters with Azure Fleet<a href="#managing-multiple-aks-clusters-with-azure-fleet" class="hash-link" aria-label="Direct link to Managing Multiple AKS Clusters with Azure Fleet" title="Direct link to Managing Multiple AKS Clusters with Azure Fleet">​</a></h3>
<p>Azure Kubernetes Fleet Manager (Fleet) enables at-scale management of multiple Azure Kubernetes Service (AKS) clusters. Fleet supports the following scenarios:</p>
<ul>
<li>Create a Fleet resource and join AKS clusters across regions and subscriptions as member clusters</li>
<li>Orchestrate Kubernetes version upgrades and node image upgrades across multiple clusters by using update runs, stages, and groups</li>
<li>Automatically trigger version upgrades when new Kubernetes or node image versions are published (preview)</li>
<li>Create Kubernetes resource objects on the Fleet resource&#x27;s hub cluster and control their propagation to member clusters</li>
<li>Export and import services between member clusters, and load balance incoming layer-4 traffic across service endpoints on multiple clusters (preview)</li>
</ul>
<p>For this section of the lab we will focus on two AKS Fleet Manager features, creating a fleet and joining member clusters, and propagating resources from a hub cluster to a member clusters.</p>
<p>You can find and learn about additional AKS Fleet Manager concepts and functionality on the <a href="https://learn.microsoft.com/azure/kubernetes-fleet/" target="_blank" rel="noopener noreferrer">Azure Kubernetes Fleet Manager</a> documentation page.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-additional-aks-cluster">Create Additional AKS Cluster<a href="#create-additional-aks-cluster" class="hash-link" aria-label="Direct link to Create Additional AKS Cluster" title="Direct link to Create Additional AKS Cluster">​</a></h4>
<div class="info" data-title="Note"><blockquote>
<p>If you already have an additional AKS cluster, in addition to your original lab AKS cluster, you can skip this section.</p>
</blockquote></div>
<p>To understand how AKS Fleet Manager can help manage multiple AKS clusters, we will need to create an additional AKS cluster to join as a member cluster. The following commands and instructions will deploy an additional AKS cluster into the same Azure resource group as your existing AKS cluster. For this lab purposes, it is not necessary to deploy the additional cluster in a region and/or subscription to show the benefits of AKS Fleet Manager.</p>
<p>Run the following command to create a new environment variable for the name of the additional AKS cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AKS_NAME_2=&quot;${AKS_NAME}-2&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to create a new AKS cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME_2} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--no-wait</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="info" data-title="Note"><blockquote>
<p>This command will take a few minutes to complete. You can proceed with the next steps while the command is running.</p>
</blockquote></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-and-configure-access-for-a-kubernetes-fleet-resource-with-hub-cluster">Create and configure Access for a Kubernetes Fleet Resource with Hub Cluster<a href="#create-and-configure-access-for-a-kubernetes-fleet-resource-with-hub-cluster" class="hash-link" aria-label="Direct link to Create and configure Access for a Kubernetes Fleet Resource with Hub Cluster" title="Direct link to Create and configure Access for a Kubernetes Fleet Resource with Hub Cluster">​</a></h4>
<p>Since this lab will be using AKS Fleet Manager for Kubernetes object propagation, you will need to create the Fleet resource with the hub cluster enabled by specifying the --enable-hub parameter with the az fleet create command. The hub cluster will orchestrate and manage the Fleet member clusters. We will add the lab&#x27;s original AKS cluster and the newly created additional cluster as a member of the Fleet group in a later step.</p>
<p>In order to use the AKS Fleet Manager extension, you will need to install the extension. Run the following command to install the AKS Fleet Manager extension.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az extension add --name fleet</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to create new environment variables for the Fleet resource name and reload the environment variables.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FLEET_NAME=&quot;myfleet${RANDOM}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next run the following command to create the Fleet resource with the hub cluster enabled.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FLEET_ID=&quot;$(az fleet create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${FLEET_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--location ${LOCATION} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--enable-hub \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query id \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--output tsv)&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once the Kubernetes Fleet hub cluster has been created, we will need to gather the credential information to access it. This is similar to using the <code>az aks get-credentials</code> command on an AKS cluster. Run the following command to get the Fleet hub cluster credentials.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az fleet get-credentials \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${FLEET_NAME}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now that you have the credential information merged to your local Kubernetes config file, we will need to configure and authorize Azure role access for your account to access the Kubernetes API for the Fleet resource.</p>
<p>Once we have all of the terminal environment variables set, we can run the command to add the Azure account to be a <strong>Azure Kubernetes Fleet Manager RBAC Cluster Admin</strong> role on the Fleet resource.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az role assignment create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--role &quot;Azure Kubernetes Fleet Manager RBAC Cluster Admin&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--assignee ${USER_ID} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--scope ${FLEET_ID}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="joining-existing-aks-cluster-to-the-fleet">Joining Existing AKS Cluster to the Fleet<a href="#joining-existing-aks-cluster-to-the-fleet" class="hash-link" aria-label="Direct link to Joining Existing AKS Cluster to the Fleet" title="Direct link to Joining Existing AKS Cluster to the Fleet">​</a></h4>
<p>Now that we have our Fleet hub cluster created, along with the necessary Fleet API access, we&#x27;re now ready to join our AKS clusters to Fleet as member servers. To join AKS clusters to Fleet, we will need the Azure subscription path to each AKS object. To get the subscription path to your AKS clusters, you can run the following commands.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AKS_FLEET_CLUSTER_1_NAME=&quot;$(echo ${AKS_NAME} | tr &#x27;[:upper:]&#x27; &#x27;[:lower:]&#x27;)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AKS_FLEET_CLUSTER_2_NAME=&quot;$(echo ${AKS_NAME_2} | tr &#x27;[:upper:]&#x27; &#x27;[:lower:]&#x27;)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AKS_FLEET_CLUSTER_1_ID=&quot;$(az aks show --resource-group ${RG_NAME} --name ${AKS_FLEET_CLUSTER_1_NAME} --query &quot;id&quot; --output tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AKS_FLEET_CLUSTER_2_ID=&quot;$(az aks show --resource-group ${RG_NAME} --name ${AKS_FLEET_CLUSTER_2_NAME} --query &quot;id&quot; --output tsv)&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to join both AKS clusters to the Fleet.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># add first AKS cluster to the Fleet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az fleet member create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--fleet-name ${FLEET_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_FLEET_CLUSTER_1_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--member-cluster-id ${AKS_FLEET_CLUSTER_1_ID}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># add the second AKS cluster to the Fleet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az fleet member create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--fleet-name ${FLEET_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_FLEET_CLUSTER_2_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--member-cluster-id ${AKS_FLEET_CLUSTER_2_ID}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to verify both AKS clusters have been added to the Fleet.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get memberclusters</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="propagate-resources-from-a-hub-cluster-to-member-clusters">Propagate Resources from a Hub Cluster to Member Clusters<a href="#propagate-resources-from-a-hub-cluster-to-member-clusters" class="hash-link" aria-label="Direct link to Propagate Resources from a Hub Cluster to Member Clusters" title="Direct link to Propagate Resources from a Hub Cluster to Member Clusters">​</a></h4>
<p>The ClusterResourcePlacement API object is used to propagate resources from a hub cluster to member clusters. The ClusterResourcePlacement API object specifies the resources to propagate and the placement policy to use when selecting member clusters. The ClusterResourcePlacement API object is created in the hub cluster and is used to propagate resources to member clusters. This example demonstrates how to propagate a namespace to member clusters using the ClusterResourcePlacement API object with a PickAll placement policy.</p>
<div class="important" data-title="Important"><blockquote>
<p>Before running the following commands, make sure your <code>kubectl conifg</code> has the Fleet hub cluster as it&#x27;s current context. To check your current context, run the <code>kubectl config current-context</code> command. You should see the output as <strong>hub</strong>. If the output is not <strong>hub</strong>, please run <code>kubectl config set-context hub</code>.</p>
</blockquote></div>
<p>Run the following command to create a namespace to place onto the member clusters.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create namespace my-fleet-ns</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to create a ClusterResourcePlacement API object in the hub cluster to propagate the namespace to the member clusters.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: placement.kubernetes-fleet.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ClusterResourcePlacement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: my-lab-crp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resourceSelectors:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - group: &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      kind: Namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: my-fleet-ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  policy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    placementType: PickAll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Check the progress of the resource propagation using the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get clusterresourceplacement my-lab-crp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>View the details of the ClusterResourcePlacement object using the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe clusterresourceplacement my-lab-crp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now if you switch your context to one of the member clusters, you should see the namespace <strong>my-fleet-ns</strong> has been propagated to the member cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl config set-context ${AKS_FLEET_CLUSTER_1_NAME}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see the namespace <strong>my-fleet-ns</strong> in the list of namespaces.</p>
<p>This is a simple example of how you can use AKS Fleet Manager to manage multiple AKS clusters. There are many more features and capabilities that AKS Fleet Manager provides to help manage and operate multiple AKS clusters. For more information on AKS Fleet Manager, see the <a href="https://learn.microsoft.com/azure/kubernetes-fleet/" target="_blank" rel="noopener noreferrer">Azure Kubernetes Fleet Manager</a> documentation.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2>
<p>Congratulations! If you&#x27;ve completed all the exercises in this lab, you are well on your way to becoming an Azure Kubernetes Service (AKS) expert. You&#x27;ve learned how to create an AKS cluster, deploy applications, configure networking, and secure your cluster. You&#x27;ve also learned how to monitor your AKS cluster, manage updates, and even manage multiple AKS clusters with Azure Kubernetes Fleet Manager. Hopefully, you&#x27;ve gained a better understanding of how to manage and operate AKS clusters in a production environment.</p>
<p>The cloud is always evolving, and so is AKS. It&#x27;s important to stay up-to-date with the latest features and best practices. The Azure Kubernetes Service (AKS) documentation is a great resource to learn more about AKS and stay up-to-date with the latest features and best practices. You can find the AKS documentation <a href="https://learn.microsoft.com/azure/aks/" target="_blank" rel="noopener noreferrer">here</a> as well as the links listed below.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="additional-resources">Additional Resources<a href="#additional-resources" class="hash-link" aria-label="Direct link to Additional Resources" title="Direct link to Additional Resources">​</a></h3>
<ul>
<li><a href="https://learn.microsoft.com/azure/aks/best-practices" target="_blank" rel="noopener noreferrer">Cluster operator and developer best practices to build and manage applications on Azure Kubernetes Service (AKS)</a></li>
<li><a href="https://learn.microsoft.com/azure/architecture/reference-architectures/containers/aks/baseline-aks" target="_blank" rel="noopener noreferrer">AKS baseline architecture</a></li>
<li><a href="https://learn.microsoft.com/azure/architecture/reference-architectures/containers/aks-multi-region/aks-multi-cluster" target="_blank" rel="noopener noreferrer">AKS baseline for multi-region clusters</a></li>
<li><a href="https://learn.microsoft.com/azure/aks/private-clusters?tabs=default-basic-networking%2Cazure-portal" target="_blank" rel="noopener noreferrer">Create a private Azure Kubernetes Service (AKS) cluster</a></li>
<li><a href="https://learn.microsoft.com/azure/aks/azure-cni-powered-by-cilium" target="_blank" rel="noopener noreferrer">Configure Azure CNI Powered by Cilium in Azure Kubernetes Service (AKS)</a></li>
<li><a href="https://learn.microsoft.com/azure/aks/advanced-network-observability-cli?tabs=cilium" target="_blank" rel="noopener noreferrer">Set up Advanced Network Observability for Azure Kubernetes Service (AKS)</a></li>
<li><a href="https://learn.microsoft.com/azure/storage/container-storage/install-container-storage-aks" target="_blank" rel="noopener noreferrer">Install Azure Container Storage for use with Azure Kubernetes Service</a></li>
<li><a href="https://learn.microsoft.com/azure/kubernetes-fleet/concepts-resource-propagation" target="_blank" rel="noopener noreferrer">Kubernetes resource propagation from hub cluster to member clusters</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/Azure-Samples/aks-labs/tree/main/docs/advanced-aks/advanced-aks-scenarios.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/aks-labs/docs/category/advanced-aks"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Advanced AKS</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/aks-labs/docs/category/ai-on-aks"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">AI on AKS</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a><ul><li><a href="#objectives" class="table-of-contents__link toc-highlight">Objectives</a></li></ul></li><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a><ul><li><a href="#command-line-tools" class="table-of-contents__link toc-highlight">Command Line Tools</a></li></ul></li><li><a href="#lab-environment-setup" class="table-of-contents__link toc-highlight">Lab Environment Setup</a><ul><li><a href="#deploy-azure-resources-using-bicep" class="table-of-contents__link toc-highlight">Deploy Azure resources using Bicep</a></li><li><a href="#aks-deployment-strategies" class="table-of-contents__link toc-highlight">AKS Deployment Strategies</a></li><li><a href="#creating-an-aks-cluster" class="table-of-contents__link toc-highlight">Creating an AKS Cluster</a></li><li><a href="#adding-a-user-node-pool" class="table-of-contents__link toc-highlight">Adding a User Node Pool</a></li><li><a href="#tainting-the-system-node-pool" class="table-of-contents__link toc-highlight">Tainting the System Node Pool</a></li><li><a href="#enabling-aks-monitoring-and-logging" class="table-of-contents__link toc-highlight">Enabling AKS Monitoring and Logging</a></li><li><a href="#deploying-the-aks-store-demo-application" class="table-of-contents__link toc-highlight">Deploying the AKS Store Demo Application</a></li></ul></li><li><a href="#advanced-networking-concepts" class="table-of-contents__link toc-highlight">Advanced Networking Concepts</a><ul><li><a href="#advanced-container-networking-services" class="table-of-contents__link toc-highlight">Advanced Container Networking Services</a></li><li><a href="#enforcing-network-policy" class="table-of-contents__link toc-highlight">Enforcing Network Policy</a></li><li><a href="#configuring-fqdn-filtering" class="table-of-contents__link toc-highlight">Configuring FQDN Filtering</a></li><li><a href="#monitoring-advanced-network-metrics-and-flows" class="table-of-contents__link toc-highlight">Monitoring Advanced Network Metrics and Flows</a></li><li><a href="#visualize-traffic-with-hubble-ui" class="table-of-contents__link toc-highlight">Visualize traffic with Hubble UI</a></li><li><a href="#istio-service-mesh" class="table-of-contents__link toc-highlight">Istio Service Mesh</a></li></ul></li><li><a href="#advanced-storage-concepts" class="table-of-contents__link toc-highlight">Advanced Storage Concepts</a><ul><li><a href="#storage-options" class="table-of-contents__link toc-highlight">Storage Options</a></li><li><a href="#orchestration-options" class="table-of-contents__link toc-highlight">Orchestration Options</a></li><li><a href="#use-azure-container-storage-for-replicated-ephemeral-nvme-disk" class="table-of-contents__link toc-highlight">Use Azure Container Storage for Replicated Ephemeral NVMe Disk</a></li></ul></li><li><a href="#advanced-security-concepts" class="table-of-contents__link toc-highlight">Advanced Security Concepts</a><ul><li><a href="#workload-identity" class="table-of-contents__link toc-highlight">Workload Identity</a></li><li><a href="#secure-supply-chain" class="table-of-contents__link toc-highlight">Secure Supply Chain</a></li></ul></li><li><a href="#advanced-observability-concepts" class="table-of-contents__link toc-highlight">Advanced Observability Concepts</a><ul><li><a href="#aks-control-plane-metrics" class="table-of-contents__link toc-highlight">AKS control plane metrics</a></li><li><a href="#custom-scrape-jobs-for-azure-managed-prometheus" class="table-of-contents__link toc-highlight">Custom scrape jobs for Azure Managed Prometheus</a></li><li><a href="#aks-cost-analysis" class="table-of-contents__link toc-highlight">AKS Cost Analysis</a></li></ul></li><li><a href="#update-and-multi-cluster-management" class="table-of-contents__link toc-highlight">Update and Multi-Cluster Management</a><ul><li><a href="#api-server-upgrades" class="table-of-contents__link toc-highlight">API Server upgrades</a></li><li><a href="#node-image-updates" class="table-of-contents__link toc-highlight">Node image updates</a></li><li><a href="#maintenance-windows" class="table-of-contents__link toc-highlight">Maintenance windows</a></li><li><a href="#managing-multiple-aks-clusters-with-azure-fleet" class="table-of-contents__link toc-highlight">Managing Multiple AKS Clusters with Azure Fleet</a></li></ul></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a><ul><li><a href="#additional-resources" class="table-of-contents__link toc-highlight">Additional Resources</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Microsoft. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>