<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-aks-automatic/workshop" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Getting Started with Azure Kubernetes Service (AKS) Automatic | AKS LABS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://azure-samples.github.io/aks-labs/img/aks-labs-social-card.png"><meta data-rh="true" name="twitter:image" content="https://azure-samples.github.io/aks-labs/img/aks-labs-social-card.png"><meta data-rh="true" property="og:url" content="https://azure-samples.github.io/aks-labs/docs/aks-automatic/workshop"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Getting Started with Azure Kubernetes Service (AKS) Automatic | AKS LABS"><meta data-rh="true" name="description" content="This workshop will guide you up to speed with working with Azure Kubernetes Service (AKS) Automatic. AKS Automatic is a new way to deploy and manage Kubernetes clusters on Azure. It is a fully managed Kubernetes service that simplifies the deployment, management, and operations of Kubernetes clusters. With AKS Automatic, you can deploy a Kubernetes cluster with just a few clicks in the Azure Portal. AKS Automatic is designed to be simple and easy to use, so you can focus on building and running your applications."><meta data-rh="true" property="og:description" content="This workshop will guide you up to speed with working with Azure Kubernetes Service (AKS) Automatic. AKS Automatic is a new way to deploy and manage Kubernetes clusters on Azure. It is a fully managed Kubernetes service that simplifies the deployment, management, and operations of Kubernetes clusters. With AKS Automatic, you can deploy a Kubernetes cluster with just a few clicks in the Azure Portal. AKS Automatic is designed to be simple and easy to use, so you can focus on building and running your applications."><link data-rh="true" rel="icon" href="/aks-labs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://azure-samples.github.io/aks-labs/docs/aks-automatic/workshop"><link data-rh="true" rel="alternate" href="https://azure-samples.github.io/aks-labs/docs/aks-automatic/workshop" hreflang="en"><link data-rh="true" rel="alternate" href="https://azure-samples.github.io/aks-labs/docs/aks-automatic/workshop" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/aks-labs/blog/rss.xml" title="AKS LABS RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/aks-labs/blog/atom.xml" title="AKS LABS Atom Feed"><link rel="stylesheet" href="/aks-labs/assets/css/styles.56ddccda.css">
<script src="/aks-labs/assets/js/runtime~main.f1d0a99d.js" defer="defer"></script>
<script src="/aks-labs/assets/js/main.2f149359.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/aks-labs/img/aks-logo-icon.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/aks-labs/"><div class="navbar__logo"><img src="/aks-labs/img/aks-logo-icon.svg" alt="AKS Labs Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/aks-labs/img/aks-logo-icon.svg" alt="AKS Labs Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">AKS LABS</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/aks-labs/docs/intro">Workshops</a><a class="navbar__item navbar__link" href="/aks-labs/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/russd2357/aks-labs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/aks-labs/docs/intro">Workshop Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/getting-started-with-k8s-on-aks">Getting Started with K8s on AKS</a><button aria-label="Expand sidebar category &#x27;Getting Started with K8s on AKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/aks-labs/docs/category/aks-automatic">AKS Automatic</a><button aria-label="Collapse sidebar category &#x27;AKS Automatic&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/aks-labs/docs/aks-automatic/workshop">Getting Started with Azure Kubernetes Service (AKS) Automatic</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/operating-aks-automatic">Operating AKS Automatic</a><button aria-label="Expand sidebar category &#x27;Operating AKS Automatic&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/advanced-aks">Advanced AKS</a><button aria-label="Expand sidebar category &#x27;Advanced AKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/ai-on-aks">AI on AKS</a><button aria-label="Expand sidebar category &#x27;AI on AKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/tutorial---basics">Tutorial - Basics</a><button aria-label="Expand sidebar category &#x27;Tutorial - Basics&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/aks-labs/docs/category/tutorial---extras">Tutorial - Extras</a><button aria-label="Expand sidebar category &#x27;Tutorial - Extras&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/aks-labs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/aks-labs/docs/category/aks-automatic"><span itemprop="name">AKS Automatic</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Getting Started with Azure Kubernetes Service (AKS) Automatic</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Getting Started with Azure Kubernetes Service (AKS) Automatic</h1></header>
<p>This workshop will guide you up to speed with working with Azure Kubernetes Service (AKS) Automatic. AKS Automatic is a new way to deploy and manage Kubernetes clusters on Azure. It is a fully managed Kubernetes service that simplifies the deployment, management, and operations of Kubernetes clusters. With AKS Automatic, you can deploy a Kubernetes cluster with just a few clicks in the Azure Portal. AKS Automatic is designed to be simple and easy to use, so you can focus on building and running your applications.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="objectives">Objectives<a href="#objectives" class="hash-link" aria-label="Direct link to Objectives" title="Direct link to Objectives">​</a></h2>
<p>After completing this workshop, you will be able to:</p>
<ul>
<li>Deploy an AKS Automatic cluster</li>
<li>Connect to the AKS cluster and deploy applications</li>
<li>Implement resiliency in your application using Kubernetes Deployments</li>
<li>Scale your cluster and application</li>
<li>Monitor your cluster and application</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h2>
<p>Before you begin, you will need an <a href="https://azure.microsoft.com/" target="_blank" rel="noopener noreferrer">Azure subscription</a> with permissions to create resources and a <a href="https://github.com/signup" target="_blank" rel="noopener noreferrer">GitHub account</a>.</p>
<p>In addition, you will need the following tools installed on your local machine:</p>
<ul>
<li><a href="https://learn.microsoft.com/cli/azure/what-is-azure-cli?WT.mc_id=containers-105184-pauyu" target="_blank" rel="noopener noreferrer">Azure CLI</a></li>
<li><a href="https://code.visualstudio.com/" target="_blank" rel="noopener noreferrer">Visual Studio Code</a></li>
<li><a href="https://git-scm.com/" target="_blank" rel="noopener noreferrer">Git</a></li>
<li>Bash shell (e.g. <a href="https://www.microsoft.com/p/windows-terminal/9n0dx20hk701" target="_blank" rel="noopener noreferrer">Windows Terminal</a> with <a href="https://docs.microsoft.com/windows/wsl/install-win10" target="_blank" rel="noopener noreferrer">WSL</a> or <a href="https://shell.azure.com" target="_blank" rel="noopener noreferrer">Azure Cloud Shell</a>)</li>
</ul>
<div class="info" data-title="Note"><blockquote>
<p>The Azure Cloud Shell is a free interactive shell that you can use to run the Azure CLI, kubectl, and other tools. It is already configured to use your Azure subscription and is a great way to run commands without having to install anything on your local machine. However, there are some limitations to the Azure Cloud Shell, such as not being able to port-forward to a pod or run a local development environment so it is recommended to use a local shell for this workshop.</p>
</blockquote></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="workshop-instructions">Workshop instructions<a href="#workshop-instructions" class="hash-link" aria-label="Direct link to Workshop instructions" title="Direct link to Workshop instructions">​</a></h2>
<p>When you see these blocks of text, you should follow the instructions below.</p>
<div class="info" data-title="Info"><blockquote>
<p>This means there&#x27;s some additional context.</p>
</blockquote></div>
<div class="tip" data-title="Tip"><blockquote>
<p>This means you should pay attention to some helpful tips.</p>
</blockquote></div>
<div class="warning" data-title="Warning"><blockquote>
<p>This means you should pay attention to some information.</p>
</blockquote></div>
<div class="important" data-title="Important"><blockquote>
<p>This means you should <strong><em>really</em></strong> pay attention to some information.</p>
</blockquote></div>
<hr>
<h1>Deploy your AKS Cluster</h1>
<p>There are several ways to deploy an AKS cluster, including the <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">Azure Portal</a> , <a href="https://learn.microsoft.com/cli/azure/" target="_blank" rel="noopener noreferrer">Azure CLI</a>, <a href="https://learn.microsoft.com/azure/azure-resource-manager/templates/overview" target="_blank" rel="noopener noreferrer">ARM templates</a>, <a href="https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?tabs=bicep" target="_blank" rel="noopener noreferrer">Azure Bicep</a>, <a href="https://learn.microsoft.com/azure/developer/terraform/overview" target="_blank" rel="noopener noreferrer">Terraform</a>, and <a href="https://www.pulumi.com/azure/" target="_blank" rel="noopener noreferrer">Pulumi</a>, just to name a few. While there are no shortages of ways to deploy an AKS cluster, we will focus on the Azure Portal and Azure CLI in this workshop.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="familiarize-yourself-with-aks-presets-in-portal">Familiarize yourself with AKS Presets in portal<a href="#familiarize-yourself-with-aks-presets-in-portal" class="hash-link" aria-label="Direct link to Familiarize yourself with AKS Presets in portal" title="Direct link to Familiarize yourself with AKS Presets in portal">​</a></h2>
<p>Open a browser and navigate to the Azure portal then login with your Azure credentials.</p>
<p>In the search bar at the top of the portal, start typing <strong>kubernetes</strong> and you will start to see a list of services, marketplace items, and resources that match your search. In the list, click on <strong>Kubernetes services</strong> which is found under <strong>Services</strong>.</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal Kubernetes Services" src="/aks-labs/assets/images/azure-portal-kubernetes-services-51340da3bea140fe13bf933e2d72dcc1.png" width="2501" height="1395" class="img_ev3q"></p>
<p>In the <strong>Kubernetes services</strong> screen, click on the <strong>Create</strong> drop down, skip over the automatic option and click on <strong>Kubernetes cluster</strong></p>
<p><img decoding="async" loading="lazy" alt="Azure Portal Create Kubernetes Cluster" src="/aks-labs/assets/images/azure-portal-create-kubernetes-cluster-28f3b75f8a54e3e98ef969f571b91645.png" width="2501" height="1395" class="img_ev3q"></p>
<p>You should now see the <strong>Create Kubernetes cluster</strong> screen. This is where you can create a new AKS cluster.</p>
<p>Across the top of the screen, you&#x27;ll notice a series of tabs. Under <strong>Cluster details</strong> in the <strong>Basics</strong> tab, you&#x27;ll see the <strong>Cluster preset configuration</strong>. This is where you can choose from a series of presets that will automatically configure your AKS cluster based on your workload requirements.</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal Create Kubernetes Cluster Basics" src="/aks-labs/assets/images/azure-portal-create-kubernetes-cluster-basics-9d880dfe6930abd8408dbabeb23d497d.png" width="2501" height="1395" class="img_ev3q"></p>
<p>Click the <strong>Compare presets</strong> link to see the differences between the presets.</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal Kubernetes Preset Configurations" src="/aks-labs/assets/images/azure-portal-kubernetes-preset-configurations-1d5cb6bfb6e40d3e0fd2f918fe8b00ce.png" width="2501" height="1395" class="img_ev3q"></p>
<p>You should see a table that lists all the presets and the differences between them. By default, the <strong>Production Standard</strong> preset is selected.</p>
<p>Click <strong>Cancel</strong> to back out of the cluster preset comparison window.</p>
<p>You will also notice that the cluster preset can be selected from the drop down menu. Toggle between <strong>Dev/Test</strong> and <strong>Production Enterprise</strong> and notice how the configuration options change.</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal Kubernetes Preset Configurations" src="/aks-labs/assets/images/azure-portal-kubernetes-preset-configuration-selection-2f4e24cd19b7f2eed7104990b6723af7.png" width="2501" height="1395" class="img_ev3q"></p>
<p>Going back to the tabs at the top of the screen, click through the <strong>Node pools</strong>, <strong>Networking</strong>, <strong>Integrations</strong>, <strong>Monitoring</strong>, and <strong>Advanced</strong> tabs to see additional configuration options available to you.</p>
<p>That&#x27;s a lot of options! But what if you just want to create an AKS cluster without all the fuss? That&#x27;s where <strong>Automatic AKS Cluster</strong> comes in.</p>
<p>Click the <strong>X</strong> icon in the upper right corner to back out of the create cluster window.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-aks-automatic-cluster">Deploy AKS Automatic Cluster<a href="#deploy-aks-automatic-cluster" class="hash-link" aria-label="Direct link to Deploy AKS Automatic Cluster" title="Direct link to Deploy AKS Automatic Cluster">​</a></h2>
<p>Click on the <strong>Create</strong> drop down again but this time, click <strong>Automatic Kubernetes cluster (preview)</strong>.</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal Create Automatic Kubernetes Cluster" src="/aks-labs/assets/images/azure-portal-create-aks-automatic-cluster-dcf83216d2b05e9815af6f63272fa9b5.png" width="2501" height="1395" class="img_ev3q"></p>
<p>You can see that the configuration options are much simpler. There&#x27;s only a <strong>Basics</strong> and <strong>Monitoring</strong> tab.</p>
<p><img decoding="async" loading="lazy" alt="Azure Portal Create Automatic Kubernetes Cluster" src="/aks-labs/assets/images/azure-portal-create-aks-automatic-cluster-options-30c1494fdf8af99ea6268e53fa1e26d6.png" width="2501" height="1395" class="img_ev3q"></p>
<p>In the <strong>Basics</strong> tab, fill out the following fields:</p>
<ul>
<li>
<p><strong>Subscription:</strong> Select your Azure subscription.</p>
</li>
<li>
<p><strong>Resource group:</strong> Create a new resource group or use an existing one.</p>
</li>
<li>
<p><strong>Kubernetes cluster name:</strong> Enter a name for your cluster.</p>
</li>
<li>
<p><strong>Region:</strong> Select the desired region where you want to deploy your cluster.</p>
<div class="info" data-title="Note"><blockquote>
<p>Make sure your subscription has quota for 16 vCPUs of any of the following SKUs in the region you&#x27;re deploying the cluster to:</p>
<ul>
<li>Standard_D4pds_v5</li>
<li>Standard_D4lds_v5</li>
<li>Standard_D4ads_v5</li>
<li>Standard_D4ds_v5</li>
<li>Standard_D4d_v5</li>
<li>Standard_D4d_v4</li>
<li>Standard_DS3_v2</li>
<li>Standard_DS12_v2</li>
</ul>
<p>You can view quotas for specific VM-families and submit quota increase requests through the Azure portal. See this <a href="https://learn.microsoft.com/azure/quotas/quickstart-increase-quota-portal" target="_blank" rel="noopener noreferrer">guide</a> for more info.</p>
</blockquote></div>
</li>
<li>
<p><strong>Automatic upgrade scheduler:</strong> Leave the default setting.</p>
</li>
<li>
<p><strong>Access control:</strong>: AKS Automatic uses <a href="https://learn.microsoft.com/azure/aks/manage-azure-rbac?tabs=azure-cli" target="_blank" rel="noopener noreferrer">Microsoft Entra ID authentication with Azure RBAC</a> for cluster access. You can add additional users or groups to the cluster after it&#x27;s created, but that is outside the scope of this workshop.</p>
</li>
</ul>
<p>In the <strong>Monitoring</strong> tab, you have the option to either link existing monitoring resources or create new ones. We&#x27;ll go ahead and create new monitoring resources.</p>
<ul>
<li><strong>Enable Container Logs:</strong> Make sure the checkbox is checked to enable Container Insights.</li>
<li><strong>Log Analytics Workspace:</strong> Leave the default setting to create a new Log Analytics workspace.</li>
<li><strong>Cost Preset:</strong> Leave the default setting of <strong>Standard</strong>.</li>
<li><strong>Enable Prometheus metrics:</strong> Make sure the checkbox is checked to enable Prometheus metrics.</li>
<li><strong>Azure Monitor workspace:</strong> Leave the default setting to create a new Azure Monitor workspace.</li>
<li><strong>Enable Grafana:</strong> Make sure the checkbox is checked to enable Grafana.</li>
<li><strong>Grafana workspace:</strong> Leave the default setting to create a new Grafana workspace.</li>
<li><strong>Enable recommended alerts:</strong> Make sure the checkbox is checked to enable recommended alerts.</li>
</ul>
<p>Click the <strong>Review + create</strong> button then after validation passes, click the <strong>Create</strong> button.</p>
<div class="info" data-title="Note"><blockquote>
<p>The cluster creation process will take about 10-15 minutes to complete.</p>
</blockquote></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="connect-to-aks-cluster">Connect to AKS cluster<a href="#connect-to-aks-cluster" class="hash-link" aria-label="Direct link to Connect to AKS cluster" title="Direct link to Connect to AKS cluster">​</a></h2>
<p>The <a href="https://kubernetes.io/docs/reference/kubectl/" target="_blank" rel="noopener noreferrer">kubectl</a> command line tool is your direct line of communication with the Kubernetes API server and is most common way to interact with a Kubernetes cluster. Authentication and authorization to the Kubernetes API server is controlled by the <a href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/" target="_blank" rel="noopener noreferrer">kubeconfig file</a>. This file contains the necessary certificate information to authenticate against the Kubernetes API server, and the Azure CLI for AKS has a handy command to get the kubeconfig file for your AKS cluster.</p>
<p>Before we do anything with Azure CLI for AKS, open a new terminal and run the following command to install the AKS preview extension for the Azure CLI. This extension will allow you to work with preview features of AKS.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az extension add --name aks-preview</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next run the following command to add a variable local .env file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt; .env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RG_NAME=&quot;&lt;resource-group-name&gt;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="important" data-title="Important"><blockquote>
<p>Be sure to replace <code>&lt;resource-group-name&gt;</code> with the resource group name where the AKS cluster was deployed.</p>
</blockquote></div>
<p>Source the file to load the environment variables.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source .env</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to get the name of your AKS cluster, add it to the .env file, and source the file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt;&gt; .env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AKS_NAME=&quot;$(az aks list -g $RG_NAME --query &quot;[0].name&quot; -o tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MC_RG_NAME=&quot;$(az aks show --name $AKS_NAME --resource-group $RG_NAME --query nodeResourceGroup -o tsv)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source .env</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to download the kubeconfig file for your AKS cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks get-credentials --resource-group ${RG_NAME} --name ${AKS_NAME}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now you should be able to run kubectl commands against your AKS cluster. But if you do not already have kubectl installed, run the following command to install it.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks install-cli</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to verify that you can connect to the AKS cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl cluster-info</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When running a kubectl command for the first time, you will be presented with a login prompt. Follow the instructions on the screen and proceed with the authorization process and the kubectl command will be executed.</p>
<p><img decoding="async" loading="lazy" alt="Azure Cloud Shell kubectl login" src="/aks-labs/assets/images/azure-cloud-shell-kubectl-login-3612c1d7a94bb68b926f54126d7188c3.png" width="2501" height="1395" class="img_ev3q"></p>
<div class="info" data-title="Knowledge"><blockquote>
<p>AKS Automatic clusters are secured by default. It uses <a href="https://www.microsoft.com/security/business/identity-access/microsoft-entra-id" target="_blank" rel="noopener noreferrer">Microsoft Entra ID</a> authentication with Azure RBAC for cluster access, so simply downloading the kubeconfig file is not enough to access the cluster. You also need to authenticate with Microsoft Entra ID and have the necessary permissions to access the cluster. When you created the AKS Automatic cluster, you were automatically granted the <strong>Azure Kubernetes Service RBAC Cluster Admin</strong> role assignment to access the cluster.</p>
</blockquote></div>
<p>If you can see the cluster information printed in your terminal, your cluster is up and ready to host applications. But there is a little bit more prep work we need to do. We need to prepare the cluster for our application containers.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="container-registries">Container Registries<a href="#container-registries" class="hash-link" aria-label="Direct link to Container Registries" title="Direct link to Container Registries">​</a></h2>
<p>Kubernetes is a container orchestrator. It will run whatever container image you tell it to run. Containers can be pulled from public container registries like <a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer">Docker Hub</a> or <a href="https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry" target="_blank" rel="noopener noreferrer">GitHub Container Registry (GHCR)</a>, or they can be pulled from private container registries like <a href="https://azure.microsoft.com/products/container-registry" target="_blank" rel="noopener noreferrer">Azure Container Registry (ACR)</a>. Pulling images from a public registry is fine for development and testing but for production workloads, you&#x27;ll want to use a private registry and only deploy images that have been scanned for vulnerabilities and approved.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-azure-container-registry-acr">Deploy Azure Container Registry (ACR)<a href="#deploy-azure-container-registry-acr" class="hash-link" aria-label="Direct link to Deploy Azure Container Registry (ACR)" title="Direct link to Deploy Azure Container Registry (ACR)">​</a></h3>
<p>ACR is a managed, private Docker registry service based on the open-source Docker Registry 2.0. It is highly available and scalable across Azure regions across the globe. It also integrates with Microsoft Entra ID for authentication and authorization so it makes it easy to secure your container images.</p>
<p>In the terminal, run the following command to create an environment variable for your new Azure Container Registry name, add it to the .env file, and source the file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;EOF &gt;&gt; .env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ACR_NAME=&quot;acr$(date +%s)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source .env</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to create a new Azure Container Registry.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az acr create \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${ACR_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--sku Standard</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="attach-acr-to-aks-cluster">Attach ACR to AKS cluster<a href="#attach-acr-to-aks-cluster" class="hash-link" aria-label="Direct link to Attach ACR to AKS cluster" title="Direct link to Attach ACR to AKS cluster">​</a></h3>
<p>With the Azure Container Registry created, you need to &quot;attach&quot; it to your AKS cluster. This will allow your AKS cluster to pull images from the Azure Container Registry by granting the AKS resource&#x27;s managed identity the <strong>AcrPull</strong> role on the Azure Container Registry.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks update \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--attach-acr ${ACR_NAME}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will take a few minutes to complete so you can move on to the next section.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="import-container-images">Import container images<a href="#import-container-images" class="hash-link" aria-label="Direct link to Import container images" title="Direct link to Import container images">​</a></h2>
<p>We will be using a sample application called <a href="https://github.com/Azure-Samples/aks-store-demo" target="_blank" rel="noopener noreferrer">aks-store-demo</a>. This application is a simple e-commerce store that consists of three services: <strong>store-front</strong>, <strong>order-service</strong>, and <strong>product-service</strong>.</p>
<ul>
<li><a href="https://github.com/Azure-Samples/aks-store-demo/tree/main/src/store-front" target="_blank" rel="noopener noreferrer">store-front</a> is a web UI that allows users to browse products, add products to a cart, and checkout</li>
<li><a href="https://github.com/Azure-Samples/aks-store-demo/tree/main/src/product-service" target="_blank" rel="noopener noreferrer">product-service</a> is a RESTful API that provides product information to the store-front service</li>
<li><a href="https://github.com/Azure-Samples/aks-store-demo/tree/main/src/order-service" target="_blank" rel="noopener noreferrer">order-service</a> is a RESTful API that handles order processing and saves order to a <a href="https://www.rabbitmq.com/" target="_blank" rel="noopener noreferrer">RabbitMQ</a> message queue</li>
</ul>
<p>Here is a high-level application architecture diagram:</p>
<p><img decoding="async" loading="lazy" src="https://learn.microsoft.com/azure/aks/learn/media/quick-kubernetes-deploy-portal/aks-store-architecture.png#lightbox" alt="AKS Store Demo Application Architecture" class="img_ev3q"></p>
<p>The application containers are hosted on GHCR. Rather than building the containers from source, we will import the containers from GHCR to ACR using the <a href="https://learn.microsoft.com/cli/azure/acr?view=azure-cli-latest#az-acr-import" target="_blank" rel="noopener noreferrer">az acr import</a> command. This will allow us to use the containers in the AKS cluster without having to build them ourselves.</p>
<p>Run the following commands to import the application container images from GHCR into ACR. We&#x27;ll be importing two versions of each application: 1.2.0 and 1.5.0.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># store-front version 1.2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az acr import \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${ACR_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--source ghcr.io/azure-samples/aks-store-demo/store-front:1.2.0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--image aks-store-demo/store-front:1.2.0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--no-wait</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># store-front version 1.5.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az acr import \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${ACR_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--source ghcr.io/azure-samples/aks-store-demo/store-front:1.5.0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--image aks-store-demo/store-front:1.5.0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--no-wait</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># order-service version 1.2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az acr import \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${ACR_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--source ghcr.io/azure-samples/aks-store-demo/order-service:1.2.0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--image aks-store-demo/order-service:1.2.0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--no-wait</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># order-service version 1.5.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az acr import \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${ACR_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--source ghcr.io/azure-samples/aks-store-demo/order-service:1.5.0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--image aks-store-demo/order-service:1.5.0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--no-wait</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># product-service version 1.2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az acr import \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${ACR_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--source ghcr.io/azure-samples/aks-store-demo/product-service:1.2.0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--image aks-store-demo/product-service:1.2.0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--no-wait</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># product-service version 1.5.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az acr import \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${ACR_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--source ghcr.io/azure-samples/aks-store-demo/product-service:1.5.0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--image aks-store-demo/product-service:1.5.0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--no-wait</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to ensure the import operations have completed.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">for repo in $(az acr repository list -n $ACR_NAME -o tsv); do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  echo &quot;${repo} tags:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  az acr repository show-tags -n $ACR_NAME --repository $repo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you see tags for each repository, the import operations have completed.</p>
<hr>
<h1>Deploy Store App to AKS</h1>
<p>There is a <a href="https://github.com/Azure-Samples/aks-store-demo/blob/main/aks-store-quickstart.yaml" target="_blank" rel="noopener noreferrer">YAML manifest</a> in the repo that contains the deployment and service resources for the store-front, order-service, and product-service, and RabbitMQ. We will deploy this manifest to the AKS cluster.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="updating-deployment-manifests">Updating Deployment manifests<a href="#updating-deployment-manifests" class="hash-link" aria-label="Direct link to Updating Deployment manifests" title="Direct link to Updating Deployment manifests">​</a></h2>
<p>Before we deploy the manifest, we need to make a few changes. The manifest in the repo references the images on GHCR. We need to replace the image references with the images we imported to ACR.</p>
<p>Run the following command to download the YAML file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -o aks-store-quickstart.yaml https://raw.githubusercontent.com/Azure-Samples/aks-store-demo/main/aks-store-quickstart.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to replace all instances of <code>ghcr.io/azure-samples</code> with <code>${ACR_NAME}.azurecr.io</code> and the tag <code>latest</code> with <code>1.2.0</code> in the aks-store-quickstart.yaml file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sed -i -e &quot;s|ghcr.io/azure-samples/\(.*\):latest|${ACR_NAME}.azurecr.io/\1:1.2.0|g&quot; aks-store-quickstart.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to apply the manifest.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f aks-store-quickstart.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to check the status of the pods.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -w</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="info" data-title="Note"><blockquote>
<p>The deployment can take up a few minutes to schedule pods onto a new node. This is because the <a href="https://learn.microsoft.com/azure/aks/node-autoprovision?tabs=azure-cli" target="_blank" rel="noopener noreferrer">AKS Node Autoprovisioning feature (aka Karpenter)</a> is enabled in the AKS Automatic cluster and it will automatically provision new nodes when needed.</p>
</blockquote></div>
<p>Press <strong>Ctrl+C</strong> to exit the watch and proceed to the next step.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-familiar-with-the-kubernetes-resources">Getting familiar with the Kubernetes resources<a href="#getting-familiar-with-the-kubernetes-resources" class="hash-link" aria-label="Direct link to Getting familiar with the Kubernetes resources" title="Direct link to Getting familiar with the Kubernetes resources">​</a></h2>
<p>While we wait for the pods to roll out, let&#x27;s take a closer look at the resources that were created when we applied the manifest to the Kubernetes cluster.</p>
<p>Back in the terminal, run the following command to view the contents of the YAML file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">less aks-store-quickstart.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="tip" data-title="Tip"><blockquote>
<p>Press <strong>up</strong> or <strong>down</strong> arrow keys to scroll through the file. Press <strong>q</strong> to exit the file.</p>
</blockquote></div>
<p>If you look at the YAML file, you&#x27;ll see that it contains a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener noreferrer">Deployment</a> and <a href="https://kubernetes.io/docs/concepts/services-networking/service/" target="_blank" rel="noopener noreferrer">Service</a> resource for each of the three services: <strong>store-front</strong>, <strong>product-service</strong>, and <strong>order-service</strong>. It also contains a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/" target="_blank" rel="noopener noreferrer">StatefulSet</a>, Service, and <a href="https://kubernetes.io/docs/concepts/configuration/configmap/" target="_blank" rel="noopener noreferrer">ConfigMap</a> resource for RabbitMQ.</p>
<p>The manifest is the desired state of the resources in the cluster. When you apply the manifest, the Kubernetes API server will create the resources in the cluster to match the desired state.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deployments">Deployments<a href="#deployments" class="hash-link" aria-label="Direct link to Deployments" title="Direct link to Deployments">​</a></h3>
<p>Each deployment resource specifies the container image to use, the ports to expose, environment variables, and resource requests and limits. The deployment manages <a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/" target="_blank" rel="noopener noreferrer">ReplicaSets</a> and a ReplicaSet is a resource that ensures a specified number of pod replicas are running at any given time.</p>
<p>Run the following command to view the Deployments.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get deployments</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can see there are three Deployments: <strong>order-service</strong>, <strong>product-service</strong>, and <strong>store-front</strong>. As mentioned above, the deployment created a ReplicaSet which in turn created a set of identical <a href="https://kubernetes.io/docs/concepts/workloads/pods/" target="_blank" rel="noopener noreferrer">pods</a>. In the sample app, each deployment has a single replica.</p>
<p>If you want to see individual pods, you can run the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A pod is where your application code runs and is the smallest deployable unit in Kubernetes. It represents a single instance of a running process in your cluster. If you need to troubleshoot an application, you can view the logs of the pod by running the <strong>logs</strong> command like this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl logs rabbitmq-0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="services">Services<a href="#services" class="hash-link" aria-label="Direct link to Services" title="Direct link to Services">​</a></h3>
<p>A Service is a resource that exposes an application running in a set of pods as a network service. It provides a stable endpoint for the application that can be accessed by other applications in the cluster or outside the cluster.</p>
<p>Run the following command to view the Services.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="statefulsets">StatefulSets<a href="#statefulsets" class="hash-link" aria-label="Direct link to StatefulSets" title="Direct link to StatefulSets">​</a></h3>
<p>The StatefulSet is a resource that manages a set of identical pods with persistent storage and commonly used for stateful applications like databases and data stores.</p>
<p>Run the following command to view the StatefulSets.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get statefulsets</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can see that there is a StatefulSet for RabbitMQ. The StatefulSet resource is used to manage the RabbitMQ pods and ensure that the pods are created in a specific order.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configmaps">ConfigMaps<a href="#configmaps" class="hash-link" aria-label="Direct link to ConfigMaps" title="Direct link to ConfigMaps">​</a></h3>
<p>The ConfigMap resource is used to store configuration data in key-value pairs. The ConfigMap resource is used to store the configuration data for RabbitMQ.</p>
<p>Run the following command to view the ConfigMaps.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get configmaps</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="test-the-demo-app">Test the demo app<a href="#test-the-demo-app" class="hash-link" aria-label="Direct link to Test the demo app" title="Direct link to Test the demo app">​</a></h2>
<p>At this point, the pods should be up and running. Run the following command to confirm that the pods are running.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If the pods are all in <strong>Running</strong> status, run the following command to get the public IP address of the <strong>store-front</strong> service so that you can access the application.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;http://$(kubectl get svc/store-front -o jsonpath=&#x27;{.status.loadBalancer.ingress[0].ip}&#x27;)&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Click the link in the terminal, and you should be taken to the product page of the AKS pet store. Here a user can browse products, add items to a shopping cart, and checkout. Add an item to the cart and checkout by clicking on the cart link in the upper right corner. You should see a confirmation message that the order was successfully placed.</p>
<div class="info" data-title="Note"><blockquote>
<p>The checkout process is intentionally simple and does not require any payment information. The order-service will save the order to a <a href="https://www.rabbitmq.com/" target="_blank" rel="noopener noreferrer">RabbitMQ</a> container running in the cluster.</p>
</blockquote></div>
<p><img decoding="async" loading="lazy" alt="Store front order submitted" src="/aks-labs/assets/images/store-front-order-submitted-a0659ba6182fd751a64e86a021e4384c.png" width="2501" height="1395" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ingress-and-app-routing-add-on">Ingress and App Routing add-on<a href="#ingress-and-app-routing-add-on" class="hash-link" aria-label="Direct link to Ingress and App Routing add-on" title="Direct link to Ingress and App Routing add-on">​</a></h2>
<p>When you looked at the YAML file, you may have noticed the service type for the <strong>store-front</strong> service is of type <a href="https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer" target="_blank" rel="noopener noreferrer">LoadBalancer</a>. This is one way to expose an application to the internet. A better way is to use an <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank" rel="noopener noreferrer">Ingress</a>. An <a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/" target="_blank" rel="noopener noreferrer">Ingress Controller</a> is a Kubernetes resource that manages inbound access to services in a cluster. It provides HTTP and HTTPS routing to services based on hostnames and paths. The Ingress Controller is responsible for reading the Ingress resource and processing the rules to configure the load balancer.</p>
<p>With AKS Automatic, the <a href="https://learn.microsoft.com/en-us/azure/aks/app-routing" target="_blank" rel="noopener noreferrer">App Routing add-on</a>, a managed NGINX Ingress Controller, is enabled by default. All you need to do is create an Ingress resource and the App Routing add-on will take care of the rest.</p>
<p>Run the following command to patch the store-front service to change the service type to <em>ClusterIP</em>. This will remove the public IP address from the service.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch service store-front -p &#x27;{&quot;spec&quot;: {&quot;type&quot;: &quot;ClusterIP&quot;}}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="info" data-title="Knowledge"><blockquote>
<p>kubectl is a powerful tool that can be used to create, update, and delete resources in a Kubernetes cluster. The <code>patch</code> command is used to update a resource in the cluster. However, it is not best practice to use <code>patch</code> to update resources. It is better to update the resource manifest and apply the changes with <code>kubectl apply</code>.</p>
</blockquote></div>
<p>Run the following command to deploy the ingress manifest for the store-front app.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: store-front</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingressClassName: webapprouting.kubernetes.azure.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - path: /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pathType: Prefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            name: store-front</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            port:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              number: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This Ingress resource is very similar to the open-source <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#the-ingress-resource" target="_blank" rel="noopener noreferrer">NGINX Ingress</a> resource with the major difference being the <code>ingressClassName</code> field being set to <code>webapprouting.kubernetes.azure.com</code>; this enables the AKS App Routing add-on to manage this resource.</p>
<p>Wait a minute or two for the ingress to be created, then run the following command to get the public IP address of the ingress.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;http://$(kubectl get ingress store-front -o jsonpath=&#x27;{.status.loadBalancer.ingress[0].ip}&#x27;)&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Click the URL in the terminal and you should be taken to the product page of the AKS pet store, this time using the Ingress to access the store-front service!</p>
<div class="important" data-title="Important"><blockquote>
<p>It is also worth mentioning that the App Routing add-on does a little more than just manage the NGINX Ingress Controller. It also provides integration with Azure DNS for automatic DNS registration and management and Azure Key Vault for automatic TLS certificate management. Check out the <a href="https://learn.microsoft.com/azure/aks/app-routing?tabs=default%2Cdeploy-app-default" target="_blank" rel="noopener noreferrer">App Routing add-on documentation</a> for more information.</p>
</blockquote></div>
<hr>
<h1>Application Resiliency</h1>
<p>As mentioned in the previous section, a Kubernetes Deployment is a resource that manages ReplicaSets. In addition to controlling the number of pod replicas, ReplicaSets play an important role in enabling you to manage application updates and rollbacks.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="deployments-and-replicasets">Deployments and ReplicaSets<a href="#deployments-and-replicasets" class="hash-link" aria-label="Direct link to Deployments and ReplicaSets" title="Direct link to Deployments and ReplicaSets">​</a></h2>
<p>The deployment resource is responsible for creating and updating the ReplicaSet. The ReplicaSet resource is responsible for creating and updating the pods. In order to keep track of the relationship between the deployment and ReplicaSet, the deployment resource sets the <code>ownerReferences</code> field in the ReplicaSet resource.</p>
<p>Run the following command to get the owner reference of the store-front ReplicaSet.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># get the name of the store-front ReplicaSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STORE_FRONT_RS_NAME=$(kubectl get rs --sort-by=.metadata.creationTimestamp | grep store-front | tail -n 1 | awk &#x27;{print $1}&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># get the details of the store-front ReplicaSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get rs $STORE_FRONT_RS_NAME -o json | jq .metadata.ownerReferences</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the output, you can see the ReplicaSet resource is owned by the store-front deployment resource. Also, note the <code>uid</code> field in the output. This is the unique identifier (<code>uid</code>) of the deployment resource.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;apiVersion&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;apps/v1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;blockOwnerDeletion&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;controller&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;kind&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Deployment&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;store-front&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;uid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;65aeeba4-5202-4fb7-9d70-ad5db0ffe1df&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If we inspect at the deployment resource, we can see the same <code>uid</code> field in the output.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get deployment store-front -o json | jq .metadata.uid</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Same goes for pods, ReplicaSets are responsible for creating and updating the pods. The pods are owned by the ReplicaSet.</p>
<p>Run the following command to get the owner reference of the store-front pod.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># get the name of the store-front pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STORE_FRONT_POD_NAME=$(kubectl get pod -l app=store-front -o jsonpath=&#x27;{.items[0].metadata.name}&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># get the details of the store-front pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod $STORE_FRONT_POD_NAME -o json | jq .metadata.ownerReferences</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As each deployment is updated, it creates a new ReplicaSet and scales it up while scaling down the old ReplicaSet. This is how Kubernetes manages application updates and rollbacks and rollout history is stored for each deployment.</p>
<p>Run the following command to view the rollout history of the store-front deployment.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout history deployment store-front</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here you can see the revision number and you should only have a single revision since we only deployed the application once.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="deployment-update-strategy">Deployment Update Strategy<a href="#deployment-update-strategy" class="hash-link" aria-label="Direct link to Deployment Update Strategy" title="Direct link to Deployment Update Strategy">​</a></h2>
<p>The default deployment strategy of a deployment resource is <em>RollingUpdate</em>. You can see that by running the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get deployments store-front -o jsonpath=&#x27;{.spec.strategy.type}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/update/update-intro/" target="_blank" rel="noopener noreferrer">RollingUpdate</a> strategy means that Kubernetes will create a new ReplicaSet and scale it up while scaling down the old ReplicaSet. If the new ReplicaSet fails to start, Kubernetes will automatically roll back to the previous ReplicaSet.</p>
<p>Run the following command to update the store-front container image to use the 1.5.0 version.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl set image deployment/store-front store-front=$ACR_NAME.azurecr.io/aks-store-demo/store-front:1.5.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="info" data-title="Note"><blockquote>
<p>Just a reminder that updating an image using imperative commands is not best practice. It is better to update the resource manifest and apply the changes with <code>kubectl apply</code>. This is just a quick way to update the image for demonstration purposes.</p>
</blockquote></div>
<p>Run the following command to check the rollout status.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout status deployment/store-front</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Wait until you see the message <strong>deployment &quot;store-front&quot; successfully rolled out</strong>.</p>
<p>Now if you run the following command, you should see two different versions of the ReplicaSet.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get rs --selector app=store-front</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see the older ReplicaSet with 0 for the DESIRED, CURRENT, and READY columns and the newer ReplicaSet with 1 for the DESIRED, CURRENT, and READY columns.</p>
<p>Run the following command to view the rollout history of the store-front deployment.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout history deployment store-front</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see two revisions in the rollout history. The first revision is the original deployment and the second revision is the updated deployment.</p>
<p>If you browse to the store-front application, you should see the new version of the application.</p>
<p><img decoding="async" loading="lazy" alt="Store front updated" src="/aks-labs/assets/images/store-front-updated-ed28332e9568469cb0c85c3c98d5b573.png" width="2501" height="1395" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rollback-a-deployment">Rollback a Deployment<a href="#rollback-a-deployment" class="hash-link" aria-label="Direct link to Rollback a Deployment" title="Direct link to Rollback a Deployment">​</a></h3>
<p>With deployment rollouts, you can easily roll back to a previous version of the application. As mentioned earlier, the rollout history is stored and you can run the following command to roll back to the previous version.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout undo deployment/store-front</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="info" data-title="Note"><blockquote>
<p>You can also roll back to a specific revision by specifying the revision number. For example, to roll back to the first revision, you can run the following command:</p>
</blockquote><blockquote>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout undo deployment/store-front --to-revision=1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</blockquote></div>
<p>If you browse to the store-front application, you should see the previous version of the application.</p>
<p><img decoding="async" loading="lazy" alt="Store front original" src="/aks-labs/assets/images/store-front-original-71b6ee38c2625cf8b72e75616ae879f2.png" width="2501" height="1395" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="dealing-with-disruptions">Dealing with Disruptions<a href="#dealing-with-disruptions" class="hash-link" aria-label="Direct link to Dealing with Disruptions" title="Direct link to Dealing with Disruptions">​</a></h2>
<p>As you may be aware, application updates can cause disruptions. However, with Kubernetes Deployments, you can manage application updates and rollbacks. But application updates are not the only disruptions that can occur. Nodes can fail or be marked for maintenance. You need to be prepared for both <a href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/" target="_blank" rel="noopener noreferrer">voluntary and involuntary disruptions</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="voluntary-disruptions">Voluntary Disruptions<a href="#voluntary-disruptions" class="hash-link" aria-label="Direct link to Voluntary Disruptions" title="Direct link to Voluntary Disruptions">​</a></h3>
<p>A voluntary disruption is a disruption that is initiated by the user. For example, you may want to scale down the number of replicas in a deployment, or you may want to take a Node down for maintenance. Kubernetes has built-in mechanisms to handle these disruptions. During a voluntary disruption, Kubernetes will gracefully remove pods from a Node.</p>
<p>In maintenance scenarios, a Node will be <a href="https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/" target="_blank" rel="noopener noreferrer">drained and cordoned</a> so that no new pods will be scheduled on the node. Any existing pod will be evicted using the <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/api-eviction/" target="_blank" rel="noopener noreferrer">Eviction API</a>. It doesn&#x27;t matter how many replicas you have running on a Node or how many replicas will be remaining after the eviction; the pod will be evicted and rescheduled on another Node. This means you can incur downtime if you are not prepared for it.</p>
<p>Good news is that Kubernetes has a built-in mechanism to handle these disruptions. The <a href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/" target="_blank" rel="noopener noreferrer">PodDisruptionBudget</a> resource allows you to specify the minimum number of Pods that must be available during a voluntary disruption.</p>
<p>When a PodDisruptionBudget is created, Kubernetes will not evict Pods if evicting it will result in a violation of the budget. Essentially the PodDisruptionBudget ensures that a minimum number of Pods remains available during a voluntary disruption.</p>
<p>To see this in action we should scale our store-front deployment to have more than one replica. Run the following command to scale the store-front deployment to 3 replicas.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl scale deployment store-front --replicas=3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With the deployment scaled to 3 replicas, we can see which nodes the Pods are running on.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod --selector app=store-front -o wide</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can see that the Pods are all running on a single Node.</p>
<p>Let&#x27;s grab the name of the Node and cordon it.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># get the name of the Node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NODE_NAME=$(kubectl get pod -l app=store-front -o jsonpath=&#x27;{.items[0].spec.nodeName}&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cordon the node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl drain $NODE_NAME --ignore-daemonsets</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see a list of all the Pods that have been evicted. It doesn&#x27;t matter that all 3 replicas of the store-front application were running on the node. Kubernetes doesn&#x27;t care and will evict all the Pods with no regard. This is where the PodDisruptionBudget comes in.</p>
<p>Run the following command to create a PodDisruptionBudget for the store-front application.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: policy/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: PodDisruptionBudget</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: store-front-pdb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  minAvailable: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: store-front</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command and wait for the Pods to be scheduled on a new node.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod --selector app=store-front -o wide -w</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When you see the Pods are in the <strong>Running</strong> state, you can press <strong>Ctrl+C</strong> to exit the watch.</p>
<p>Run the following command to drain the node again and see what happens this time with the PodDisruptionBudget in place.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># get the name of the new node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NODE_NAME=$(kubectl get pod -l app=store-front -o jsonpath=&#x27;{.items[0].spec.nodeName}&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cordon the new node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl drain $NODE_NAME --ignore-daemonsets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># watch the status of the pods and the nodes they are running on</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod --selector app=store-front -o wide -w</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Notice this time a warning message is displayed that the PodDisruptionBudget is preventing the eviction of the a store-front pod on the node due to the PodDisruptionBudget violation.</p>
<p>Once the new node is up and running, the PodDisruptionBudget will be satisfied and the remaining Pods on the node will be evicted.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="involuntary-disruptions">Involuntary Disruptions<a href="#involuntary-disruptions" class="hash-link" aria-label="Direct link to Involuntary Disruptions" title="Direct link to Involuntary Disruptions">​</a></h3>
<p>An involuntary disruption is a disruption that is not initiated by the user. For example, a node may fail and if we had all the replicas of the store-front application running on that node, we would have downtime. When running more than one replica of an application, it is important to spread the replicas across multiple nodes to ensure high availability. This is where <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity" target="_blank" rel="noopener noreferrer">PodAntiAffinity</a> or <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/" target="_blank" rel="noopener noreferrer">PodTopologySpreadConstraints</a> comes in.</p>
<ul>
<li><strong>PodAntiAffinity</strong> is a feature that allows you to specify that a pod should not be scheduled on the same node as another pod; these can be &quot;hard&quot; or &quot;soft&quot; rules</li>
<li><strong>PodTopologySpreadConstraints</strong> is a feature that allows you to specify that a pod should be spread across different zones, regions, or nodes; this is useful for ensuring high availability of your application across different failure domains.</li>
</ul>
<p>Either of these pod scheduling features can be used to ensure that your application remains available during an involuntary disruption with the difference being that PodAntiAffinity is used to spread Pods across nodes and PodTopologySpreadConstraints can provide more granular control by spreading Pods across zones and/or regions.</p>
<p>Run the following command to get the YAML manifest for the store-front deployment.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get deployment store-front -o yaml &gt; store-front-deployment.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Open the <code>store-front-deployment.yaml</code> file using the nano text editor.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nano store-front-deployment.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Update the <strong>store-front-deployment.yaml</strong> file by adding the following PodAntiAffinity rule to the <code>spec</code> section of the <strong>store-front</strong> deployment. This rule tells the Kubernetes scheduler to spread the store-front Pods using <code>topologyKey: kubernetes.io/hostname</code> which essentially means to spread the Pods across different nodes.</p>
<div class="warning" data-title="Warning"><blockquote>
<p>There are many <code>spec</code> items in the manifest, you want to add the code snippet below in the <code>spec</code> section that includes the <code>containers</code> field. Once you locate the correct <code>spec</code> section, add a new line after the <code>spec</code> field and just before the <code>containers</code> field and paste the code snippet.</p>
</blockquote></div>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">affinity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">podAntiAffinity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">labelSelector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">matchExpressions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token key atrule" style="color:#00a4db">operator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token key atrule" style="color:#00a4db">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> store</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">front</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">topologyKey</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kubernetes.io/hostname&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="tip" data-title="Tip"><blockquote>
<p>When done editing, press the <strong>Ctrl + O</strong> keys to save the file then press the Enter key. Press the <strong>Ctrl + X</strong> keys to exit the nano text editor.</p>
</blockquote></div>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Click to expand a full example updated store-front-deployment.yaml file</summary><div><div class="collapsibleContent_i85q"><p>This is what the full store-front-deployment.yaml file should look like after adding the PodAntiAffinity rule. Notice line 32 is where the PodAntiAffinity rule was added.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  1	apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2	kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  3	metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4	  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  5	    deployment.kubernetes.io/revision: &quot;3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  6	    kubectl.kubernetes.io/last-applied-configuration: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  7	      {&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;Deployment&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;store-front&quot;,&quot;namespace&quot;:&quot;default&quot;},&quot;spec&quot;:{&quot;replicas&quot;:1,&quot;selector&quot;:{&quot;matchLabels&quot;:{&quot;app&quot;:&quot;store-front&quot;}},&quot;template&quot;:{&quot;metadata&quot;:{&quot;labels&quot;:{&quot;app&quot;:&quot;store-front&quot;}},&quot;spec&quot;:{&quot;containers&quot;:[{&quot;env&quot;:[{&quot;name&quot;:&quot;VUE_APP_ORDER_SERVICE_URL&quot;,&quot;value&quot;:&quot;http://order-service:3000/&quot;},{&quot;name&quot;:&quot;VUE_APP_PRODUCT_SERVICE_URL&quot;,&quot;value&quot;:&quot;http://product-service:3002/&quot;}],&quot;image&quot;:&quot;acr1730914915.azurecr.io/aks-store-demo/store-front:1.2.0&quot;,&quot;livenessProbe&quot;:{&quot;failureThreshold&quot;:5,&quot;httpGet&quot;:{&quot;path&quot;:&quot;/health&quot;,&quot;port&quot;:8080},&quot;initialDelaySeconds&quot;:3,&quot;periodSeconds&quot;:3},&quot;name&quot;:&quot;store-front&quot;,&quot;ports&quot;:[{&quot;containerPort&quot;:8080,&quot;name&quot;:&quot;store-front&quot;}],&quot;readinessProbe&quot;:{&quot;failureThreshold&quot;:3,&quot;httpGet&quot;:{&quot;path&quot;:&quot;/health&quot;,&quot;port&quot;:8080},&quot;initialDelaySeconds&quot;:3,&quot;periodSeconds&quot;:3},&quot;resources&quot;:{&quot;limits&quot;:{&quot;cpu&quot;:&quot;1000m&quot;,&quot;memory&quot;:&quot;512Mi&quot;},&quot;requests&quot;:{&quot;cpu&quot;:&quot;1m&quot;,&quot;memory&quot;:&quot;200Mi&quot;}},&quot;startupProbe&quot;:{&quot;failureThreshold&quot;:3,&quot;httpGet&quot;:{&quot;path&quot;:&quot;/health&quot;,&quot;port&quot;:8080},&quot;initialDelaySeconds&quot;:5,&quot;periodSeconds&quot;:5}}],&quot;nodeSelector&quot;:{&quot;kubernetes.io/os&quot;:&quot;linux&quot;}}}}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  8	  creationTimestamp: &quot;2024-11-06T17:50:50Z&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  9	  generation: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 10	  name: store-front</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 11	  namespace: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 12	  resourceVersion: &quot;122662&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 13	  uid: 3a986ba7-059b-4e5c-8f0b-0ca35a59ba38</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 14	spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 15	  progressDeadlineSeconds: 600</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 16	  replicas: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 17	  revisionHistoryLimit: 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 18	  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 19	    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 20	      app: store-front</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 21	  strategy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 22	    rollingUpdate:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 23	      maxSurge: 25%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 24	      maxUnavailable: 25%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 25	    type: RollingUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 26	  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 27	    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 28	      creationTimestamp: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 29	      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 30	        app: store-front</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 31	    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 32	      affinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 33	        podAntiAffinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 34	          requiredDuringSchedulingIgnoredDuringExecution:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 35	            - labelSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 36	                matchExpressions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 37	                  - key: app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 38	                    operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 39	                    values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 40	                      - store-front</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 41	              topologyKey: &quot;kubernetes.io/hostname&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 42	      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 43	      - env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 44	        - name: VUE_APP_ORDER_SERVICE_URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 45	          value: http://order-service:3000/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 46	        - name: VUE_APP_PRODUCT_SERVICE_URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 47	          value: http://product-service:3002/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 48	        image: acr1730914915.azurecr.io/aks-store-demo/store-front:1.2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 49	        imagePullPolicy: IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 50	        livenessProbe:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 51	          failureThreshold: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 52	          httpGet:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 53	            path: /health</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 54	            port: 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 55	            scheme: HTTP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 56	          initialDelaySeconds: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 57	          periodSeconds: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 58	          successThreshold: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 59	          timeoutSeconds: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 60	        name: store-front</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 61	        ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 62	        - containerPort: 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 63	          name: store-front</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 64	          protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 65	        readinessProbe:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 66	          failureThreshold: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 67	          httpGet:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 68	            path: /health</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 69	            port: 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 70	            scheme: HTTP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 71	          initialDelaySeconds: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 72	          periodSeconds: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 73	          successThreshold: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 74	          timeoutSeconds: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 75	        resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 76	          limits:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 77	            cpu: &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 78	            memory: 512Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 79	          requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80	            cpu: 1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 81	            memory: 200Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 82	        startupProbe:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 83	          failureThreshold: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 84	          httpGet:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 85	            path: /health</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 86	            port: 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 87	            scheme: HTTP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 88	          initialDelaySeconds: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 89	          periodSeconds: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 90	          successThreshold: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 91	          timeoutSeconds: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 92	        terminationMessagePath: /dev/termination-log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 93	        terminationMessagePolicy: File</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 94	      dnsPolicy: ClusterFirst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 95	      nodeSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 96	        kubernetes.io/os: linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 97	      restartPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 98	      schedulerName: default-scheduler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 99	      securityContext: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100	      terminationGracePeriodSeconds: 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">101	status:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">102	  availableReplicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">103	  conditions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">104	  - lastTransitionTime: &quot;2024-11-06T17:50:50Z&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">105	    lastUpdateTime: &quot;2024-11-06T18:26:30Z&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">106	    message: ReplicaSet &quot;store-front-6d694c78d4&quot; has successfully progressed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">107	    reason: NewReplicaSetAvailable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">108	    status: &quot;True&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">109	    type: Progressing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">110	  - lastTransitionTime: &quot;2024-11-06T18:35:28Z&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">111	    lastUpdateTime: &quot;2024-11-06T18:35:28Z&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">112	    message: Deployment does not have minimum availability.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">113	    reason: MinimumReplicasUnavailable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">114	    status: &quot;False&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">115	    type: Available</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">116	  observedGeneration: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">117	  readyReplicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">118	  replicas: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">119	  unavailableReplicas: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">120	  updatedReplicas: 3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<p>Run the following command to replace the store-front deployment with the updated manifest.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl replace -f store-front-deployment.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to get the nodes that the store-front Pods are running on.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod --selector app=store-front -o wide -w</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="info" data-title="Note"><blockquote>
<p>It can take a few minutes for the Pods to be rescheduled onto new nodes because AKS Node Autoprovisioning (Karpenter) will need to create new nodes to satisfy the PodAntiAffinity rule.</p>
</blockquote></div>
<p>The replacement of the Pods are considered to be an update to the deployment resource. So the RollingUpdate strategy will be used to rollout new Pods before terminating the old Pods. So we&#x27;re safe from downtime during this process!</p>
<p>Once the Pods are rescheduled onto new nodes, you should see that the Pods are spread across multiple nodes.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod --selector app=store-front -o wide</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This can take a few minutes to complete. Once the Pods are rescheduled onto new nodes, you can press <strong>Ctrl+C</strong> to exit the watch. Feel free to move on to the next section while you wait.</p>
<hr>
<h1>Handling Stateful Workloads</h1>
<p>Container storage is ephemeral. If a pod is deleted, the data is lost because by default, data is saved within the container. In order to persist the data, you need to use <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/" target="_blank" rel="noopener noreferrer">Persistent Volume (PV)</a> and <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims" target="_blank" rel="noopener noreferrer">Persistent Volume Claim (PVC)</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="aks-storage-classes-and-pvcs">AKS Storage classes and PVC&#x27;s<a href="#aks-storage-classes-and-pvcs" class="hash-link" aria-label="Direct link to AKS Storage classes and PVC&#x27;s" title="Direct link to AKS Storage classes and PVC&#x27;s">​</a></h2>
<p>Typically for persistent storage in a Kubernetes cluster, you would create a PV to allocate storage and use a PVC to request a slice storage against the PV.</p>
<p>With AKS, <a href="https://learn.microsoft.com/azure/aks/csi-storage-drivers" target="_blank" rel="noopener noreferrer">Azure CSI drivers and storage classes</a> are pre-deployed into your cluster. The storage classes allow you to simply create a PVC that references a particular storage class based on your application requirements. This storage class will take care of the task of creating the PV for you, in this case, using Azure Storage.</p>
<p>Run the following command to get the list of storage classes in your AKS cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get storageclasses</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the following command to get the YAML manifest for the RabbitMQ StatefulSet.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get statefulset rabbitmq -o yaml &gt; rabbitmq-statefulset.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Open the <code>rabbitmq-statefulset.yaml</code> file using the nano text editor.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nano rabbitmq-statefulset.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Update the RabbitMQ StatefulSet by adding the following PVC spec to the <strong>rabbitmq-statefulset.yaml</strong> file. This will create a PVC that requests 1Gi of storage using the <code>managed-csi</code> storage class.</p>
<div class="warning" data-title="Warning"><blockquote>
<p>There are many <code>spec</code> items in the manifest, you want to add the code snippet at the top of the first <code>spec</code> section. So find the first <code>spec</code> section and add a new line after the <code>spec</code> field and paste the code snippet.</p>
</blockquote></div>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">volumeClaimTemplates</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rabbitmq</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">storageClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> managed</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">csi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">accessModes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ReadWriteOnce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">requests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">storage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1Gi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Keep the file open, navigate to <code>volumes</code> spec and add a new volume to the list. You should see a <code>configMap</code> volume already defined. At the end of the list, add a new line and paste the following code snippet.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rabbitmq</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">persistentVolumeClaim</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">claimName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rabbitmq</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">data</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Finally in the <code>container</code> spec, add a volume mount that references the volume. You should see a <code>volumeMounts</code> section already defined. At the end of the list, add a new line and paste the following code snippet.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /var/lib/rabbitmq/mnesia</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rabbitmq</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">data</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Save the file and exit the nano text editor.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Click to expand a full example updated rabbitmq-statefulset.yaml file</summary><div><div class="collapsibleContent_i85q"><p>This is what the full rabbitmq-statefulset.yaml file should look like after adding the storage configurations. Note the <strong>volumeClaimTemplates</strong> spec was added on line 14, the <strong>volumes</strong> spec was added on line 86, and the <strong>volumeMounts</strong> spec was added on line 69.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  1	apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2	kind: StatefulSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  3	metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4	  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  5	    kubectl.kubernetes.io/last-applied-configuration: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  6	      {&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;StatefulSet&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;rabbitmq&quot;,&quot;namespace&quot;:&quot;default&quot;},&quot;spec&quot;:{&quot;replicas&quot;:1,&quot;selector&quot;:{&quot;matchLabels&quot;:{&quot;app&quot;:&quot;rabbitmq&quot;}},&quot;serviceName&quot;:&quot;rabbitmq&quot;,&quot;template&quot;:{&quot;metadata&quot;:{&quot;labels&quot;:{&quot;app&quot;:&quot;rabbitmq&quot;}},&quot;spec&quot;:{&quot;containers&quot;:[{&quot;env&quot;:[{&quot;name&quot;:&quot;RABBITMQ_DEFAULT_USER&quot;,&quot;value&quot;:&quot;username&quot;},{&quot;name&quot;:&quot;RABBITMQ_DEFAULT_PASS&quot;,&quot;value&quot;:&quot;password&quot;}],&quot;image&quot;:&quot;mcr.microsoft.com/mirror/docker/library/rabbitmq:3.10-management-alpine&quot;,&quot;name&quot;:&quot;rabbitmq&quot;,&quot;ports&quot;:[{&quot;containerPort&quot;:5672,&quot;name&quot;:&quot;rabbitmq-amqp&quot;},{&quot;containerPort&quot;:15672,&quot;name&quot;:&quot;rabbitmq-http&quot;}],&quot;resources&quot;:{&quot;limits&quot;:{&quot;cpu&quot;:&quot;250m&quot;,&quot;memory&quot;:&quot;256Mi&quot;},&quot;requests&quot;:{&quot;cpu&quot;:&quot;10m&quot;,&quot;memory&quot;:&quot;128Mi&quot;}},&quot;volumeMounts&quot;:[{&quot;mountPath&quot;:&quot;/etc/rabbitmq/enabled_plugins&quot;,&quot;name&quot;:&quot;rabbitmq-enabled-plugins&quot;,&quot;subPath&quot;:&quot;enabled_plugins&quot;}]}],&quot;nodeSelector&quot;:{&quot;kubernetes.io/os&quot;:&quot;linux&quot;},&quot;volumes&quot;:[{&quot;configMap&quot;:{&quot;items&quot;:[{&quot;key&quot;:&quot;rabbitmq_enabled_plugins&quot;,&quot;path&quot;:&quot;enabled_plugins&quot;}],&quot;name&quot;:&quot;rabbitmq-enabled-plugins&quot;},&quot;name&quot;:&quot;rabbitmq-enabled-plugins&quot;}]}}}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  7	  creationTimestamp: &quot;2024-11-06T17:50:48Z&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  8	  generation: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  9	  name: rabbitmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 10	  namespace: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 11	  resourceVersion: &quot;133758&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 12	  uid: 8c0b3dc2-1d1b-4427-8292-a578f7a134d5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 13	spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 14	  volumeClaimTemplates:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 15	    - metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 16	        name: rabbitmq-data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 17	      spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 18	        storageClassName: managed-csi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 19	        accessModes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 20	          - ReadWriteOnce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 21	        resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 22	          requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 23	            storage: 1Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 24	  persistentVolumeClaimRetentionPolicy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 25	    whenDeleted: Retain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 26	    whenScaled: Retain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 27	  podManagementPolicy: OrderedReady</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 28	  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 29	  revisionHistoryLimit: 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 30	  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 31	    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 32	      app: rabbitmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 33	  serviceName: rabbitmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 34	  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 35	    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 36	      creationTimestamp: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 37	      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 38	        app: rabbitmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 39	    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 40	      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 41	      - env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 42	        - name: RABBITMQ_DEFAULT_USER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 43	          value: username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 44	        - name: RABBITMQ_DEFAULT_PASS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 45	          value: password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 46	        image: mcr.microsoft.com/mirror/docker/library/rabbitmq:3.10-management-alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 47	        imagePullPolicy: IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 48	        name: rabbitmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 49	        ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 50	        - containerPort: 5672</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 51	          name: rabbitmq-amqp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 52	          protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 53	        - containerPort: 15672</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 54	          name: rabbitmq-http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 55	          protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 56	        resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 57	          limits:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 58	            cpu: 250m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 59	            memory: 256Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 60	          requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 61	            cpu: 10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 62	            memory: 128Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 63	        terminationMessagePath: /dev/termination-log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 64	        terminationMessagePolicy: File</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 65	        volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 66	        - mountPath: /etc/rabbitmq/enabled_plugins</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 67	          name: rabbitmq-enabled-plugins</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 68	          subPath: enabled_plugins</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 69	        - mountPath: /var/lib/rabbitmq/mnesia</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 70	          name: rabbitmq-data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 71	      dnsPolicy: ClusterFirst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 72	      nodeSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 73	        kubernetes.io/os: linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 74	      restartPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 75	      schedulerName: default-scheduler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 76	      securityContext: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 77	      terminationGracePeriodSeconds: 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 78	      volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 79	      - configMap:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 80	          defaultMode: 420</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 81	          items:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 82	          - key: rabbitmq_enabled_plugins</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 83	            path: enabled_plugins</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 84	          name: rabbitmq-enabled-plugins</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 85	        name: rabbitmq-enabled-plugins</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 86	      - name: rabbitmq-data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 87	        persistentVolumeClaim:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 88	          claimName: rabbitmq-data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 89	  updateStrategy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 90	    rollingUpdate:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 91	      partition: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 92	    type: RollingUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 93	status:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 94	  availableReplicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 95	  collisionCount: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 96	  currentReplicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 97	  currentRevision: rabbitmq-76886c5866</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 98	  observedGeneration: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 99	  readyReplicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100	  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">101	  updateRevision: rabbitmq-76886c5866</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">102	  updatedReplicas: 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<div class="info" data-title="Info"><blockquote>
<p>For more information on RabbitMQ and persistent storage, see the <a href="https://www.rabbitmq.com/docs/relocate" target="_blank" rel="noopener noreferrer">RabbitMQ documentation</a> and this <a href="https://www.rabbitmq.com/blog/2020/08/10/deploying-rabbitmq-to-kubernetes-whats-involved" target="_blank" rel="noopener noreferrer">blog post</a>.</p>
</blockquote></div>
<p>Run the following command to replace the RabbitMQ StatefulSet with the updated manifest.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete statefulset rabbitmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f rabbitmq-statefulset.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A <code>volumeClaimTemplates</code> spec was added to the RabbitMQ StatefulSet manifest. This spec defines a PVC that requests 1Gi of storage using the <code>managed-csi</code> storage class. The PVC is automatically created by the storage class and is bound to an Azure Disk.</p>
<p>Check the status of the PVC by running the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pvc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you see STATUS as <code>Bound</code>, the PVC has been successfully created and is ready to be used by the RabbitMQ pod.</p>
<p>Test the durability of the RabbitMQ data by creating a queue and then deleting the RabbitMQ pod. Run the following command to port-forward to the RabbitMQ management UI.</p>
<div class="important" data-title="Important"><blockquote>
<p>If you are using Azure Cloud Shell you will not be able to complete the steps below because you cannot open a browser from Cloud Shell. You can skip this step and continue on to the next section.</p>
</blockquote></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl port-forward svc/rabbitmq 15672:15672</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Open a browser and navigate to <a href="http://localhost:15672" target="_blank" rel="noopener noreferrer">http://localhost:15672</a>.</p>
<p>Log in with the username <code>username</code> and password <code>password</code>.</p>
<p>Click on the <strong>Queues</strong> tab then click on <strong>Add a new queue</strong> and create a new queue called <code>test</code>.</p>
<div class="info" data-title="Note"><blockquote>
<p>Make sure the <strong>Durability</strong> option is set to <strong>Durable</strong>. This will ensure that the queue is persisted to disk.</p>
</blockquote></div>
<p>Back in the terminal, press <strong>Ctrl+C</strong> to stop the port-forward then run the following command to delete the RabbitMQ pod.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete pod rabbitmq-0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After a few seconds, Kubernetes will recreate the RabbitMQ pod. When the new pod is up, run the port-forward command again and reload the RabbitMQ management UI in the browser.</p>
<p>Navigate back to the <strong>Queues</strong> tab and you should see the <code>test</code> queue you created earlier. This is because the we mounted the Azure Disk to the <code>/var/lib/rabbitmq/mnesia</code> path and all RabbitMQ data now persists across pod restarts.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="replace-rabbitmq-with-azure-service-bus">Replace RabbitMQ with Azure Service Bus<a href="#replace-rabbitmq-with-azure-service-bus" class="hash-link" aria-label="Direct link to Replace RabbitMQ with Azure Service Bus" title="Direct link to Replace RabbitMQ with Azure Service Bus">​</a></h2>
<p>As you can see, Kubernetes is great for stateless applications especially with Azure storage backing it. But running stateful applications like RabbitMQ in a highly available and durable way can be challenging and might not be something you would want to manage yourself. This is where integrating with a managed service like <a href="https://learn.microsoft.com/azure/service-bus-messaging/service-bus-messaging-overview" target="_blank" rel="noopener noreferrer">Azure Service Bus</a> can help. Azure Service Bus is a fully managed enterprise message broker with message queues and publish-subscribe topics very similar to RabbitMQ. The sample application has been written to use the AMQP protocol which is supported by both RabbitMQ and Azure Service Bus, so we can easily switch between the two.</p>
<p>Before we switch to Azure Service Bus, let&#x27;s make sure to update all the container images to use the latest version.</p>
<p>In the terminal, run the following commands.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl set image deployment/product-service product-service=$ACR_NAME.azurecr.io/aks-store-demo/product-service:1.5.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl set image deployment/order-service order-service=$ACR_NAME.azurecr.io/aks-store-demo/order-service:1.5.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl set image deployment/store-front store-front=$ACR_NAME.azurecr.io/aks-store-demo/store-front:1.5.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-azure-service-bus-namespace-and-queue">Create Azure Service Bus namespace and queue<a href="#create-azure-service-bus-namespace-and-queue" class="hash-link" aria-label="Direct link to Create Azure Service Bus namespace and queue" title="Direct link to Create Azure Service Bus namespace and queue">​</a></h3>
<p>In the Azure portal, search for <strong>Service Bus</strong>, click on <strong>Service Bus</strong> under <strong>Services</strong> then click on the <strong>Create service bus namespace</strong> button.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal service bus" src="/aks-labs/assets/images/azure-portal-service-bus-bcf16119dad0183d09e68e1093a81bdc.png" width="2503" height="1391" class="img_ev3q"></p>
<p>Fill in the required fields and click <strong>Create</strong>.</p>
<ul>
<li><strong>Resource group</strong>: Select the resource group where your AKS cluster is deployed.</li>
<li><strong>Namespace name</strong>: Enter a unique name for the namespace (should be globally unique and lower case).</li>
<li><strong>Location</strong>: Select the same location as your AKS cluster.</li>
<li><strong>Pricing tier</strong>: Select <strong>Basic</strong>.</li>
</ul>
<p>Click on the <strong>Review + create</strong> button then click <strong>Create</strong>.</p>
<p>Once the namespace is created, click on the <strong>Go to resource</strong> button.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal service bus namespace created" src="/aks-labs/assets/images/azure-portal-service-bus-namespace-created-a66788b9d1a77db171a871eae4b270e1.png" width="2503" height="1391" class="img_ev3q"></p>
<p>In the <strong>Overview</strong> section, click on the <strong>+ Queue</strong> button at the top to create a new queue.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal service bus queue create" src="/aks-labs/assets/images/azure-portal-service-bus-queue-create-ae5a50cbc942990002f9a8f7a3934ad1.png" width="2503" height="1391" class="img_ev3q"></p>
<p>In the <strong>Create queue</strong> window, set the name of the queue to <code>orders</code> and click <strong>Create</strong>.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal service bus queue configuration" src="/aks-labs/assets/images/azure-portal-service-bus-queue-configuration-83c8ea5f324ec3e506c5cfaf4bf673f6.png" width="2503" height="1391" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-user-assigned-managed-identity">Create a user-assigned managed identity<a href="#create-a-user-assigned-managed-identity" class="hash-link" aria-label="Direct link to Create a user-assigned managed identity" title="Direct link to Create a user-assigned managed identity">​</a></h3>
<p>In order for the order-service application to authenticate with Azure Service Bus, we need to create a user-assigned managed identity. In the Azure portal, search for <strong>Managed Identities</strong>, click on <strong>Managed Identities</strong> under <strong>Services</strong> then click on the <strong>+ Create</strong> button.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal managed identity" src="/aks-labs/assets/images/azure-portal-managed-identity-38551951e2da292c5ed54d84c61e8ef7.png" width="2503" height="1391" class="img_ev3q"></p>
<p>Fill in the required fields</p>
<ul>
<li><strong>Resource group</strong>: Select the resource group where your AKS cluster is deployed.</li>
<li><strong>Name</strong>: You can use the same name as the Service Bus namespace.</li>
</ul>
<p>Click <strong>Review + create</strong> then click <strong>Create</strong>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="integrate-azure-services-with-aks-using-service-connector">Integrate Azure Services with AKS using Service Connector<a href="#integrate-azure-services-with-aks-using-service-connector" class="hash-link" aria-label="Direct link to Integrate Azure Services with AKS using Service Connector" title="Direct link to Integrate Azure Services with AKS using Service Connector">​</a></h3>
<p>Here is where the workload authentication magic happens. We will use the <a href="https://learn.microsoft.com/azure/service-connector/overview" target="_blank" rel="noopener noreferrer">AKS Service Connector</a> to connect the order-service application to Azure Service Bus. The AKS Service Connector is a new feature that greatly simplifies the process of configuring <a href="https://learn.microsoft.com/azure/aks/workload-identity-overview?tabs=dotnet" target="_blank" rel="noopener noreferrer">Workload Identity</a> for your applications running on AKS. <a href="https://learn.microsoft.com/entra/workload-id/workload-identities-overview" target="_blank" rel="noopener noreferrer">Workload Identity</a> is a feature that allows you to assign an identity to a pod and use that identity to authenticate with Microsoft Entra ID to access Azure services.</p>
<div class="info" data-title="Note"><blockquote>
<p>Workload Identity is the recommended way to authenticate with Azure services from your applications running on AKS. It is more secure than using service principals and does not require you to manage credentials in your application. To read more about the implementation of Workload Identity for Kubernetes, see <a href="https://azure.github.io/azure-workload-identity/docs/" target="_blank" rel="noopener noreferrer">this doc</a>.</p>
</blockquote></div>
<p>In the Azure portal, navigate to the AKS cluster you created earlier. In the left-hand menu, click on <strong>Service Connector (Preview)</strong> under <strong>Settings</strong> then click on the <strong>+ Create</strong> button.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal AKS service connector" src="/aks-labs/assets/images/azure-portal-aks-service-connector-e8366a3e2bb426c13ca2e5f4bf4f6241.png" width="2503" height="1391" class="img_ev3q"></p>
<p>In the <strong>Basics</strong> tab, enter the following details:</p>
<ul>
<li><strong>Kubernetes namespace</strong>: Enter <strong>default</strong></li>
<li><strong>Service type</strong>: Select <strong>Service Bus</strong></li>
</ul>
<p>Leave the rest of the fields as their default values and click <strong>Next: Authentication</strong>.</p>
<p>In the <strong>Authentication</strong> tab, select the <strong>Workload Identity</strong> option and select the user-assigned managed identity you created earlier.</p>
<p>Click <strong>Next: Networking</strong> then click <strong>Next: Review + create</strong> and finally click <strong>Create</strong>.</p>
<div class="info" data-title="Info"><blockquote>
<p>This process will take a few minutes as the Service Connector does some work behind the scenes to configure Workload Identity for the order-service application. Some of the tasks include assigning the proper Azure role permissions to the <a href="https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/overview" target="_blank" rel="noopener noreferrer">managed identity</a> to access the Service Bus, creating a <a href="https://learn.microsoft.com/entra/workload-id/workload-identity-federation" target="_blank" rel="noopener noreferrer">Federated Credential</a> to establish trust between the Kubernetes cluster and the managed identity, creating a Kubernetes <a href="https://kubernetes.io/docs/concepts/security/service-accounts/" target="_blank" rel="noopener noreferrer">ServiceAccount</a> with a link back to the managed identity, and finally creating a Kubernetes <a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank" rel="noopener noreferrer">Secret</a> with the Service Bus endpoint information.</p>
</blockquote></div>
<p>Once the Service Connector for Azure Service Bus has been created, you can configure the order-service application to use the Service Bus connection details.</p>
<p>In the Service Connector page, select the checkbox next to the Service Bus connection and click the <strong>Yaml snippet</strong> button.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal AKS service connector yaml snippet" src="/aks-labs/assets/images/azure-portal-aks-service-connector-yaml-snippet-54074e1fa057b990a8f3b6ac1a8f3351.png" width="2503" height="1391" class="img_ev3q"></p>
<p>In the <strong>YAML snippet</strong> window, select <strong>Kubernetes Workload</strong> for <strong>Resource type</strong>, then select <strong>order-service</strong> for <strong>Kubernetes Workload</strong>.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal AKS service connector yaml snippet for order-service" src="/aks-labs/assets/images/azure-portal-aks-service-connector-yaml-snippet-order-service-19003b12690915afadf82bdb730df0c9.png" width="2503" height="1391" class="img_ev3q"></p>
<p>You will see the YAML manifest for the order-service application with the highlighted edits required to connect to Azure Service Bus via Workload Identity.</p>
<p>Click <strong>Apply</strong> to apply the changes to the order-service application. This will redeploy the order-service application with the new connection details. But since the original order-service deployment was created specifically to connect to RabbitMQ, we need to update the deployment to remove some of the RabbitMQ specific information.</p>
<p>The order-service is designed to use multiple authentication methods. We need to add one environment variable to the order-service deployment to tell it to connect to the Azure Service Bus using workload identity.</p>
<p>Run the following command to patch the order-service deployment.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># add the USE_WORKLOAD_IDENTITY_AUTH environment variable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch deployment order-service --type=&#x27;json&#x27; -p=&#x27;[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;op&quot;: &quot;add&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;path&quot;: &quot;/spec/template/spec/containers/0/env/-&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;value&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;name&quot;: &quot;USE_WORKLOAD_IDENTITY_AUTH&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;value&quot;: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># remove the RabbitMQ specific environment variables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch deployment order-service --type=&#x27;json&#x27; -p=&#x27;[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  { &quot;op&quot;: &quot;remove&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/env/3&quot; },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  { &quot;op&quot;: &quot;remove&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/env/2&quot; },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  { &quot;op&quot;: &quot;remove&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/env/1&quot; },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  { &quot;op&quot;: &quot;remove&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/env/0&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># remove the RabbitMQ init container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch deployment order-service --type=&#x27;json&#x27; -p=&#x27;[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  { &quot;op&quot;: &quot;remove&quot;, &quot;path&quot;: &quot;/spec/template/spec/initContainers&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="info" data-title="Info"><blockquote>
<p>The <code>USE_WORKLOAD_IDENTITY_AUTH</code> environment variable is used to tell the order-service application to use Workload Identity to authenticate with Azure Service Bus. The other environment variables are removed because they are specific to RabbitMQ.</p>
</blockquote></div>
<p>With Azure Service Bus in place, RabbitMQ isn&#x27;t needed anymore, so run the following commands to delete it.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete statefulset rabbitmq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete service rabbitmq</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Browse to the store-front application again, add an item to the cart, and checkout, you should see the order appear in the Azure Service Bus queue. To view the message in the queue, you can use the Azure portal or the Azure CLI.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># get the service bus namespace name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SERVICEBUS_NAME=$(az servicebus namespace list -g $RG_NAME --query &quot;[0].name&quot; -o tsv)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># get the active message count in the orders queue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az servicebus queue show --resource-group $RG_NAME --namespace-name $SERVICEBUS_NAME --name orders --query &quot;countDetails&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see 1 active message count in the queue.</p>
<hr>
<h1>Application and Cluster Scaling</h1>
<p>In a enterprise production environment, the demands and resource usage of your workloads running on Azure Kubernetes Service (AKS) can be dynamic and change frequently. If your application requires more resources, it could be impacted due to the lack of clusters resources. One of the easiest ways to ensure your applications have enough resources from the cluster, is to scale your cluster to include more working nodes.</p>
<p>There are several scenarios that would require your application and/or cluster the need to scale. If your application needs to respond to increased demand, we can scale your application across the cluster to meet demand. If your application has used all of the available resources from the cluster, we can scale the number of nodes in the cluster to meet demand as well.</p>
<p>We will walk through the most popular options that allow you to scale your application and cluster to meet your workload demands.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="manually-scaling-your-cluster">Manually scaling your cluster<a href="#manually-scaling-your-cluster" class="hash-link" aria-label="Direct link to Manually scaling your cluster" title="Direct link to Manually scaling your cluster">​</a></h2>
<p>Manually scaling your cluster gives you the ability to add or remove additional nodes to the cluster at any point in time, adding additional hardware resources to your cluster. Using manual scaling is good for dev/test and/or small production environments where reacting to changing workload utilization is not that important.</p>
<p>With AKS Automatic, system pods and other critical components of the cluster are deployed to a system node pool. This node pool is managed by AKS and is not recommended to be scaled manually. Workloads like the AKS store demo app you deployed earlier are deployed to a separate node pool managed by a different feature of AKS which we&#x27;ll get into later.</p>
<p>Run the following command to view the current count of the system node pool.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks show \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query &quot;agentPoolProfiles[].{count: count, name: name}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="important" data-title="Important"><blockquote>
<p>You could scale the system node pool by running the following command, but this may not be available in the future for AKS Automatic clusters.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks scale  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group &lt;resource-group-name&gt; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name &lt;aks-cluster-name&gt; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--node-count 4 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--nodepool-name systempool</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</blockquote></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="manually-scaling-your-application">Manually scaling your application<a href="#manually-scaling-your-application" class="hash-link" aria-label="Direct link to Manually scaling your application" title="Direct link to Manually scaling your application">​</a></h2>
<p>In addition to you being able to manually nodes to add additional compute resources, you can also manually scale your application workloads deployed in the cluster. In the scenario where your application is experiencing a lot of transactions, such as client interactions or internal API processing, you can manually scale the deployment to increase the number of replicas (instances) running to handle additional load.</p>
<p>You actually performed a manual scale operation earlier in the workshop when you updated the store-front deployment to use PodAntiAffinity.</p>
<p>Run the following command to view the current number of replicas for the <strong>store-front</strong> deployment.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get deployment store-front</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Notice that there is 3 replicas of the <strong>store-front</strong> pods running. Run the following command to scale the number of replicas for the store-front deployment back to 1.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl scale deployment store-front --replicas=1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We&#x27;ll explore better ways to automatically scale your application in the next section.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="automatically-scaling-your-application">Automatically scaling your application<a href="#automatically-scaling-your-application" class="hash-link" aria-label="Direct link to Automatically scaling your application" title="Direct link to Automatically scaling your application">​</a></h2>
<p>To automatically scale your deployments, you can use the <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" target="_blank" rel="noopener noreferrer">Horizontal Pod Autoscaler (HPA)</a> resource. This is a better approach to scale you application, as it allows you to automatically scale a workload based on the resource utilization of the pods in the deployment. The resource utilization is based on the CPU and memory requests and limits set in the pod configuration, so it is important to set these values correctly to ensure the HPA can scale your application correctly.</p>
<p>Let&#x27;s first take a look and view the current CPU and memory requests and limits for the <strong>store-front</strong> deployment.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe deployment store-front | grep -A 2 -E &quot;Limits|Requests&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see the following limits and requests:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Limits</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 512Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Requests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 200Mi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This configuration tells the Kubernetes scheduler to allocate up to 1 CPU and up to 512Mi of memory to the pod. The pod will be allocated at least 1m of CPU and 200Mi of memory. The HPA will use these values to determine when to scale the number of replicas of the <strong>store-front</strong> deployment.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="automatically-scaling-your-application-with-hpa">Automatically scaling your application with HPA<a href="#automatically-scaling-your-application-with-hpa" class="hash-link" aria-label="Direct link to Automatically scaling your application with HPA" title="Direct link to Automatically scaling your application with HPA">​</a></h3>
<p>The simplest way to create an HPA is to use the imperative <code>kubectl autoscale</code> command. Run the following command to create an HPA for the <strong>store-front</strong> deployment that will allow the HPA controller to increase or decrease the number of Pods from 1 to 10, based on the Pods keeping an average of 50% CPU utilization.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl autoscale deployment store-front --cpu-percent=50 --min=1 --max=10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can then verify that an HPA resource exists for the <strong>store-front</strong> deployment.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get hpa store-front</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You may notice that the HPA autoscaler has already started to add additional replicas of the <strong>store-front</strong> deployment to meet the HPA demands.</p>
<p>We will now deploy an application to simulate additional client load to the <strong>store-front</strong> deployment. Run the following command to deploy a pod that will generate additional load to the <strong>store-front</strong> deployment.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl run load-generator --image=busybox:1.28 --restart=Never -- /bin/sh -c &quot;while sleep 0.01; do wget -q -O- http://store-front; done&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Take a look at the HPA resource for the <strong>store-front</strong> deployment to see if we have increased the need for replicas to meet the resource configuration.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get hpa store-front</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see that the load generating application forced the automatic scaling of the <strong>store-front</strong> deployment to reach the maximum replica limit of 10.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NAME          REFERENCE                TARGETS    MINPODS   MAXPODS   REPLICAS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">store-front   Deployment/store-front   225%/50%   1         10        10         6m15s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Terminate the load generator pod by running the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete pod load-generator --wait=false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Remove the HPA configuration for the <strong>store-front</strong> deployment by running the following command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete hpa store-front</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We&#x27;ll explore a better way to automatically configure the HPA in the next section.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="using-keda-to-manage-hpa">Using KEDA to manage HPA<a href="#using-keda-to-manage-hpa" class="hash-link" aria-label="Direct link to Using KEDA to manage HPA" title="Direct link to Using KEDA to manage HPA">​</a></h3>
<p>We just saw how to use the Horizontal Pod Autoscaler (HPA) to automatically scale your application based on resource utilization. The HPA is a great way to scale your application based on CPU and memory utilization, but what if you want to scale your application based on other metrics like the number of messages in a queue, the length of a stream, or the number of messages in a topic?</p>
<p>The <a href="https://keda.sh/" target="_blank" rel="noopener noreferrer">Kubernetes Event-driven Autoscaling (KEDA)</a> project is a Kubernetes-based Event-Driven Autoscaler. KEDA allows you to scale your application workloads based on the number of events in a queue, the length of a stream, or the number of messages in a topic. KEDA can be installed manually in your AKS cluster but it is also available as an add-on to AKS and is automatically enabled in AKS Automatic clusters. When you use the AKS add-on for KEDA, it will be fully supported by Microsoft.</p>
<p>In order to use KEDA, you can deploy a <a href="https://keda.sh/docs/2.15/reference/scaledobject-spec/" target="_blank" rel="noopener noreferrer">ScaledObject</a> resource to scale long-running applications or deploy a <a href="https://keda.sh/docs/2.15/reference/scaledjob-spec/" target="_blank" rel="noopener noreferrer">ScaledJob</a> resource to scale batch jobs. A ScaledObject is a custom resource that defines how to scale a deployment based on an external metric. The ScaledObject will watch the external metric and scale the deployment based on the metric value.</p>
<p>Having to learn and write the ScaledObject resource manifest can be a bit challenging, so AKS provides a simpler way to create a ScaledObject resource using the Azure portal.</p>
<p>In the Azure portal, navigate to the AKS cluster you created earlier. In the left-hand menu, click on <strong>Application scaling</strong> under <strong>Settings</strong> then click on the <strong>+ Create</strong> button.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal AKS application scaling" src="/aks-labs/assets/images/azure-portal-aks-application-scaling-0bf590d85fb8ce0bc003a1073d733a8a.png" width="2505" height="1388" class="img_ev3q"></p>
<p>In the <strong>Basics</strong> tab, enter the following details:</p>
<ul>
<li><strong>Name</strong>: Enter <strong>store-front</strong></li>
<li><strong>Namespace</strong>: Select <strong>default</strong></li>
<li><strong>Target workload</strong>: Select <strong>store-front</strong></li>
<li><strong>Minimum replicas</strong>: Enter <strong>1</strong></li>
<li><strong>Maximum replicas</strong>: Enter <strong>10</strong></li>
<li><strong>Trigger type</strong>: Select <strong>CPU</strong></li>
</ul>
<p>Leave the rest of the fields as their default values and click *<em>Next</em>.</p>
<p>In the <strong>Review + create</strong> tab, click <strong>Customize with YAML</strong> to view the YAML manifest for the ScaledObject resource.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal AKS application scaling yaml" src="/aks-labs/assets/images/azure-portal-aks-application-scaling-yaml-bc771f9c8c8ccf590784246a5536e9e0.png" width="2505" height="1388" class="img_ev3q"></p>
<p>You can see the YAML manifest the AKS portal generated for the ScaledObject resource. Here you can add additional configuration to the ScaledObject resource if needed.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal AKS application scaling yaml manifest" src="/aks-labs/assets/images/azure-portal-aks-application-scaling-yaml-manifest-1ea7181f34835f5932251aee28287eff.png" width="2505" height="1388" class="img_ev3q"></p>
<p>Click <strong>Save and create</strong> to create the ScaledObject resource.</p>
<p>Header over to the <strong>Workloads</strong> section in the left-hand menu and click on <strong>Deployments</strong>. In the <strong>Filter by deployment name</strong> field, enter <strong>store-front</strong> to view the <strong>store-front</strong> deployment. You should see the <strong>store-front</strong> deployment is now running 2 replicas.</p>
<p>Also, if you run the following command, you should see a HPA resource named <strong>keda-hpa-store-front</strong> which KEDA created and is managing for the <strong>store-front</strong> deployment.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get hpa</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This was a simple example of using using KEDA. But using KEDA over the HPA for CPU and memory utilization doesn&#x27;t give you lot to differentiate the experience. The real power of KEDA comes from its ability to scale your application based on external metrics like the number of messages in a queue, the length of a stream, the number of messages in a topic, or based on a custom schedule using CRON expressions. There are many <a href="https://keda.sh/docs/2.15/scalers/" target="_blank" rel="noopener noreferrer">scalers</a> available for KEDA that you can use to scale your application based on a variety of external metrics.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="automatically-scaling-your-cluster">Automatically scaling your cluster<a href="#automatically-scaling-your-cluster" class="hash-link" aria-label="Direct link to Automatically scaling your cluster" title="Direct link to Automatically scaling your cluster">​</a></h2>
<p>So far as it relates to scaling, we have seen how to manually scale the cluster nodes, to allow more access to hardware recourses for running workloads, manually scaling your workload deployments to increase the number of instances of your application, and we have also seen how you can create an HPA autoscaler for your application workload deployment that will automatically scale your application depending on the amount of resources it utilizes.</p>
<p>One thing to note, even though an HPA resource will automate the scaling of your application deployment, based on resource utilization, your application can still be affected if your cluster resources are exhausted. At that point, you will need to manually scale the number of nodes in the cluster to meet application demand.</p>
<p>There is a more preferred approach and method for scaling your cluster that takes into account both the resource needs of your application and the cluster nodes utilization known as the Node Autoprovisioning (NAP) component. NAP is based on the Open Source <a href="https://karpenter.sh/" target="_blank" rel="noopener noreferrer">Karpenter</a> project, and the <a href="https://github.com/Azure/karpenter-provider-azure" target="_blank" rel="noopener noreferrer">AKS provider</a>, which is also Open Source. NAP will automatically scale your cluster node pool to meet the demands of your application workloads, not only with additional nodes, but will find the most efficient VM configuration to host the demands of your workloads.</p>
<p>To show how Node Autoprovisioning work, we will first scale down the node pool to have a single node.</p>
<p>First we will check to see if NAP is configured for the cluster. Run the following command in the terminal.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az aks show \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--resource-group ${RG_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name ${AKS_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--query &quot;nodeProvisioningProfile&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should see mode is set to <strong>Auto</strong>.</p>
<div class="important" data-title="Important"><blockquote>
<p>The <code>nodeProvisioningProfile</code> property is currently available in preview versions of the Azure resource provider APIs, so you will need to install the <code>aks-preview</code> extension within Azure CLI to view the property.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az extension add --name aks-preview</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</blockquote></div>
<p>To activate NAP, run the following command to manually scale the <strong>product-service</strong> deployment.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl scale deployment product-service --replicas=100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This should start to exhaust the currently single node and trigger NAP to auto provision additional nodes in the node pool to support the resource demand.</p>
<p>If you run the following command, you should see some of the Pods for the <strong>product-service</strong> deployment are in a <strong>Running</strong> state and some are in a <strong>Pending</strong> state.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pod --selector app=product-service -o wide</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note the <strong>NODE</strong> column to see which node the Pods are running on. Notice that the Pods that are in a <strong>Pending</strong> state are waiting for additional nodes to be provisioned by NAP.</p>
<p>Run the following command to check the status of the nodes in the cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get nodes -w</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After a few minutes, you should see additional nodes being created to support the resource demand of the <strong>product-service</strong> deployment.</p>
<hr>
<h1>Monitoring your Cluster</h1>
<p>Monitoring and observability are key components of running applications in production. With AKS Automatic, you get a lot of monitoring and observability features enabled out-of-the-box. If you recall from the beginning of the workshop, we created an <a href="https://learn.microsoft.com/azure/azure-monitor/logs/log-analytics-overview" target="_blank" rel="noopener noreferrer">Azure Log Analytics Workspace</a> with <a href="https://learn.microsoft.com/azure/azure-monitor/containers/container-insights-overview" target="_blank" rel="noopener noreferrer">Container Insights</a> to collect application logs, <a href="https://learn.microsoft.com/azure/azure-monitor/containers/kubernetes-monitoring-enable?tabs=cli" target="_blank" rel="noopener noreferrer">Azure Monitor Managed Workspace</a> to with <a href="https://learn.microsoft.com/azure/azure-monitor/containers/prometheus-metrics-scrape-default" target="_blank" rel="noopener noreferrer">Prometheus recording rules</a> enabled to capture metrics from workloads within the cluster, and <a href="https://azure.microsoft.com/products/managed-grafana" target="_blank" rel="noopener noreferrer">Azure Managed Grafana</a> to visualize the metrics.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cluster-and-container-insights">Cluster and container insights<a href="#cluster-and-container-insights" class="hash-link" aria-label="Direct link to Cluster and container insights" title="Direct link to Cluster and container insights">​</a></h2>
<p>In the Azure portal, navigate to the AKS cluster you created earlier. In the left-hand menu, scroll down to the <strong>Monitoring</strong> section and click on <strong>Insights</strong>. Here you can see a high-level overview of how the cluster is performing.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal cluster metrics" src="/aks-labs/assets/images/azure-portal-cluster-metrics-b2e9bfef8508bcec81407f4311809489.png" width="2500" height="1390" class="img_ev3q"></p>
<p>The AKS Automatic cluster was also pre-configured with basic CPU utilization and memory utilization alerts. You can also create additional alerts based on the metrics collected by the Prometheus workspace.</p>
<p>Click on the <strong>Recommended alerts (Preview)</strong> button to view the recommended alerts for the cluster. Expand the <strong>Prometheus community alert rules (Preview)</strong> section to see the list of Prometheus alert rules that are available. You can enable any of these alerts by clicking on the toggle switch.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal cluster alerts" src="/aks-labs/assets/images/azure-portal-cluster-alerts-bda6a7fa4c2483e4253ec314e829311e.png" width="2500" height="1390" class="img_ev3q"></p>
<p>Click save to enable the alerts.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="workbooks-and-logs">Workbooks and logs<a href="#workbooks-and-logs" class="hash-link" aria-label="Direct link to Workbooks and logs" title="Direct link to Workbooks and logs">​</a></h2>
<p>With Container Insights enabled, you can query the logs using Kusto Query Language (KQL) and create custom workbooks to visualize the data. One nice feature of Container Insights is having pre-configured workbooks that you can use to monitor your cluster and applications without having to write any queries.</p>
<p>In the <strong>Monitoring</strong> section of the AKS cluster left-hand menu, click on <strong>Workbooks</strong>. Here you will see a list of pre-configured workbooks that you can use to monitor your cluster.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal AKS workbooks" src="/aks-labs/assets/images/azure-portal-aks-workbooks-e9531fca3b69ee4fde520d1341b237bc.png" width="2500" height="1390" class="img_ev3q"></p>
<p>One workbook that is particularly useful is the <strong>Cluster Optimization</strong> workbook. This workbook can help you identify anomalies and detect application probe failures in addition to providing guidance on optimizing container resource requests and limits. Click on the <strong>Cluster Optimization</strong> workbook to view the details.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal AKS cluster optimization workbook" src="/aks-labs/assets/images/azure-portal-aks-cluster-optimization-workbook-88a05b4bacb85ae664c0fdd7fb998b2a.png" width="2500" height="1390" class="img_ev3q"></p>
<p>Take some time to explore the other workbooks available in the list.</p>
<div class="tip" data-title="Tip"><blockquote>
<p>The workbook visuals will include a query button that you can click to view the KQL query that powers the visual. This is a great way to learn how to write your own queries.</p>
</blockquote></div>
<p>If you click on the <strong>Logs</strong> section in the left-hand menu, you can view the logs collected by Container Insights. Here, you can write your own KQL queries or run pre-configured queries to logs from your cluster and applications. If you expand the <strong>Logs</strong> menu, click on <strong>Queries</strong>, and scroll down to the <strong>Container Logs</strong> section, you will see a list of pre-configured queries that you can run. Click on a query and click <strong>Run</strong> to view the results.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal AKS logs queries" src="/aks-labs/assets/images/azure-portal-aks-container-logs-72aedf28a3622b53a0aac934349a0da7.png" width="2500" height="1390" class="img_ev3q"></p>
<p>You can also view live streaming logs for a specific container by clicking on the <strong>Workloads</strong> section in the left-hand menu. In the <strong>Deployments</strong> tab, scroll down and locate the <strong>order-service</strong> deployment. Click on the <strong>order-service</strong> deployment to view the details. In the left-hand menu, click on <strong>Live logs</strong>, then select the pod you want to view logs for.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal AKS live logs" src="/aks-labs/assets/images/azure-portal-aks-live-logs-a69e0d06c90decba64258130196bc58e.png" width="2500" height="1390" class="img_ev3q"></p>
<p>This is the equivalent of running <code>kubectl logs -f &lt;pod-name&gt;</code> in the terminal.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="visualizing-metrics-with-grafana">Visualizing metrics with Grafana<a href="#visualizing-metrics-with-grafana" class="hash-link" aria-label="Direct link to Visualizing metrics with Grafana" title="Direct link to Visualizing metrics with Grafana">​</a></h2>
<p>The Azure Portal provides a great way to view metrics and logs, but if you prefer to visualize the data using Grafana, or execute complex queries using PromQL, you can use the Azure Managed Grafana instance that was created with the AKS Automatic cluster.</p>
<p>In the AKS cluster&#x27;s left-hand menu, click on <strong>Insights</strong> under the <strong>Monitoring</strong> section and click on the <strong>View Grafana</strong> button at the top of the page. This will open a window with the linked Azure Managed Grafana instance. Click on the <strong>Browse dashboards</strong> link. This will take you to the Azure Managed Grafana instance.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal AKS browse dashboards" src="/aks-labs/assets/images/azure-portal-aks-browse-dashboards-94de9cba18432e0a61afff429be4f178.png" width="2500" height="1390" class="img_ev3q"></p>
<p>In the Grafana home page, click on the <strong>Dashboards</strong> link in the left-hand menu. Here you will see a list of pre-configured dashboards that you can use to visualize the metrics collected by the Prometheus workspace.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal AKS Grafana dashboards" src="/aks-labs/assets/images/grafana-homepage-aa29af23cc5a7b56b878f37c3d696473.png" width="2500" height="1390" class="img_ev3q"></p>
<p>In the <strong>Dashboards</strong> list, expand the <strong>Azure Managed Prometheus</strong> folder and explore the dashboards available.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal AKS Grafana dashboards list" src="/aks-labs/assets/images/grafana-dashboards-ecafbcf0155ede9a05d977f0d7a1213c.png" width="2500" height="1390" class="img_ev3q"></p>
<p>Each dashboard provides a different view of the metrics collected by the Prometheus workspace with controls to allow you to filter the data.</p>
<p>Click on a <strong>Kubernetes / Compute Resources / Workload</strong> dashboard. Filter the <strong>namespace</strong> to <code>default</code> the <strong>type</strong> to <code>deployment</code>, and the <strong>workload</strong> to <code>order-service</code>. This will show you the metrics for the order-service deployment.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal AKS Grafana dashboard" src="/aks-labs/assets/images/grafana-dashboard-workload-order-service-bc33c272fca7d383f1e062e4ebb94614.png" width="2500" height="1390" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="querying-metrics-with-promql">Querying metrics with PromQL<a href="#querying-metrics-with-promql" class="hash-link" aria-label="Direct link to Querying metrics with PromQL" title="Direct link to Querying metrics with PromQL">​</a></h2>
<p>If you prefer to write your own queries to visualize the data, you can use the <strong>Explore</strong> feature in Grafana. In the Grafana home page, click on the <strong>Explore</strong> link in the left-hand menu, and select the <strong>Managed_Prometheus_defaultazuremonitorworkspace</strong> data source.</p>
<p>The query editor supports a graphical query builder and a text-based query editor. The graphical query builder is a great way to get started with PromQL. You can select the metric you want to query, the aggregation function, and any filters you want to apply.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal AKS Grafana explore" src="/aks-labs/assets/images/grafana-explore-0da9454eca890430e31d52a8db377922.png" width="2500" height="1390" class="img_ev3q"></p>
<hr>
<h1>CI/CD with Automated Deployments</h1>
<p>Up until this point, you&#x27;ve been using either kubectl or the Azure portal to deploy applications to your AKS cluster and/or edit configurations. This is fine for manual deployments, but in a production environment, you would want to automate the deployment process. This is where Continuous Integration and Continuous Deployment (CI/CD) pipelines come in. With CI/CD pipelines, you can automate the process of building, testing, and deploying your applications to your AKS cluster.</p>
<p>With AKS, the <a href="https://learn.microsoft.com/azure/aks/automated-deployments" target="_blank" rel="noopener noreferrer">Automated Deployments</a> feature allows you to create <a href="https://docs.github.com/actions" target="_blank" rel="noopener noreferrer">GitHub Actions workflows</a> that allows you to start deploying your applications to your AKS cluster with minimal effort. All you need is a GitHub repository with your application code. If you have Dockerfiles or Kubernetes manifests in your repository, that&#x27;s great, you can simply point to them in the Automated Deployments setup. But the best part is that you don&#x27;t even need to have Dockerfiles or Kubernetes manifests in your repository. Automated Deployments can create them for you.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="fork-a-sample-repository">Fork a sample repository<a href="#fork-a-sample-repository" class="hash-link" aria-label="Direct link to Fork a sample repository" title="Direct link to Fork a sample repository">​</a></h2>
<p>In this section, you will fork a sample repository that contains a simple Node.js application.</p>
<p>In your browser, navigate to the <a href="https://github.com/pauldotyu/contoso-air" target="_blank" rel="noopener noreferrer">contoso-air</a> repo and click the <strong>Fork</strong> button in the top right corner of the page.</p>
<p><img decoding="async" loading="lazy" alt="GitHub fork button" src="/aks-labs/assets/images/github-fork-833bb0a30f90c45d1405d948781851fa.png" width="2503" height="1395" class="img_ev3q"></p>
<div class="info" data-title="Note"><blockquote>
<p>Make sure you are logged into your GitHub account before forking the repository.</p>
</blockquote></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="automated-deployments-setup">Automated Deployments setup<a href="#automated-deployments-setup" class="hash-link" aria-label="Direct link to Automated Deployments setup" title="Direct link to Automated Deployments setup">​</a></h2>
<p>In the Azure portal, navigate to the AKS cluster you created earlier. In the left-hand menu, click on <strong>Automated Deployments</strong> under the <strong>Settings</strong> section. Click on the <strong>+ Create</strong> button, then click <strong>Automatically containerize and deploy</strong> button.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal Automated Deployments" src="/aks-labs/assets/images/azure-portal-automated-deployments-ec00425d04a2bbbb0bda22dc775826b8.png" width="2500" height="1389" class="img_ev3q"></p>
<p>In the <strong>Repository</strong> tab, fill in the following details:</p>
<ul>
<li><strong>Workflow name</strong>: Enter <code>contoso-air</code></li>
<li><strong>Repository location</strong>: Authenticate to your GitHub account</li>
<li><strong>Repository source</strong>: Select the <strong>My repositories</strong> radio button</li>
<li><strong>Repository</strong>: Select the <strong>contoso-air</strong> repository you forked earlier</li>
<li><strong>Branch</strong>: Select the <strong>main</strong> branch</li>
</ul>
<p>Click <strong>Next</strong>.</p>
<p>In the <strong>Application</strong> tab, fill in the following in the <strong>Image</strong> section:</p>
<ul>
<li><strong>Container configuration</strong>: Select <strong>Auto-containerize (generate Dockerfile)</strong></li>
<li><strong>Save files in repository</strong>: Click the <strong>Select</strong> link to open the directory explorer, then navigate to the <code>Root/src</code> directory, select the checkbox next to the <code>web</code> folder, then click <strong>Select</strong>.</li>
</ul>
<p>Scroll down to the <strong>Dockerfile configuration</strong> section, fill in the following details:</p>
<ul>
<li><strong>Application environment</strong>: Select <strong>JavaScript - Node.js 20</strong></li>
<li><strong>Application port</strong>: Enter <strong>3000</strong></li>
<li><strong>Dockerfile build context</strong>: Enter <code>./src/web</code></li>
<li><strong>Azure Container Registry</strong>: Select the Azure Container Registry you created earlier</li>
<li><strong>Azure Container Registry image</strong>: Click the <strong>Create new</strong> link then enter <code>contoso-air</code></li>
<li>Optionally click on the <strong>Preview file</strong> tab under <strong>Review generated files</strong>  to view the generated Dockerfile</li>
</ul>
<p>Scroll down to the <strong>Deployment configuration</strong> section and fill in the following details:</p>
<ul>
<li><strong>Deployment options</strong>: Select <strong>Generate application deployment files</strong></li>
<li><strong>Namespace</strong>: Select <code>default</code></li>
<li><strong>Save files in repository</strong>: Click the <strong>Select</strong> link to open the directory explorer, then navigate to the <code>Root/src</code> directory, select the checkbox next to the <code>web</code> folder, then click <strong>Select</strong>.</li>
<li>Optionally click on the <strong>Preview file</strong> tab under <strong>Review generated files</strong> section to view the generated Kubernetes manifests.</li>
</ul>
<p>Click <strong>Next</strong>, review the configuration, then click <strong>Next</strong> to submit the deployment.</p>
<p>After a minute or so, the deployment will complete and you will see a success message. Click on the <strong>Approve pull request</strong> button to view the pull request to be taken to the pull request page in your GitHub repository.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal Automated Deployments success" src="/aks-labs/assets/images/azure-portal-automated-deployments-success-6496f1d0022ed16eaa5029234a1bedc4.png" width="2502" height="1393" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="review-the-pull-request">Review the pull request<a href="#review-the-pull-request" class="hash-link" aria-label="Direct link to Review the pull request" title="Direct link to Review the pull request">​</a></h2>
<div class="important" data-title="Important"><blockquote>
<p>The application&#x27;s container image needs to be built with Node 22 as its base image, so you will need to update the Dockerfile. You can do this by editing the Dockerfile in the pull request review.</p>
</blockquote></div>
<p>In the pull request review, click on the <strong>Files changed</strong> tab to view the changes that were made by the Automated Deployments workflow.</p>
<p><img decoding="async" loading="lazy" alt="GitHub pull request files changed" src="/aks-labs/assets/images/github-pull-request-files-changed-07850397cf47f244ad3423633cca3ff5.png" width="2500" height="1389" class="img_ev3q"></p>
<p>Scroll down to the <strong>src/web/Dockerfile</strong> that Automated Deployment generated for you, then click on the <strong>Edit</strong> button to edit the file.</p>
<p><img decoding="async" loading="lazy" alt="GitHub pull request Dockerfile edit" src="/aks-labs/assets/images/github-pull-request-dockerfile-edit-869e632eb73fe0cf6cc0bf9c967fb53b.png" width="2500" height="1389" class="img_ev3q"></p>
<p>Update the <code>FROM</code> line in the Dockerfile to use the <code>node:22</code> base image.</p>
<p><img decoding="async" loading="lazy" alt="GitHub pull request Dockerfile edit changes" src="/aks-labs/assets/images/github-pull-request-dockerfile-edit-changes-43bde82e9a010abc82ffdbdea15d7350.png" width="2500" height="1389" class="img_ev3q"></p>
<p>Click on the <strong>Commit changes</strong> button to commit the changes to the pull request. The file should now look like this.</p>
<p><img decoding="async" loading="lazy" alt="GitHub pull request Dockerfile edit changes committed" src="/aks-labs/assets/images/github-pull-request-dockerfile-edit-changes-committed-b21bf61b210629ab8eb42685a5cb9d00.png" width="2500" height="1389" class="img_ev3q"></p>
<p>Navigate back to the <strong>Conversation</strong> tab and click on the <strong>Merge pull request</strong> button to merge the pull request, then click <strong>Confirm merge</strong>.</p>
<p><img decoding="async" loading="lazy" alt="GitHub merge pull request" src="/aks-labs/assets/images/github-merge-pull-request-7343c0219f5fbf3ffed58ebd7bcfdb40.png" width="2502" height="1393" class="img_ev3q"></p>
<p>With the pull request merged, the changes will be automatically deployed to your AKS cluster. You can view the deployment logs by clicking on the <strong>Actions</strong> tab in your GitHub repository.</p>
<p><img decoding="async" loading="lazy" alt="GitHub Actions tab" src="/aks-labs/assets/images/github-actions-tab-b54ce80ea83ac54bd6fbc3f51543a4b3.png" width="2502" height="1393" class="img_ev3q"></p>
<p>In the <strong>Actions</strong> tab, you will see the Automated Deployments workflow running. Click on the workflow run to view the logs.</p>
<p><img decoding="async" loading="lazy" alt="GitHub Actions workflow run" src="/aks-labs/assets/images/github-actions-workflow-run-16b61935f5479ff9df934c96c279b6ad.png" width="2502" height="1393" class="img_ev3q"></p>
<p>In the workflow run details page, you can view the logs of each step in the workflow by simply clicking on the step.</p>
<p><img decoding="async" loading="lazy" alt="GitHub Actions workflow logs" src="/aks-labs/assets/images/github-actions-workflow-logs-e4f99eb408a2c4ec2fc543ea876cf0f0.png" width="2502" height="1393" class="img_ev3q"></p>
<p>After a few minutes, the workflow will complete and you will see two green check marks next to the <strong>buildImage</strong> and <strong>deploy</strong> steps. This means that the application has been successfully deployed to your AKS cluster.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="view-the-deployed-application">View the deployed application<a href="#view-the-deployed-application" class="hash-link" aria-label="Direct link to View the deployed application" title="Direct link to View the deployed application">​</a></h2>
<p>In the Azure portal, navigate to the AKS cluster you created earlier. In the left-hand menu, click on <strong>Services and ingresses</strong> under the <strong>Kubernetes resources</strong> section. You should see a new service called <code>contoso-air</code> with a public IP address assigned to it. Click on the IP address to view the deployed application.</p>
<p><img decoding="async" loading="lazy" alt="Azure portal AKS services" src="/aks-labs/assets/images/azure-portal-aks-services-contoso-air-e5c0e58cd9c94a68220c94419446d156.png" width="2502" height="1393" class="img_ev3q"></p>
<p>With AKS Automated Deployments, every time you push application code changes to your GitHub repository, the GitHub Action workflow will automatically build and deploy your application to your AKS cluster. This is a great way to automate the deployment process and ensure that your applications are always up-to-date!</p>
<hr>
<h1>Summary</h1>
<p>Congratulations on completing the AKS Automatic workshop!</p>
<p>In this workshop, you learned how to create an AKS cluster with the new AKS Automatic feature. You deployed a sample application to the cluster and explored some of the features that AKS Automatic provides. You learned how to scale your cluster manually and automatically using the Horizontal Pod Autoscaler and KEDA. You also learned how to handle stateful workloads using Persistent Volumes and Azure Service Bus. Finally, you explored the monitoring and observability features of AKS Automatic.</p>
<p>To learn more about AKS Automatic, visit the <a href="https://learn.microsoft.com/azure/aks/intro-aks-automatic" target="_blank" rel="noopener noreferrer">AKS documentation</a>.</p>
<p>In addition to this workshop, you can also explore the following resources:</p>
<ul>
<li><a href="https://learn.microsoft.com/azure/aks" target="_blank" rel="noopener noreferrer">Azure Kubernetes Service (AKS) documentation</a></li>
<li><a href="https://azure.microsoft.com/solutions/kubernetes-on-azure/get-started/" target="_blank" rel="noopener noreferrer">Kubernetes: Getting started</a></li>
<li><a href="https://learn.microsoft.com/training/paths/intro-to-kubernetes-on-azure/" target="_blank" rel="noopener noreferrer">Learning Path: Introduction to Kubernetes on Azure</a></li>
<li><a href="https://learn.microsoft.com/training/paths/deploy-manage-containers-azure-kubernetes-service/" target="_blank" rel="noopener noreferrer">Learning Path: Deploy containers by using Azure Kubernetes Service (AKS)</a></li>
</ul>
<p>If you have any feedback or suggestions for this workshop, please feel free to open an issue or pull request in the <a href="https://github.com/Azure-Samples/aks-labs" target="_blank" rel="noopener noreferrer">GitHub repository</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/Azure-Samples/aks-labs/tree/main/docs/aks-automatic/workshop.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/aks-labs/docs/category/aks-automatic"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">AKS Automatic</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/aks-labs/docs/category/operating-aks-automatic"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Operating AKS Automatic</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#objectives" class="table-of-contents__link toc-highlight">Objectives</a></li><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#workshop-instructions" class="table-of-contents__link toc-highlight">Workshop instructions</a></li><li><a href="#familiarize-yourself-with-aks-presets-in-portal" class="table-of-contents__link toc-highlight">Familiarize yourself with AKS Presets in portal</a></li><li><a href="#deploy-aks-automatic-cluster" class="table-of-contents__link toc-highlight">Deploy AKS Automatic Cluster</a></li><li><a href="#connect-to-aks-cluster" class="table-of-contents__link toc-highlight">Connect to AKS cluster</a></li><li><a href="#container-registries" class="table-of-contents__link toc-highlight">Container Registries</a><ul><li><a href="#deploy-azure-container-registry-acr" class="table-of-contents__link toc-highlight">Deploy Azure Container Registry (ACR)</a></li><li><a href="#attach-acr-to-aks-cluster" class="table-of-contents__link toc-highlight">Attach ACR to AKS cluster</a></li></ul></li><li><a href="#import-container-images" class="table-of-contents__link toc-highlight">Import container images</a></li><li><a href="#updating-deployment-manifests" class="table-of-contents__link toc-highlight">Updating Deployment manifests</a></li><li><a href="#getting-familiar-with-the-kubernetes-resources" class="table-of-contents__link toc-highlight">Getting familiar with the Kubernetes resources</a><ul><li><a href="#deployments" class="table-of-contents__link toc-highlight">Deployments</a></li><li><a href="#services" class="table-of-contents__link toc-highlight">Services</a></li><li><a href="#statefulsets" class="table-of-contents__link toc-highlight">StatefulSets</a></li><li><a href="#configmaps" class="table-of-contents__link toc-highlight">ConfigMaps</a></li></ul></li><li><a href="#test-the-demo-app" class="table-of-contents__link toc-highlight">Test the demo app</a></li><li><a href="#ingress-and-app-routing-add-on" class="table-of-contents__link toc-highlight">Ingress and App Routing add-on</a></li><li><a href="#deployments-and-replicasets" class="table-of-contents__link toc-highlight">Deployments and ReplicaSets</a></li><li><a href="#deployment-update-strategy" class="table-of-contents__link toc-highlight">Deployment Update Strategy</a><ul><li><a href="#rollback-a-deployment" class="table-of-contents__link toc-highlight">Rollback a Deployment</a></li></ul></li><li><a href="#dealing-with-disruptions" class="table-of-contents__link toc-highlight">Dealing with Disruptions</a><ul><li><a href="#voluntary-disruptions" class="table-of-contents__link toc-highlight">Voluntary Disruptions</a></li><li><a href="#involuntary-disruptions" class="table-of-contents__link toc-highlight">Involuntary Disruptions</a></li></ul></li><li><a href="#aks-storage-classes-and-pvcs" class="table-of-contents__link toc-highlight">AKS Storage classes and PVC&#39;s</a></li><li><a href="#replace-rabbitmq-with-azure-service-bus" class="table-of-contents__link toc-highlight">Replace RabbitMQ with Azure Service Bus</a><ul><li><a href="#create-azure-service-bus-namespace-and-queue" class="table-of-contents__link toc-highlight">Create Azure Service Bus namespace and queue</a></li><li><a href="#create-a-user-assigned-managed-identity" class="table-of-contents__link toc-highlight">Create a user-assigned managed identity</a></li><li><a href="#integrate-azure-services-with-aks-using-service-connector" class="table-of-contents__link toc-highlight">Integrate Azure Services with AKS using Service Connector</a></li></ul></li><li><a href="#manually-scaling-your-cluster" class="table-of-contents__link toc-highlight">Manually scaling your cluster</a></li><li><a href="#manually-scaling-your-application" class="table-of-contents__link toc-highlight">Manually scaling your application</a></li><li><a href="#automatically-scaling-your-application" class="table-of-contents__link toc-highlight">Automatically scaling your application</a><ul><li><a href="#automatically-scaling-your-application-with-hpa" class="table-of-contents__link toc-highlight">Automatically scaling your application with HPA</a></li><li><a href="#using-keda-to-manage-hpa" class="table-of-contents__link toc-highlight">Using KEDA to manage HPA</a></li></ul></li><li><a href="#automatically-scaling-your-cluster" class="table-of-contents__link toc-highlight">Automatically scaling your cluster</a></li><li><a href="#cluster-and-container-insights" class="table-of-contents__link toc-highlight">Cluster and container insights</a></li><li><a href="#workbooks-and-logs" class="table-of-contents__link toc-highlight">Workbooks and logs</a></li><li><a href="#visualizing-metrics-with-grafana" class="table-of-contents__link toc-highlight">Visualizing metrics with Grafana</a></li><li><a href="#querying-metrics-with-promql" class="table-of-contents__link toc-highlight">Querying metrics with PromQL</a></li><li><a href="#fork-a-sample-repository" class="table-of-contents__link toc-highlight">Fork a sample repository</a></li><li><a href="#automated-deployments-setup" class="table-of-contents__link toc-highlight">Automated Deployments setup</a></li><li><a href="#review-the-pull-request" class="table-of-contents__link toc-highlight">Review the pull request</a></li><li><a href="#view-the-deployed-application" class="table-of-contents__link toc-highlight">View the deployed application</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Microsoft. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>